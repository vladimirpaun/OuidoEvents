<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ouidoEvents · Dashboard Client</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #0052D4;
            --secondary-color: #4364F7;
            --accent-color: #00B4D8;
            --dark-color: #1a202c;
            --gray-color: #555555;
            --muted-color: #7a7f87;
            --light-gray-color: #f0f2f5;
            --bg-color: #f8f9fa;
            --white-color: #ffffff;
            --border-color: #e5eaf1;
            --shadow-color: rgba(67, 100, 247, 0.15);
            --border-radius: 16px;
            --sidebar-width: 296px;
            --header-height: 74px;
            --mobile-bar-height: 64px;
        }


                .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; min-height: 100vh; font-family: 'Inter', sans-serif; color: var(--dark-color); background-color: var(--bg-color); line-height: 1.5; }
        a { color: inherit; text-decoration: none; }
        button { font: inherit; }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            clip-path: inset(50%);
            white-space: nowrap;
            border: 0;
        }

        .crm-mobile-bar {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--white-color);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 16px 34px -28px rgba(15, 23, 42, 0.55);
            position: sticky;
            top: 0;
            z-index: 1000;
            min-height: var(--mobile-bar-height);
        }

        .crm-mobile-menu-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(0, 82, 212, 0.22);
            background: var(--white-color);
            color: var(--primary-color);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        .crm-mobile-menu-toggle svg {
            width: 22px;
            height: 22px;
        }

        .crm-mobile-menu-toggle[aria-expanded="true"] {
            background: rgba(0, 82, 212, 0.1);
            border-color: rgba(0, 82, 212, 0.35);
        }

        .crm-mobile-bar-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .crm-mobile-bar-title span {
            font-weight: 600;
            font-size: 1rem;
            color: var(--dark-color);
        }

        .crm-mobile-bar-title small {
            font-size: 0.78rem;
            color: var(--muted-color);
            line-height: 1.35;
        }

        .crm-sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1100;
        }

        .crm-sidebar-overlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        body.crm-sidebar-open {
            overflow: hidden;
        }

        /* --- Layout Shell --- */
        main.crm-shell { display: grid; grid-template-columns: var(--sidebar-width) 1fr; min-height: calc(100vh - var(--header-height)); background: linear-gradient(135deg, rgba(67, 100, 247, 0.06), rgba(0, 82, 212, 0.02)); }
        .crm-sidebar { position: sticky; top: var(--header-height); height: calc(100vh - var(--header-height)); background: var(--white-color); border-right: 1px solid var(--border-color); padding: 32px 26px; display: flex; flex-direction: column; gap: 28px; }
        .crm-sidebar h2 { font-size: 1.25rem; margin: 0 0 6px; }
        .crm-sidebar p { color: var(--muted-color); font-size: 0.92rem; margin: 0; }
        .crm-nav { display: flex; flex-direction: column; gap: 24px; }
        .crm-nav-section label { font-size: 0.78rem; font-weight: 600; color: var(--muted-color); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 10px; display: block; }
        .crm-nav-links { display: flex; flex-direction: column; gap: 8px; }
        .crm-nav-link { width: 100%; border: 1px solid transparent; border-radius: 14px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: var(--gray-color); font-weight: 500; background: transparent; cursor: pointer; transition: all 0.2s ease; }
        .crm-nav-link svg { width: 18px; height: 18px; opacity: 0.7; }
        .crm-nav-link:hover, .crm-nav-link.is-active { background: rgba(67, 100, 247, 0.1); border-color: rgba(0, 82, 212, 0.24); color: var(--primary-color); box-shadow: inset 0 0 0 1px rgba(0, 82, 212, 0.18); }
        .crm-sidebar-footer { margin-top: auto; background: rgba(0, 82, 212, 0.08); border-radius: 16px; padding: 18px; }
        .crm-sidebar-footer h3 { font-size: 0.96rem; margin: 0 0 4px; }
        .crm-sidebar-footer p { font-size: 0.85rem; margin-bottom: 10px; }
        .crm-sidebar-footer a { display: inline-flex; gap: 8px; align-items: center; font-weight: 600; color: var(--primary-color); font-size: 0.9rem; }

        /* --- Pages & Content --- */
        .crm-pages { padding: calc(var(--header-height) - 40px) 40px 40px; display: flex; flex-direction: column; gap: 36px; }
        .crm-page { display: none; flex-direction: column; gap: 28px; animation: fadeIn 0.24s ease; }
        .crm-page.is-active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Componente comune --- */
        .page-header { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 28px 32px; box-shadow: 0 28px 50px -48px rgba(67, 100, 247, 0.8); display: flex; flex-direction: column; gap: 18px; }
        .page-header h1 { font-size: 1.8rem; margin: 0 0 4px; }
        .page-header p { margin: 0; color: var(--muted-color); max-width: 520px; font-size: 0.95rem; }
        .crm-page[data-page="requests"] .page-header h1 { font-size: 1.45rem; }
        .crm-page[data-page="requests"] .page-header p { font-size: 0.8rem; }
        .panel { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 26px 28px; display: flex; flex-direction: column; gap: 18px; box-shadow: 0 30px 48px -52px rgba(67, 100, 247, 0.85); }
        .panel header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap; }
        .panel header h2 { margin: 0; font-size: 1.1rem; }
        .panel-meta { color: var(--muted-color); font-size: 0.82rem; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .panel-grid .panel { height: 100%; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 18px; }
        .metric-card { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 22px; display: flex; flex-direction: column; gap: 10px; }
        .metric-card span { color: var(--muted-color); font-size: 0.85rem; }
        .metric-card strong { font-size: 1.6rem; }
        .list { display: flex; flex-direction: column; gap: 12px; }
        .list-item { display: flex; justify-content: space-between; gap: 16px; border-bottom: 1px solid rgba(0, 82, 212, 0.08); padding-bottom: 12px; }
        .list-item:last-child { border-bottom: none; padding-bottom: 0; }
        /* NOU: Ajustare dimensiune font pentru textul din liste */
        .list-item > div {
            font-size: 0.9rem;
        }
        .status-chip {
            --status-chip-padding-block: 4px;
            --status-chip-padding-inline: 22px;
            --status-chip-width: 300px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: var(--status-chip-padding-block) var(--status-chip-padding-inline);
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            box-sizing: border-box;
            text-align: center;
            width: var(--status-chip-width);
            white-space: nowrap;
        }
        .crm-page[data-page="requests"] .booking-row-status .status-chip {
            --status-chip-padding-inline: 16px;
            --status-chip-width: 260px;
            justify-content: flex-start;
            text-align: left;
        }
        .status-chip[data-status="availability_request"],
        .status-chip[data-status="pending"] { background: rgba(245, 158, 11, 0.22); color: #b45309; }
        .status-chip[data-status="availability_confirmed"] { background: rgba(59, 130, 246, 0.22); color: #2563eb; }
        .status-chip[data-status="offer_requested"] { background: rgba(168, 85, 247, 0.22); color: #7c3aed; }
        .status-chip[data-status="offer_sent"] { background: rgba(139, 92, 246, 0.22); color: #6c2bd9; }
        .status-chip[data-status="viewing_request"] { background: rgba(14, 165, 233, 0.22); color: #0c7ab5; }
        .status-chip[data-status="viewing_rescheduled"] { background: rgba(56, 189, 248, 0.22); color: #0369a1; }
        .status-chip[data-status="viewing_scheduled"] { background: rgba(37, 99, 235, 0.22); color: #1d4ed8; }
        .status-chip[data-status="pre_booked"] { background: rgba(20, 184, 166, 0.22); color: #0f766e; }
        .status-chip[data-status="confirmed"] { background: rgba(21, 128, 61, 0.22); color: #166534; }
        .status-chip[data-status="viewing_completed"] { background: rgba(129, 199, 132, 0.22); color: #166534; }
        .status-chip[data-status="viewing_cancelled"] { background: rgba(239, 68, 68, 0.22); color: #b91c1c; }
        .status-chip[data-status="viewing_rejected"] { background: rgba(185, 28, 28, 0.22); color: #991b1b; }
        .status-chip[data-status="rejected"] { background: rgba(185, 28, 28, 0.22); color: #991b1b; }
        .status-chip[data-status="cancelled"] { background: rgba(239, 68, 68, 0.22); color: #b91c1c; }
        .status-chip[data-status="due"] { background: rgba(248, 113, 113, 0.22); color: #b91c1c; }
        .status-chip[data-status="upcoming"] { background: rgba(45, 212, 191, 0.22); color: #0f766e; }
        .crm-button { border-radius: 999px; padding: 10px 22px; border: 1px solid transparent; font-weight: 600; font-size: 0.95rem; cursor: pointer; }
        .crm-button.primary { background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); color: var(--white-color); }
        .crm-button.ghost { background: transparent; border-color: rgba(0, 82, 212, 0.2); color: var(--primary-color); }
        .crm-button.danger { background: linear-gradient(135deg, #f56565, #c53030); color: var(--white-color); }
        .crm-button--sm { padding: 8px 18px; font-size: 0.85rem; }

        .settings-overview { display: flex; flex-direction: column; gap: 0; padding: 20px 24px; }
        .settings-overview-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .settings-overview-copy { flex: 1 1 260px; display: flex; flex-direction: column; gap: 8px; }
        .settings-overview h1 { margin: 0; font-size: 1.55rem; }
        .settings-overview p { margin: 0; color: var(--muted-color); max-width: 620px; }
        .settings-overview-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-left: auto; }
        .settings-overview-actions .crm-button { flex: 0 0 auto; }

        .settings-section-label { font-size: 0.78rem; font-weight: 600; color: var(--muted-color); text-transform: uppercase; letter-spacing: 0.12em; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; align-items: stretch; }
        .settings-card { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 24px 26px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 30px 48px -52px rgba(67, 100, 247, 0.75); height: 100%; }
        .settings-card header { display: flex; flex-direction: column; gap: 6px; }
        .settings-card header h2 { margin: 0; font-size: 1.15rem; }
        .settings-card header .panel-meta { font-size: 0.85rem; }
        .settings-fields { display: grid; gap: 16px; }
        .settings-field { display: flex; flex-direction: column; gap: 6px; }
        .settings-field label { font-weight: 600; font-size: 0.88rem; color: var(--dark-color); }
        .settings-field input, .settings-field select { border-radius: 10px; border: 1px solid rgba(0, 82, 212, 0.16); padding: 10px 12px; font: inherit; font-size: 0.92rem; background: var(--white-color); }
        .settings-field input::placeholder { color: var(--muted-color); }
        .settings-field--static { gap: 8px; }
        .settings-static-value { border-radius: 10px; border: 1px dashed rgba(0, 82, 212, 0.25); background: rgba(67, 100, 247, 0.05); padding: 10px 12px; font-weight: 600; font-size: 0.93rem; color: var(--dark-color); }
        .settings-toggles { display: flex; flex-direction: column; gap: 14px; }
        .settings-toggle { display: flex; align-items: center; justify-content: space-between; gap: 16px; border: 1px solid rgba(0, 82, 212, 0.08); border-radius: 14px; padding: 14px 16px; background: rgba(67, 100, 247, 0.04); }
        .settings-toggle span { font-size: 0.92rem; font-weight: 500; color: var(--dark-color); }
        .settings-toggle small { display: block; font-size: 0.78rem; color: var(--muted-color); font-weight: 400; }
        .settings-toggle input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary-color); }
        .settings-card--full { grid-column: 1 / -1; }
        .settings-card-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; }
        .settings-card-actions .crm-button { flex: 0 0 auto; justify-content: center; display: inline-flex; }
        .settings-card-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .settings-card-footer .crm-button { flex: 0 0 auto; }
        .account-confirmation-modal { gap: 18px; }
        .account-confirmation-content { font-size: 0.92rem; color: var(--dark-color); line-height: 1.5; }
        .account-confirmation-footer { display: flex; justify-content: flex-end; gap: 12px; }

        @media (max-width: 768px) {
            .settings-overview { padding: 18px 20px; }
            .settings-overview-header { align-items: flex-start; }
            .settings-overview-actions { width: 100%; justify-content: flex-start; }
            .settings-grid { grid-template-columns: 1fr; }
        }

        /* --- Stiluri specifice paginii de client --- */
        .favorites-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .location-card { display: flex; flex-direction: column; background: var(--white-color); border-radius: var(--border-radius); overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .location-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px var(--shadow-color); }
        .location-image { height: 200px; background-size: cover; background-position: center; position: relative; }
        .remove-favorite-btn { position: absolute; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .remove-favorite-btn svg { width: 20px; height: 20px; fill: #ff4d4d; stroke: #ff4d4d; }
        .location-details { padding: 18px 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .location-details h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .location-details p { font-size: 0.88rem; color: var(--muted-color); margin-bottom: 15px; }
        .location-card-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .location-price { font-weight: 600; }

        .table-wrapper { width: 100%; overflow-x: auto; }
        table.crm-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 16px;
            min-width: 0;
        }
        table.crm-table thead {
            background: transparent;
        }
        table.crm-table thead th {
            padding: 12px 18px;
            text-align: left;
            font-size: 0.74rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-color);
            background: rgba(0, 82, 212, 0.06);
            border-radius: 14px;
            font-weight: 600;
        }
        table.crm-table tbody tr {
            cursor: pointer;
        }
        table.crm-table tbody td {
            padding: 0;
            border: none;
        }
        .table-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .table-actions button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid rgba(0, 82, 212, 0.2);
            background: transparent;
            color: var(--primary-color);
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        .table-actions button:hover {
            background-color: rgba(0, 82, 212, 0.08);
            border-color: rgba(0, 82, 212, 0.3);
        }
        .table-actions button:focus-visible {
            outline: none;
            border-color: rgba(0, 82, 212, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 82, 212, 0.15);
        }

        table.crm-table tbody tr {
            cursor: pointer;
        }

        @keyframes highlight-fade {
            from { box-shadow: 0 0 0 4px rgba(0, 180, 216, 0.3); }
            to { box-shadow: 0 0 0 0 rgba(0, 180, 216, 0); }
        }

        .booking-row {
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 18px 20px;
            box-shadow: 0 26px 48px -46px rgba(15, 23, 42, 0.45);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
        }

        .booking-row-top {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px 20px;
        }

        .booking-row-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .booking-row-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-color);
            font-weight: 600;
        }

        .booking-row-value {
            font-size: 0.94rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .booking-row-meta {
            font-size: 0.78rem;
            color: var(--muted-color);
        }

        .booking-row-bottom {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 14px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }

        .reschedule-response-panel {
            border: 1px solid rgba(234, 179, 8, 0.35);
            background: rgba(253, 230, 138, 0.18);
            gap: 16px;
        }

        .reschedule-response-panel header {
            align-items: flex-start;
        }

        .reschedule-heading {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .reschedule-badge {
            background: rgba(234, 179, 8, 0.18);
            color: #b45309;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .reschedule-message {
            margin: 0;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .reschedule-options {
            display: grid;
            gap: 12px;
        }

        .reschedule-option {
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--white-color);
            border: 1px solid rgba(234, 179, 8, 0.35);
            border-radius: 14px;
            padding: 12px 16px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .reschedule-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #b45309;
            flex-shrink: 0;
        }

        .reschedule-option-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .reschedule-option-main {
            font-weight: 600;
            color: var(--dark-color);
        }

        .reschedule-option-meta {
            font-size: 0.8rem;
            color: var(--muted-color);
        }

        .reschedule-option.is-selected {
            border-color: #b45309;
            box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.25);
        }

        .reschedule-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-end;
        }

        .booking-row-status {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-start;
        }

        .booking-row-next-step {
            font-size: 0.78rem;
            color: var(--muted-color);
        }

        .booking-row-actions {
            margin-left: auto;
        }

        .request-detail-header {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        @media (min-width: 768px) {
            .request-detail-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
        }
        .request-detail-header-main {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .request-detail-header-main h1 {
            margin: 0;
        }
        .request-detail-header-main p {
            margin: 0;
            color: var(--muted-color);
            max-width: 520px;
        }
        .request-detail-header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }
        .request-detail-body {
            display: flex;
            flex-direction: column;
            gap: 22px;
        }
        .request-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px 20px;
        }
        .request-detail-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .request-detail-item small {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-color);
            font-weight: 600;
        }
        .request-detail-item span {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .request-detail-offer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .request-detail-slots {
            margin-top: 6px;
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            padding-top: 12px;
            display: grid;
            gap: 8px;
        }
        .request-detail-slot {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            font-size: 0.88rem;
            color: var(--dark-color);
        }
        .request-detail-slot span:first-child {
            font-weight: 600;
            color: var(--muted-color);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.7rem;
        }
        .request-detail-contact {
            display: grid;
            gap: 6px;
            margin-top: 12px;
        }
        .request-detail-contact-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .request-detail-contact-row small {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-color);
            font-weight: 600;
        }
        .request-detail-contact a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }
        .request-detail-contact a:hover {
            text-decoration: underline;
        }
        .request-detail-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 18px;
        }
        .request-detail-empty {
            border: 1px dashed rgba(0, 82, 212, 0.2);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            color: var(--muted-color);
        }
        table.crm-table tbody tr:hover .booking-row {
            border-color: rgba(0, 82, 212, 0.45);
            box-shadow: 0 38px 64px -38px rgba(67, 100, 247, 0.55);
            background-color: rgba(0, 82, 212, 0.04);
            transform: translateY(-3px);
        }

        table.crm-table tbody tr.is-highlighted .booking-row {
            border-color: rgba(0, 82, 212, 0.55);
            box-shadow: 0 0 0 3px rgba(0, 82, 212, 0.18);
            animation: highlight-fade 1.8s ease-out forwards;
        }

        @media (max-width: 768px) {
            .booking-row-top {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .booking-row-bottom {
                flex-direction: column;
                align-items: flex-start;
            }
            .booking-row-actions {
                margin-left: 0;
                width: 100%;
            }
            .booking-row-status .status-chip {
                width: 100%;
            }
        }
        .favorites-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(26, 32, 44, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .favorites-modal-overlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .favorites-modal {
            width: min(520px, 94vw);
            max-height: 92vh;
            overflow-y: auto;
            background: #fff;
            border-radius: 18px;
            padding: 28px 32px;
            box-shadow: 0 32px 60px -40px rgba(15, 23, 42, 0.45);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .favorites-modal header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .favorites-modal header h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        .favorites-modal-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--muted-color);
        }
        .favorites-modal form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .favorites-modal .form-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #availability-date-picker {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            border: 0;
            clip: rect(0 0 0 0);
            clip-path: inset(50%);
            overflow: hidden;
            white-space: nowrap;
        }
        .availability-calendar {
            display: flex;
            justify-content: center;
        }
        .availability-calendar {
            display: flex;
            justify-content: center;
            max-width: 100%;
            overflow-x: auto;
        }
        .availability-calendar .flatpickr-calendar {
            box-shadow: 0 18px 44px -32px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: 16px;
            padding: 16px 20px;
            overflow: visible;
            min-width: 360px;
            max-width: 100%;
        }
        .availability-calendar .flatpickr-day {
            width: 46px;
            height: 42px;
            line-height: 42px;
            font-size: 0.9rem;
        }
        .favorites-modal .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        .viewing-slot-builder {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border-radius: 14px;
            border: 1px dashed rgba(0, 82, 212, 0.2);
            background: rgba(67, 100, 247, 0.04);
        }
        .viewing-slot-builder .panel-meta {
            margin: 0;
        }
        .viewing-slot-builder .reschedule-actions {
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .reschedule-help {
            font-size: 0.88rem;
            color: var(--muted-color);
            margin: 0 0 12px;
        }
        .reschedule-slot-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .reschedule-slot {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 10px;
            align-items: center;
        }
        .reschedule-slot-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
        }
        .reschedule-slot input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        .reschedule-slot select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
            background: var(--white-color);
            color: var(--dark-color);
        }
        .reschedule-slot input.is-invalid {
            border-color: #b91c1c;
            box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.12);
        }
        .reschedule-slot select.is-invalid {
            border-color: #b91c1c;
            box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.12);
        }
        .reschedule-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 14px;
        }
        .viewing-empty-state {
            border-radius: 12px;
            border: 1px dashed rgba(15, 23, 42, 0.16);
            padding: 16px;
            font-size: 0.85rem;
            color: var(--muted-color);
            text-align: center;
        }
        .favorites-modal label {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .availability-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: var(--muted-color);
            justify-content: center;
        }
        .availability-legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 4px;
            margin-right: 6px;
        }
        .availability-legend-dot--available { background: rgba(59, 130, 246, 0.18); }
        .availability-legend-dot--hold { background: rgba(245, 158, 11, 0.25); }
        .availability-legend-dot--booked { background: rgba(239, 68, 68, 0.3); }
        .favorites-modal input,
        .favorites-modal select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font-size: 0.9rem;
        }
        .flatpickr-calendar {
            background: var(--white-color);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px var(--shadow-color);
            border: 1px solid var(--border-color);
            width: auto;
        }
        .flatpickr-calendar .flatpickr-months,
        .flatpickr-calendar .flatpickr-weekdays {
            background: transparent;
            color: var(--dark-color);
        }
        .flatpickr-calendar .flatpickr-monthDropdown-months,
        .flatpickr-calendar .numInputWrapper,
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            color: var(--dark-color);
            fill: var(--dark-color);
            font-size: 0.85rem;
        }
        .flatpickr-calendar .flatpickr-months .flatpickr-prev-month svg,
        .flatpickr-calendar .flatpickr-months .flatpickr-next-month svg {
            fill: var(--dark-color);
        }
        .flatpickr-day {
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }
        .flatpickr-day:hover {
            background: var(--light-gray-color);
        }
        .flatpickr-day.today {
            border-color: var(--secondary-color);
        }
        .flatpickr-day.today:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--white-color);
        }
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected:hover,
        .flatpickr-day.startRange:hover,
        .flatpickr-day.endRange:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--white-color);
        }
        .flatpickr-day.availability-day-available:hover {
            background: rgba(59, 130, 246, 0.12);
        }
        .flatpickr-day.availability-day-hold {
            background: rgba(245, 158, 11, 0.25);
            color: #b45309;
        }
        .flatpickr-day.availability-day-booked {
            background: rgba(239, 68, 68, 0.3);
            color: #b91c1c;
        }
        .flatpickr-day.flatpickr-disabled {
            cursor: not-allowed;
        }
        .flatpickr-time {
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            padding-top: 6px;
        }
        .flatpickr-time input,
        .flatpickr-time .flatpickr-time-separator {
            color: var(--dark-color);
            font-weight: 600;
        }
        .favorites-modal footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .filter-bar { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .filter-bar label { font-weight: 600; font-size: 0.9rem; }
        .filter-bar select { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border-color); font: inherit; font-size: 0.9rem; background: var(--white-color); }
        .requests-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px 18px; margin: 12px 0 4px; }
        .requests-legend-item { display: flex; align-items: flex-start; gap: 12px; font-size: 0.85rem; color: var(--gray-color); }
        .requests-legend-item .legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
        .requests-legend-item-content { display: flex; flex-direction: column; gap: 2px; }
        .requests-legend-item-content strong { color: var(--dark-color); font-size: 0.88rem; }
        .requests-legend-item-content span { font-size: 0.78rem; color: var(--muted-color); }
        .empty-state { text-align: center; color: var(--muted-color); padding: 24px; border-radius: var(--border-radius); background: rgba(0, 82, 212, 0.04); }
        .note-card { display: flex; flex-direction: column; gap: 6px; border-bottom: 1px solid rgba(0, 82, 212, 0.08); padding-bottom: 14px; }
        .note-card:last-child { border-bottom: none; padding-bottom: 0; }
        .next-step-cell { display: flex; flex-direction: column; gap: 4px; }
        .next-step-cell strong { font-size: 0.9rem; color: var(--dark-color); }
        .next-step-cell span { font-size: 0.78rem; color: var(--muted-color); }

        /* NOU: Stil pentru elementele interactive din liste */
        .list-item.is-interactive {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item.is-interactive:hover { background-color: rgba(0, 82, 212, 0.04); }

        .message-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.18);
            color: #b45309;
        }

        /* Responsive */
        @media (max-width: 1180px) {
            main.crm-shell { grid-template-columns: 1fr; }
            .crm-sidebar { position: relative; top: 0; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); }
            .crm-pages { padding: 36px 24px 48px; }
        }
        @media (max-width: 1024px) {
            .crm-sidebar { padding: 24px 20px; }
            .crm-pages { padding: 32px 20px 44px; }
            .page-header { padding: 24px 20px; }
            .panel { padding: 24px 20px; }
        }
        @media (max-width: 900px) {
            .crm-mobile-bar { display: flex; }
            main.crm-shell { grid-template-columns: 1fr; min-height: auto; }
            .crm-sidebar {
                position: fixed;
                top: var(--mobile-bar-height);
                left: 0;
                height: calc(100vh - var(--mobile-bar-height));
                width: min(320px, 88vw);
                border: none;
                border-radius: 0 20px 20px 0;
                box-shadow: 0 26px 60px -30px rgba(15, 23, 42, 0.6);
                padding: 24px 20px 28px;
                transform: translateX(-105%);
                transition: transform 0.25s ease;
                z-index: 1200;
                overflow-y: auto;
                background: var(--white-color);
            }
            .crm-sidebar.is-open { transform: translateX(0); }
            .crm-sidebar h2 { font-size: 1.12rem; }
            .crm-sidebar p { font-size: 0.82rem; }
            .crm-nav { gap: 18px; }
            .crm-nav-links { flex-direction: column; gap: 10px; padding: 0; margin: 0; overflow: visible; }
            .crm-nav-link { width: 100%; min-width: 0; padding: 12px 14px; }
            .crm-sidebar-footer { margin-top: 24px; }
            .crm-pages { padding: 26px 18px 36px; }
        }
        @media (max-width: 720px) {
            .crm-sidebar { width: min(300px, 86vw); padding: 20px 16px 24px; }
            .crm-sidebar-footer { display: none; }
            .crm-pages { padding: 24px 16px 32px; gap: 24px; }
            .page-header { padding: 20px 16px; gap: 12px; }
            .page-header h1 { font-size: 1.4rem; }
            .page-header p { font-size: 0.82rem; max-width: none; }
            .panel { padding: 20px 16px; gap: 14px; }
            .panel header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .panel header h2 { font-size: 1.02rem; }
            .panel-meta { font-size: 0.76rem; }
            .filter-bar { flex-direction: column; align-items: stretch; gap: 10px; }
            .filter-bar label { font-size: 0.8rem; }
            .filter-bar select { width: 100%; }
            .table-wrapper { margin: 0 -16px; padding: 0 16px; }
            .table-actions { width: 100%; justify-content: flex-start; }
            .booking-row { padding: 16px 14px; }
            .booking-row-top { grid-template-columns: 1fr; gap: 10px; }
            .booking-row-bottom { flex-direction: column; align-items: flex-start; gap: 12px; }
            .reschedule-response-panel header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .reschedule-actions { flex-direction: column; align-items: stretch; gap: 10px; }
            .reschedule-actions .crm-button { width: 100%; }
            .reschedule-option { align-items: flex-start; }
            .favorites-grid { grid-template-columns: 1fr; }
            .location-card-footer { flex-direction: column; align-items: flex-start; gap: 12px; }
            .settings-overview { padding: 18px 16px; }
            .settings-overview-header { flex-direction: column; align-items: flex-start; }
            .settings-overview-actions { width: 100%; justify-content: flex-start; gap: 10px; }
            .settings-overview-actions .crm-button { flex: 1 1 auto; width: 100%; justify-content: center; }
            .panel-grid, .metrics-grid, .requests-legend { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            body { font-size: 0.94rem; line-height: 1.45; }
            .crm-mobile-bar { padding: 10px 14px; gap: 10px; }
            .crm-mobile-menu-toggle { width: 40px; height: 40px; }
            .crm-mobile-bar-title span { font-size: 0.95rem; }
            .crm-mobile-bar-title small { font-size: 0.74rem; }
            .crm-pages { gap: 20px; }
            .page-header h1 { font-size: 1.32rem; }
            .page-header p { font-size: 0.8rem; }
            .panel { padding: 18px 14px; }
            .panel header h2 { font-size: 0.98rem; }
            .metric-card { padding: 18px; }
            .metric-card span { font-size: 0.78rem; }
            .metric-card strong { font-size: 1.35rem; }
            .crm-button { padding: 9px 18px; font-size: 0.88rem; }
            .list-item > div { font-size: 0.85rem; }
            .status-chip {
                --status-chip-padding-inline: 16px;
                --status-chip-width: 100%;
                font-size: 0.74rem;
            }
        }
        @media (max-width: 480px) {
            .crm-sidebar { width: min(280px, 84vw); padding: 18px 14px 22px; }
            .crm-pages { padding: 22px 12px 30px; }
            .page-header h1 { font-size: 1.26rem; }
            .booking-row { padding: 14px 12px; gap: 10px; }
            .filter-bar label { font-size: 0.76rem; }
            .location-image { height: 160px; }
            .crm-mobile-bar { padding: 10px 12px; }
        }
        @media (max-width: 360px) {
            .crm-mobile-bar-title span { font-size: 0.9rem; }
            .crm-mobile-bar-title small { font-size: 0.7rem; }
            .crm-button { padding: 8px 16px; font-size: 0.84rem; }
        }
    </style>
</head>
<body>
    <div data-include="header.html"></div>
    <div data-include="mobile-menu.html"></div>

    <header class="crm-mobile-bar">
        <button class="crm-mobile-menu-toggle" type="button" aria-expanded="false" aria-controls="crm-sidebar" aria-label="Deschide meniul">
            <span class="sr-only">Meniu principal</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="6" x2="21" y2="6" />
                <line x1="3" y1="12" x2="21" y2="12" />
                <line x1="3" y1="18" x2="21" y2="18" />
            </svg>
        </button>
        <div class="crm-mobile-bar-title">
            <span>Contul meu</span>
            <small>Bun venit, Alex! Gestionează-ți cererile și locațiile favorite.</small>
        </div>
    </header>
    <div class="crm-sidebar-overlay" data-sidebar-overlay></div>

    <main class="crm-shell">
        <aside class="crm-sidebar" id="crm-sidebar">
            <div>
                <h2>Contul meu</h2>
                <p>Bun venit, Alex! Gestionează-ți cererile și locațiile favorite.</p>
            </div>

            <nav class="crm-nav" aria-label="Navigare cont client">
                <div class="crm-nav-section">
                    <div class="crm-nav-links">
                        <button class="crm-nav-link is-active" type="button" data-page-target="overview">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2 7-7 7 7 2 2"/><path d="M5 10v10a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V10"/></svg>
                            Dashboard
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="favorites">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            Locații Favorite
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="requests">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H9a2 2 0 0 1-2-2V7"/><path d="M9 17h10"/><path d="M13 11h6"/><path d="M5 3h14a2 2 0 0 1 2 2v12"/><polyline points="5 7 5 21 19 21"/></svg>
                            Cererile mele
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="viewings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 3H6a2 2 0 0 0-2 2v14l4-4h10a2 2 0 0 0 2-2z"/></svg>
                            Vizionările mele
                        </button>
                    </div>
                </div>
                <div class="crm-nav-section">
                    <label>Comunicare & control</label>
                    <div class="crm-nav-links">
                        <button class="crm-nav-link" type="button" data-page-target="settings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                            Setări
                        </button>
                    </div>
                </div>
            </nav>

            <div class="crm-sidebar-footer">
                <h3>Ai nevoie de ajutor?</h3>
                <p>Echipa noastră de suport este aici pentru a te ghida.</p>
                <a href="contact.html">Contactează-ne</a>
            </div>
        </aside>

        <section class="crm-pages">
            <!-- Pagina Overview -->
            <section class="crm-page is-active" data-page="overview">
                <div class="page-header">
                    <h1>Dashboard Client</h1>
                    <p>Vezi rapid statusul cererilor tale, locațiile favorite și ofertele primite de la proprietari.</p>
                </div>
                <div class="metrics-grid">
                    <article class="metric-card">
                        <span>Locații favorite</span>
                        <strong id="overview-favorites-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Cereri active</span>
                        <strong id="overview-requests-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Oferte primite</span>
                        <strong id="overview-offers-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Vizionări programate</span>
                        <strong id="overview-viewings-count">0</strong>
                    </article>
                </div>
                <div class="panel-grid">
                    <article class="panel">
                        <header><h2>Activitate recentă</h2></header>
                        <div class="list" id="overview-recent-activity"></div>
                    </article>
                </div>
                <article class="panel">
                    <header>
                        <h2>Vizionări confirmate</h2>
                        <span class="panel-meta">Programările pentru următoarele 14 zile</span>
                    </header>
                    <div class="list" id="overview-viewings-list"></div>
                </article>
            </section>

            <!-- Pagina Favorite -->
            <section class="crm-page" data-page="favorites">
                <div class="page-header">
                    <h1>Locațiile Tale Favorite</h1>
                    <p>Aici găsești toate locațiile pe care le-ai salvat. Compară-le și trimite cereri de disponibilitate.</p>
                </div>
                <div class="favorites-grid" id="favorites-grid">
                    <!-- Cardurile cu locații favorite vor fi generate aici -->
                </div>
            </section>

            <!-- Pagina Setări -->
            <section class="crm-page" data-page="settings">
                <article class="panel settings-overview">
                    <header class="settings-overview-header">
                        <div class="settings-overview-copy">
                            <h1>Setări și preferințe</h1>
                            <p>Actualizează informațiile de contact și personalizează notificările pentru a rămâne conectat cu echipa OuidoEvents.</p>
                        </div>
                        <div class="settings-overview-actions">
                            <button class="crm-button ghost" type="button">Resetează</button>
                            <button class="crm-button primary" type="button">Salvează modificări</button>
                        </div>
                    </header>
                </article>

                <span class="settings-section-label">Comunicare & control</span>
                <div class="settings-grid">
                    <section class="settings-card">
                        <header>
                            <h2>Detalii cont</h2>
                            <span class="panel-meta">Actualizează informațiile personale</span>
                        </header>
                        <div class="settings-fields">
                            <div class="settings-field settings-field--static">
                                <label for="settings-email">Adresă email</label>
                                <p id="settings-email" class="settings-static-value">alex.popescu@email.com</p>
                            </div>
                            <div class="settings-field">
                                <label for="settings-first-name">Prenume</label>
                                <input type="text" id="settings-first-name" name="first_name" placeholder="Alex">
                            </div>
                            <div class="settings-field">
                                <label for="settings-last-name">Nume</label>
                                <input type="text" id="settings-last-name" name="last_name" placeholder="Popescu">
                            </div>
                            <div class="settings-field">
                                <label for="settings-phone">Număr de telefon</label>
                                <input type="tel" id="settings-phone" name="phone" placeholder="07xx xxx xxx">
                            </div>
                            <div class="settings-field">
                                <label for="settings-gender">Gen <span class="panel-meta">(opțional)</span></label>
                                <select id="settings-gender" name="gender">
                                    <option value="">Selectează</option>
                                    <option value="feminin">Feminin</option>
                                    <option value="masculin">Masculin</option>
                                    <option value="altul">Altul</option>
                                    <option value="nu_spun">Prefer să nu spun</option>
                                </select>
                            </div>
                            <div class="settings-field">
                                <label for="settings-age">Vârstă <span class="panel-meta">(opțional)</span></label>
                                <input type="number" id="settings-age" name="age" min="18" max="120" placeholder="34">
                            </div>
                            <div class="settings-field">
                                <label for="settings-city">Oraș <span class="panel-meta">(opțional)</span></label>
                                <input type="text" id="settings-city" name="city" placeholder="București">
                            </div>
                        </div>
                        <div class="settings-card-footer">
                            <button class="crm-button primary" type="button">Salvează</button>
                        </div>
                    </section>

                    <section class="settings-card">
                        <header>
                            <h2>Notificări</h2>
                            <span class="panel-meta">Primește update-urile relevante</span>
                        </header>
                        <div class="settings-toggles">
                            <label class="settings-toggle" for="notif-viewings">
                                <span>
                                    Confirmări vizionări prin email
                                    <small>Te anunțăm imediat ce o locație confirmă sau repropune vizionarea.</small>
                                </span>
                                <input type="checkbox" id="notif-viewings" checked>
                            </label>
                            <label class="settings-toggle" for="notif-bookings">
                                <span>
                                    Confirmări booking prin email
                                    <small>Primești detalii despre rezervările aprobate și pașii următori.</small>
                                </span>
                                <input type="checkbox" id="notif-bookings" checked>
                            </label>
                        </div>
                        <div class="settings-card-footer">
                            <button class="crm-button primary" type="button">Salvează</button>
                        </div>
                    </section>

                    <section class="settings-card settings-card--full">
                        <header>
                            <h2>Administrare cont</h2>
                            <span class="panel-meta">Controlează vizibilitatea și statusul contului tău</span>
                        </header>
                        <p class="panel-meta">Poți pune pauză contului pentru a opri temporar notificările sau îl poți șterge definitiv împreună cu toate datele asociate.</p>
                        <div class="settings-card-actions">
                            <button class="crm-button ghost crm-button--sm" type="button" data-confirm-target="pause-account">Pauză cont</button>
                            <button class="crm-button danger crm-button--sm" type="button" data-confirm-target="delete-account">Șterge contul</button>
                        </div>
                    </section>
                </div>
            </section>

            <!-- Pagina Cererile Mele -->
            <section class="crm-page" data-page="requests">
                <div class="page-header">
                    <h1>Cererile Mele de Disponibilitate</h1>
                    <p>Urmărește statusul tuturor cererilor trimise către locații.</p>
                </div>
                <article class="panel">
                    <header>
                        <h2>Filtrează cererile</h2>
                        <span class="panel-meta">Alege statusul sau locația pentru a găsi rapid o cerere</span>
                    </header>
                    <div class="filter-bar">
                        <label for="requests-status-filter">Status:</label>
                        <select id="requests-status-filter"></select>
                        <label for="requests-location-filter">Locație:</label>
                        <select id="requests-location-filter"></select>
                        <label for="requests-sort">Sortare:</label>
                        <select id="requests-sort">
                            <option value="event-date">Dată eveniment</option>
                            <option value="status-asc">Status A-Z</option>
                            <option value="status-desc">Status Z-A</option>
                        </select>
                    </div>
                    <div class="requests-legend" id="requests-status-legend"></div>
                    <div class="table-wrapper">
                        <table class="crm-table">
                            <thead>
                                <tr>
                                    <th>Cerere · Status & acțiuni</th>
                                </tr>
                            </thead>
                            <tbody id="requests-table-body"></tbody>
                        </table>
                    </div>
                </article>
            </section>

            <section class="crm-page request-detail" data-page="request-detail" id="request-detail">
                <div class="page-header request-detail-header">
                    <div class="request-detail-header-main">
                        <h1 id="request-detail-title">Detalii cerere</h1>
                        <p id="request-detail-subtitle">Aici vezi statusul complet, oferta și detaliile locației pentru cererea selectată.</p>
                    </div>
                    <div class="request-detail-header-actions">
                        <a class="crm-button ghost crm-button--sm" id="request-detail-venue-link" href="venue-details.html" target="_blank" rel="noopener">Vezi pagina locației</a>
                    </div>
                </div>

                <div class="request-detail-body" id="request-detail-body" hidden>
                    <article class="panel">
                        <header>
                            <h2>Status cerere</h2>
                            <span class="panel-meta" id="request-detail-next-step">Următorul pas va fi afișat aici.</span>
                        </header>
                        <span class="status-chip" data-status="draft" id="request-detail-status-chip">Status necunoscut</span>
                        <p class="panel-meta" id="request-detail-status-description"></p>
                        <div class="request-detail-grid" id="request-detail-overview"></div>
                        <div class="request-detail-slots" id="request-detail-slots" hidden></div>
                    </article>

                    <article class="panel" id="request-detail-offer-card" hidden>
                        <header>
                            <h2>Ofertă și rezervare</h2>
                            <span class="panel-meta">Vezi termenele limită și statusul ofertei</span>
                        </header>
                        <div class="request-detail-grid" id="request-detail-offer-grid"></div>
                        <div class="request-detail-offer-actions" id="request-detail-offer-actions" hidden>
                            <a class="crm-button primary crm-button--sm" id="request-detail-offer-download" href="#" download>Descarcă oferta (PDF)</a>
                        </div>
                    </article>

                    <article class="panel">
                        <header>
                            <h2>Detalii locație</h2>
                            <span class="panel-meta">Adresă și date de contact</span>
                        </header>
                        <div class="request-detail-grid" id="request-detail-location-grid"></div>
                        <div class="request-detail-contact" id="request-detail-contact" hidden></div>
                        
                    </article>

                    <div class="request-detail-footer" id="request-detail-footer" hidden>
                        <button class="crm-button ghost crm-button--sm" type="button" id="request-detail-back">Înapoi la cereri</button>
                    </div>

                </div>

                <div class="request-detail-empty" id="request-detail-empty">
                    Selectează o cerere din listă pentru a vedea detaliile.
                </div>
            </section>

            <section class="crm-page" data-page="viewings">
                <div class="page-header">
                    <h1>Vizionările Mele</h1>
                    <p>Confirmă prezența, cere reprogramări și urmărește notițele trimise de proprietari.</p>
                </div>
                <div class="panel reschedule-response-panel" data-reschedule-panel hidden>
                    <header>
                        <div class="reschedule-heading">
                            <h2>Confirmă intervalul propus</h2>
                            <span class="panel-meta" data-reschedule-location>Locație</span>
                        </div>
                        <span class="reschedule-badge" data-reschedule-updated>Actualizat acum</span>
                    </header>
                    <p class="reschedule-message" data-reschedule-message>
                        Proprietarul îți propune noi intervale pentru vizionare. Alege varianta preferată sau cere o altă propunere.
                    </p>
                    <div class="reschedule-options" data-reschedule-options></div>
                    <div class="reschedule-actions">
                        <button class="crm-button primary" type="button" data-reschedule-accept disabled>Confirmă intervalul selectat</button>
                        <button class="crm-button ghost" type="button" data-reschedule-decline>Propune altă dată</button>
                    </div>
                </div>
                <article class="panel">
                    <header>
                        <h2>Programări viitoare</h2>
                        <span class="panel-meta">Calendar pentru următoarele 30 de zile</span>
                    </header>
                    <div class="filter-bar">
                        <label for="viewings-venue-filter">Locație:</label>
                        <select id="viewings-venue-filter"></select>
                        <label for="viewings-status-filter">Status:</label>
                        <select id="viewings-status-filter"></select>
                        <label for="viewings-sort">Sortare:</label>
                        <select id="viewings-sort">
                            <option value="primary-date">Dată apropiată</option>
                            <option value="status-asc">Status A-Z</option>
                            <option value="status-desc">Status Z-A</option>
                        </select>
                    </div>
                    <div class="table-wrapper">
                        <table class="crm-table">
                            <thead>
                                <tr>
                                    <th>Vizionare · Status & acțiuni</th>
                                </tr>
                            </thead>
                            <tbody id="viewings-table-body"></tbody>
                        </table>
                    </div>
                </article>
            </section>

        </section>
    </main>

    <div class="favorites-modal-overlay" id="availability-modal">
        <div class="favorites-modal" role="dialog" aria-modal="true" aria-labelledby="availability-modal-title">
            <header>
                <div>
                    <h3 id="availability-modal-title">Cere disponibilitatea</h3>
                    <p id="availability-modal-subtitle" class="panel-meta">Selectează data dorită și detaliile evenimentului.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="availability-modal-close" aria-label="Închide">×</button>
            </header>
            <form id="availability-form">
                <div class="form-section">
                    <input type="hidden" id="availability-date-picker">
                    <div id="availability-calendar" class="availability-calendar"></div>
                    <div class="availability-legend">
                        <span><span class="availability-legend-dot availability-legend-dot--available"></span>Disponibil</span>
                        <span><span class="availability-legend-dot availability-legend-dot--hold"></span>Pre-rezervat</span>
                        <span><span class="availability-legend-dot availability-legend-dot--booked"></span>Ocupat</span>
                    </div>
                </div>
                <p class="panel-meta" id="availability-selected-date">Selectează o dată disponibilă din calendar.</p>
                <div class="form-row">
                    <div>
                        <label for="availability-event-type">Tip eveniment</label>
                        <select id="availability-event-type" required></select>
                    </div>
                    <div>
                        <label for="availability-guests">Număr invitați</label>
                        <input type="number" id="availability-guests" min="10" max="600" required>
                    </div>
                </div>
                <footer>
                    <button type="button" class="crm-button ghost" id="availability-cancel-btn">Renunță</button>
                    <button type="submit" class="crm-button primary">Trimite cererea</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="favorites-modal-overlay" id="viewing-modal">
        <div class="favorites-modal" role="dialog" aria-modal="true" aria-labelledby="viewing-modal-title">
            <header>
                <div>
                    <h3 id="viewing-modal-title">Programează o vizionare</h3>
                    <p id="viewing-modal-subtitle" class="panel-meta">Selectează data și ora preferată pentru vizionarea locației.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="viewing-modal-close" aria-label="Închide">×</button>
            </header>
            <form id="viewing-form">
                <div class="viewing-slot-builder">
                    <p class="reschedule-help" data-viewing-slot-hint>Selectează până la 4 intervale (dată și oră) pentru vizionare. Intervalele sunt din 30 în 30 de minute.</p>
                    <div class="reschedule-slot-list" data-viewing-suggestions></div>
                    <div class="reschedule-actions">
                        <button type="button" class="crm-button ghost sm" id="viewing-add-slot" data-viewing-add-slot>Adaugă interval</button>
                        <span class="panel-meta" id="viewing-slot-counter" hidden></span>
                    </div>
                </div>
                <div class="viewing-empty-state" data-viewing-empty-state hidden>Încă nu ai intervale salvate. Folosește butonul „Adaugă interval” pentru a propune variantă de vizită.</div>
                <p class="panel-meta" id="viewing-selected-date">Lista de intervale va fi trimisă către locație. Alege cel puțin o variantă înainte de a continua.</p>
                <footer>
                    <button type="button" class="crm-button ghost" id="viewing-cancel-btn">Renunță</button>
                    <button type="submit" class="crm-button primary">Trimite solicitarea</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="favorites-modal-overlay" id="account-confirmation-overlay">
        <div class="favorites-modal account-confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="account-confirmation-title">
            <header>
                <div>
                    <h3 id="account-confirmation-title">Confirmă acțiunea</h3>
                    <p id="account-confirmation-description" class="panel-meta">Asigură-te că dorești să continui.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="account-confirmation-close" aria-label="Închide">×</button>
            </header>
            <div class="account-confirmation-content">
                <p id="account-confirmation-message">Ești pe cale să aplici o schimbare importantă asupra contului tău.</p>
            </div>
            <footer class="account-confirmation-footer">
                <button type="button" class="crm-button ghost crm-button--sm" id="account-confirmation-cancel">Renunță</button>
                <button type="button" class="crm-button crm-button--sm" id="account-confirmation-confirm">Confirmă acțiunea</button>
            </footer>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ro.js"></script>
    <script src="main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.crm-nav-link');
        const pages = document.querySelectorAll('.crm-page');
        const storageKey = 'client-dashboard-active-page';
        const sidebar = document.querySelector('.crm-sidebar');
        const sidebarOverlay = document.querySelector('[data-sidebar-overlay]');
        const mobileToggle = document.querySelector('.crm-mobile-menu-toggle');
        const mobileQuery = window.matchMedia('(max-width: 900px)');

        const setToggleState = (isOpen) => {
            if (!mobileToggle) {
                return;
            }
            mobileToggle.setAttribute('aria-expanded', String(isOpen));
            mobileToggle.setAttribute('aria-label', isOpen ? 'Închide meniul' : 'Deschide meniul');
        };

        const closeSidebar = ({ restoreFocus = false } = {}) => {
            if (!sidebar) {
                return;
            }
            sidebar.classList.remove('is-open');
            document.body.classList.remove('crm-sidebar-open');
            sidebarOverlay?.classList.remove('is-visible');
            setToggleState(false);
            if (restoreFocus && mobileToggle) {
                mobileToggle.focus();
            }
        };

        const openSidebar = () => {
            if (!sidebar) {
                return;
            }
            sidebar.classList.add('is-open');
            document.body.classList.add('crm-sidebar-open');
            sidebarOverlay?.classList.add('is-visible');
            setToggleState(true);
        };

        const toggleSidebar = () => {
            if (!mobileQuery.matches) {
                return;
            }
            if (sidebar?.classList.contains('is-open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        };

        setToggleState(false);

        mobileToggle?.addEventListener('click', toggleSidebar);
        sidebarOverlay?.addEventListener('click', () => closeSidebar({ restoreFocus: true }));
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && sidebar?.classList.contains('is-open')) {
                closeSidebar({ restoreFocus: true });
            }
        });

        const handleViewportChange = () => {
            closeSidebar();
        };

        handleViewportChange();
        if (typeof mobileQuery.addEventListener === 'function') {
            mobileQuery.addEventListener('change', handleViewportChange);
        } else if (typeof mobileQuery.addListener === 'function') {
            mobileQuery.addListener(handleViewportChange);
        }

        function activatePage(pageId) {
            if (!pageId) {
                return;
            }
            pages.forEach(page => page.classList.toggle('is-active', page.dataset.page === pageId));
            navLinks.forEach(link => link.classList.toggle('is-active', link.dataset.pageTarget === pageId));
            if (pageId !== 'request-detail') {
                localStorage.setItem(storageKey, pageId);
            }
            history.replaceState(null, '', `#${pageId}`);
            if (mobileQuery.matches) {
                closeSidebar();
            }
        }

        const initialHash = window.location.hash.replace('#', '');
        const storedPage = localStorage.getItem(storageKey);
        activatePage(initialHash || storedPage || 'overview');

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                activatePage(link.dataset.pageTarget);
            });
        });

        window.addEventListener('hashchange', () => activatePage(window.location.hash.replace('#', '')));

        const accountConfirmationOverlay = document.getElementById('account-confirmation-overlay');
        const accountConfirmationModal = accountConfirmationOverlay?.querySelector('.account-confirmation-modal');
        const accountConfirmationTitle = document.getElementById('account-confirmation-title');
        const accountConfirmationDescription = document.getElementById('account-confirmation-description');
        const accountConfirmationMessage = document.getElementById('account-confirmation-message');
        const accountConfirmationCloseBtn = document.getElementById('account-confirmation-close');
        const accountConfirmationCancelBtn = document.getElementById('account-confirmation-cancel');
        const accountConfirmationConfirmBtn = document.getElementById('account-confirmation-confirm');
        const accountActionButtons = document.querySelectorAll('[data-confirm-target]');
        const accountConfirmationConfigs = {
            'pause-account': {
                title: 'Pui contul pe pauză?',
                description: 'Notificările și invitațiile vor fi suspendate temporar.',
                message: 'Poți reveni oricând prin reactivarea contului din această secțiune. Continuăm?',
                confirmLabel: 'Confirmă pauza',
                confirmVariant: 'ghost'
            },
            'delete-account': {
                title: 'Ștergi definitiv contul?',
                description: 'Această acțiune este ireversibilă.',
                message: 'Toate locațiile favorite, solicitările și datele asociate vor fi eliminate. Confirmă dacă dorești să continui.',
                confirmLabel: 'Șterge contul',
                confirmVariant: 'danger'
            }
        };
        const accountConfirmationState = {
            action: null
        };

        function applyConfirmVariant(variant) {
            if (!accountConfirmationConfirmBtn) {
                return;
            }
            const baseClasses = ['crm-button', 'crm-button--sm'];
            accountConfirmationConfirmBtn.className = baseClasses.join(' ');
            if (variant === 'primary' || variant === 'danger' || variant === 'ghost') {
                accountConfirmationConfirmBtn.classList.add(variant);
            } else if (variant) {
                accountConfirmationConfirmBtn.classList.add(variant);
            }
        }

        function openAccountConfirmation(action) {
            if (!accountConfirmationOverlay || !accountConfirmationModal) {
                return;
            }
            const config = accountConfirmationConfigs[action] || accountConfirmationConfigs['pause-account'];
            accountConfirmationState.action = action;

            if (accountConfirmationTitle) {
                accountConfirmationTitle.textContent = config.title;
            }
            if (accountConfirmationDescription) {
                accountConfirmationDescription.textContent = config.description;
            }
            if (accountConfirmationMessage) {
                accountConfirmationMessage.textContent = config.message;
            }
            if (accountConfirmationConfirmBtn) {
                accountConfirmationConfirmBtn.textContent = config.confirmLabel;
            }
            applyConfirmVariant(config.confirmVariant || 'primary');

            accountConfirmationOverlay.classList.add('is-visible');
            const focusableButtons = accountConfirmationModal.querySelectorAll('button:not([disabled])');
            if (focusableButtons.length) {
                focusableButtons[focusableButtons.length - 1].focus();
            }
        }

        function closeAccountConfirmation() {
            if (!accountConfirmationOverlay) {
                return;
            }
            accountConfirmationOverlay.classList.remove('is-visible');
            accountConfirmationState.action = null;
        }

        accountActionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const action = button.dataset.confirmTarget;
                openAccountConfirmation(action);
            });
        });

        accountConfirmationCloseBtn?.addEventListener('click', closeAccountConfirmation);
        accountConfirmationCancelBtn?.addEventListener('click', closeAccountConfirmation);
        accountConfirmationOverlay?.addEventListener('click', (event) => {
            if (event.target === accountConfirmationOverlay) {
                closeAccountConfirmation();
            }
        });

        accountConfirmationConfirmBtn?.addEventListener('click', () => {
            const action = accountConfirmationState.action;
            closeAccountConfirmation();
            if (action === 'pause-account') {
                console.info('Contul a fost setat pe pauză (simulare).');
            } else if (action === 'delete-account') {
                console.warn('Contul a fost marcat pentru ștergere (simulare).');
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && accountConfirmationOverlay?.classList.contains('is-visible')) {
                closeAccountConfirmation();
            }
        });

        const today = new Date();
        const addDays = (days) => {
            const d = new Date(today);
            d.setDate(d.getDate() + days);
            return d;
        };
        const monthNames = ['ian', 'feb', 'mar', 'apr', 'mai', 'iun', 'iul', 'aug', 'sep', 'oct', 'noi', 'dec'];
        const formatDate = (date) => `${String(date.getDate()).padStart(2, '0')} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        const formatDateTime = (date) => `${formatDate(date)} · ${formatTime(date)}`;
        const normalizeSlotDate = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return null;
            }
            const normalized = new Date(date.getTime());
            normalized.setSeconds(0, 0);
            return normalized;
        };
        const createSlotObject = (date) => {
            const normalized = normalizeSlotDate(date);
            if (!normalized) {
                return null;
            }
            return {
                date: normalized,
                iso: normalized.toISOString(),
                label: formatDateTime(normalized)
            };
        };
        const mapSlots = (slots) => {
            if (!Array.isArray(slots)) {
                return [];
            }
            return slots
                .map(slot => {
                    if (slot instanceof Date) {
                        return createSlotObject(slot);
                    }
                    if (slot?.date instanceof Date) {
                        return createSlotObject(slot.date);
                    }
                    if (typeof slot?.iso === 'string') {
                        const parsed = new Date(slot.iso);
                        return createSlotObject(parsed);
                    }
                    return null;
                })
                .filter(Boolean);
        };
        const getViewingPrimarySlot = (view) => {
            if (!view) {
                return null;
            }
            const confirmed = mapSlots([view.confirmedSlot])[0];
            if (confirmed) {
                return confirmed;
            }
            const ownerSuggestion = mapSlots(view.ownerSuggestions)[0];
            if (ownerSuggestion) {
                return ownerSuggestion;
            }
            const requested = mapSlots(view.requestedSlots)[0];
            if (requested) {
                return requested;
            }
            if (view.date instanceof Date && !Number.isNaN(view.date.getTime())) {
                return createSlotObject(view.date);
            }
            if (typeof view.hour === 'string' && view.hour.includes(':') && view.lastUpdate instanceof Date) {
                const candidate = new Date(view.lastUpdate.getTime());
                const [hours, minutes] = view.hour.split(':').map(Number);
                candidate.setHours(Number.isFinite(hours) ? hours : 12, Number.isFinite(minutes) ? minutes : 0, 0, 0);
                return createSlotObject(candidate);
            }
            return null;
        };
        const findRequestByViewingId = (viewingId) => clientRequests.find(req => req.viewingId === viewingId);
        const formatRelativeTime = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '';
            }
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.round(diffMs / 60000);
            if (diffMinutes < 1) {
                return 'acum câteva secunde';
            }
            if (diffMinutes < 60) {
                return `acum ${diffMinutes} min`;
            }
            const diffHours = Math.round(diffMinutes / 60);
            if (diffHours < 24) {
                return `acum ${diffHours}h`;
            }
            const diffDays = Math.round(diffHours / 24);
            if (diffDays === 1) {
                return 'ieri';
            }
            if (diffDays < 7) {
                return `acum ${diffDays} zile`;
            }
            return formatDate(date);
        };
        const formatPricePerPerson = (value) => {
            if (!Number.isFinite(value) || value <= 0) {
                return '—';
            }
            const rounded = Math.round(value);
            return `de la ${rounded}€/persoană`;
        };
        const locations = [
            {
                id: 1,
                name: 'The Grand Ballroom',
                city: 'București',
                price: 120,
                address: 'Bulevardul Libertății 12, București',
                contactPhone: '+40 723 555 111',
                contactEmail: 'grandballroom@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?w=400'
            },
            {
                id: 2,
                name: 'Forest Retreat & Spa',
                city: 'Brașov',
                price: 95,
                address: 'Str. Valea Largă 8, Poiana Brașov',
                contactPhone: '+40 734 889 220',
                contactEmail: 'forest.retreat@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1582719508461-905c673771fd?w=400'
            },
            {
                id: 3,
                name: 'Cluj SkyView',
                city: 'Cluj-Napoca',
                price: 110,
                address: 'Str. Regele Ferdinand 5, Cluj-Napoca',
                contactPhone: '+40 723 990 112',
                contactEmail: 'skyview@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1590073242678-70ee3fc2f8b2?w=400'
            },
            {
                id: 4,
                name: 'Casa Miraval',
                city: 'Cluj-Napoca',
                price: 130,
                address: 'Str. Republicii 40, Cluj-Napoca',
                contactPhone: '+40 722 556 770',
                contactEmail: 'miraval@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=400'
            },
            {
                id: 5,
                name: 'Heritage Gardens',
                city: 'Oradea',
                price: 105,
                address: 'Str. Eftimie Murgu 18, Oradea',
                contactPhone: '+40 724 334 901',
                contactEmail: 'heritage.gardens@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1529429617124-aee711a52795?w=400'
            },
            {
                id: 6,
                name: 'Urban Art Loft',
                city: 'Timișoara',
                price: 115,
                address: 'Splaiul Nicolae Titulescu 2, Timișoara',
                contactPhone: '+40 732 660 845',
                contactEmail: 'urban.loft@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1484154218962-a197022b5858?w=400'
            },
            {
                id: 7,
                name: 'Ambiance Lake',
                city: 'Snagov',
                price: 150,
                address: 'Str. Lacului 22, Snagov',
                contactPhone: '+40 733 889 501',
                contactEmail: 'ambiance.lake@ouido.com',
                imageUrl: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400'
            }
        ];

        const defaultFavoriteIds = [2, 3, 5, 7];
        let storedFavorites = [];
        try {
            const rawFavorites = localStorage.getItem('favoriteIds');
            storedFavorites = rawFavorites ? JSON.parse(rawFavorites) : [];
        } catch (error) {
            storedFavorites = [];
        }
        let favoriteIds = Array.isArray(storedFavorites) && storedFavorites.length ? storedFavorites : defaultFavoriteIds.slice();
        if (!Array.isArray(storedFavorites) || storedFavorites.length === 0) {
            localStorage.setItem('favoriteIds', JSON.stringify(favoriteIds));
        }

        const requestStatusMeta = {
            availability_request: {
                label: 'Cerere disponibilitate trimisă',
                description: 'Locația a primit cererea ta și verifică disponibilitatea pentru data selectată.',
                nextStep: 'Trimite mesaj locației sau așteaptă confirmarea lor.',
                color: '#b45309'
            },
            availability_confirmed: {
                label: 'Dată disponibilă – poți cere ofertă',
                description: 'Locația a confirmat că data este liberă.',
                nextStep: 'Cere ofertă sau programează o vizionare pentru a merge mai departe.',
                color: '#2563eb'
            },
            offer_requested: {
                label: 'Ofertă cerută',
                description: 'Ai solicitat o ofertă personalizată și aștepți răspunsul locației.',
                nextStep: 'Poți trimite întrebări suplimentare sau anula cererea dacă planurile se schimbă.',
                color: '#a855f7'
            },
            offer_sent: {
                label: 'Ofertă primită',
                description: 'Locația ți-a trimis o ofertă personalizată.',
                nextStep: 'Analizează oferta, pune întrebări și confirmă dacă vrei să blochezi data.',
                color: '#7c3aed'
            },
            viewing_request: {
                label: 'Cerere vizionare trimisă',
                description: 'Ai cerut o vizionare a locației.',
                nextStep: 'Așteaptă confirmarea sau ajustează cererea dacă ai nevoie de altă dată.',
                color: '#0ea5e9'
            },
            viewing_rescheduled: {
                label: 'Vizionare reprogramată',
                description: 'Locația a propus o altă dată pentru vizionare.',
                nextStep: 'Acceptă noua propunere sau cere o altă variantă.',
                color: '#0284c7'
            },
            viewing_scheduled: {
                label: 'Vizionare confirmată',
                description: 'Vizionarea este programată la o dată și oră stabilite.',
                nextStep: 'Adaugă vizita în calendar și pregătește întrebările pentru echipă.',
                color: '#2563eb'
            },
            pre_booked: {
                label: 'Dată blocată temporar (Pre-rezervat)',
                description: 'Locația a blocat data provizoriu pentru tine.',
                nextStep: 'Confirmă rezervarea sau renunță pentru a elibera data.',
                color: '#0d9488'
            },
            confirmed: {
                label: 'Rezervat',
                description: 'Rezervarea a fost confirmată de locație după plata avansului.',
                nextStep: 'Ține legătura cu locația pentru detalii și pregătește feedback-ul de după eveniment.',
                color: '#15803d'
            },
            rejected: {
                label: 'Indisponibil / Refuzat',
                description: 'Locația nu este disponibilă sau a refuzat cererea.',
                nextStep: 'Vezi mesajul locației și trimite o nouă cerere dacă dorești.',
                color: '#b91c1c'
            },
            cancelled: {
                label: 'Anulat de client',
                description: 'Ai anulat cererea înainte de confirmare.',
                nextStep: 'Poți retrimite cererea oricând dorești.',
                color: '#dc2626'
            }
        };

        const viewingStatusMeta = {
            viewing_request: {
                label: 'Cerere vizionare trimisă',
                description: 'Locația verifică intervalele propuse.',
                color: '#0ea5e9'
            },
            viewing_rescheduled: {
                label: 'Reprogramat de locatie',
                description: 'Selectează varianta propusă de locație sau trimite alt interval.',
                color: '#0284c7'
            },
            viewing_scheduled: {
                label: 'Vizionare confirmată',
                description: 'Vizionarea este programată la intervalul stabilit.',
                color: '#2563eb'
            },
            viewing_completed: {
                label: 'Vizionare încheiată',
                description: 'Vizita a avut loc. Poți trimite feedback sau cere ofertă.',
                color: '#0f172a'
            },
            viewing_rejected: {
                label: 'Cerere respinsă',
                description: 'Locația nu poate onora vizionarea.',
                color: '#b91c1c'
            },
            viewing_cancelled: {
                label: 'Cerere anulată',
                description: 'Ai retras solicitarea de vizionare.',
                color: '#6b7280'
            }
        };

        let clientRequests = [
            { id: 1, locationId: 2, eventDate: addDays(45), guests: 120, status: 'availability_request', lastUpdate: addDays(-1) },
            { id: 2, locationId: 7, eventDate: addDays(80), guests: 150, status: 'availability_confirmed', lastUpdate: addDays(-2) },
            { id: 3, locationId: 1, eventDate: addDays(120), guests: 200, status: 'offer_sent', lastUpdate: addDays(-3), offerValidUntil: addDays(6) },
            { id: 4, locationId: 3, eventDate: addDays(90), guests: 90, status: 'offer_requested', lastUpdate: addDays(-5) },
            (() => {
                const slotA = addDays(6); slotA.setHours(11, 0, 0, 0);
                const slotB = addDays(7); slotB.setHours(17, 30, 0, 0);
                return {
                    id: 5,
                    locationId: 4,
                    eventDate: addDays(62),
                    guests: 80,
                    status: 'viewing_request',
                    lastUpdate: addDays(-4),
                    viewingId: 1,
                    requestedSlots: mapSlots([slotA, slotB])
                };
            })(),
            (() => {
                const requestSlotA = addDays(10); requestSlotA.setHours(14, 0, 0, 0);
                const requestSlotB = addDays(11); requestSlotB.setHours(18, 0, 0, 0);
                const ownerSlotA = addDays(12); ownerSlotA.setHours(10, 30, 0, 0);
                const ownerSlotB = addDays(13); ownerSlotB.setHours(16, 0, 0, 0);
                return {
                    id: 6,
                    locationId: 6,
                    eventDate: addDays(70),
                    guests: 95,
                    status: 'viewing_rescheduled',
                    lastUpdate: addDays(-2),
                    viewingId: 2,
                    requestedSlots: mapSlots([requestSlotA, requestSlotB]),
                    ownerSuggestions: mapSlots([ownerSlotA, ownerSlotB])
                };
            })(),
            { id: 7, locationId: 5, eventDate: addDays(35), guests: 100, status: 'pre_booked', lastUpdate: addDays(-4), holdExpiresAt: addDays(2) },
            { id: 8, locationId: 7, eventDate: addDays(160), guests: 60, status: 'confirmed', lastUpdate: addDays(-6) },
            { id: 9, locationId: 2, eventDate: addDays(52), guests: 110, status: 'rejected', lastUpdate: addDays(-8) },
            { id: 10, locationId: 3, eventDate: addDays(35), guests: 70, status: 'cancelled', lastUpdate: addDays(-10) },
            (() => {
                const confirmed = addDays(15); confirmed.setHours(12, 30, 0, 0);
                return {
                    id: 11,
                    locationId: 1,
                    eventDate: addDays(28),
                    guests: 85,
                    status: 'viewing_scheduled',
                    lastUpdate: addDays(-1),
                    viewingId: 3,
                    confirmedSlot: createSlotObject(confirmed)
                };
            })()
        ];

        let requestHistory = [
            { id: 1, message: 'Ai salvat Forest Retreat & Spa la favorite', timestamp: addDays(-14) },
            { id: 2, message: 'Ai trimis o cerere pentru Ambiance Lake', timestamp: addDays(-9) },
            { id: 3, message: 'Ambiance Lake ți-a trimis o ofertă', timestamp: addDays(-2) },
            { id: 4, message: 'Ai blocat Casa Miraval pentru 48h', timestamp: addDays(-4) }
        ];

        const clientViewings = [
            (() => {
                const optionA = addDays(6);
                optionA.setHours(11, 0, 0, 0);
                const optionB = addDays(7);
                optionB.setHours(17, 30, 0, 0);
                return {
                    id: 1,
                    locationId: 4,
                    status: 'viewing_request',
                    requestedSlots: [optionA, optionB].map(date => {
                        const copy = new Date(date.getTime());
                        return { date: copy, iso: copy.toISOString(), label: formatDateTime(copy) };
                    }),
                    ownerSuggestions: [],
                    confirmedSlot: null,
                    host: 'Echipa locației',
                    lastUpdate: addDays(-1),
                    note: 'Locația verifică disponibilitatea pentru intervalele propuse.',
                    date: new Date(optionA.getTime()),
                    hour: formatTime(optionA)
                };
            })(),
            (() => {
                const originalA = addDays(10);
                originalA.setHours(14, 0, 0, 0);
                const originalB = addDays(11);
                originalB.setHours(18, 0, 0, 0);
                const ownerA = addDays(12);
                ownerA.setHours(10, 30, 0, 0);
                const ownerB = addDays(13);
                ownerB.setHours(16, 0, 0, 0);
                return {
                    id: 2,
                    locationId: 6,
                    status: 'viewing_rescheduled',
                    requestedSlots: [originalA, originalB].map(date => {
                        const copy = new Date(date.getTime());
                        return { date: copy, iso: copy.toISOString(), label: formatDateTime(copy) };
                    }),
                    ownerSuggestions: [ownerA, ownerB].map(date => {
                        const copy = new Date(date.getTime());
                        return { date: copy, iso: copy.toISOString(), label: formatDateTime(copy) };
                    }),
                    confirmedSlot: null,
                    host: 'Mihai Dima',
                    lastUpdate: addDays(-2),
                    note: 'Alege varianta preferată sau propune alte intervale.',
                    date: new Date(ownerA.getTime()),
                    hour: formatTime(ownerA)
                };
            })(),
            (() => {
                const confirmed = addDays(15);
                confirmed.setHours(12, 30, 0, 0);
                return {
                    id: 3,
                    locationId: 1,
                    status: 'viewing_scheduled',
                    requestedSlots: [],
                    ownerSuggestions: [],
                    confirmedSlot: {
                        date: new Date(confirmed.getTime()),
                        iso: confirmed.toISOString(),
                        label: formatDateTime(confirmed)
                    },
                    host: 'Irina M.',
                    lastUpdate: addDays(-1),
                    note: 'Vizionarea este confirmată.',
                    date: new Date(confirmed.getTime()),
                    hour: formatTime(confirmed)
                };
            })(),
            (() => {
                const past = addDays(-3);
                past.setHours(10, 0, 0, 0);
                return {
                    id: 4,
                    locationId: 3,
                    status: 'viewing_completed',
                    requestedSlots: [],
                    ownerSuggestions: [],
                    confirmedSlot: {
                        date: new Date(past.getTime()),
                        iso: past.toISOString(),
                        label: formatDateTime(past)
                    },
                    host: 'Laura C.',
                    lastUpdate: addDays(-3),
                    note: 'Ți-am trimis planul detaliat.',
                    date: new Date(past.getTime()),
                    hour: formatTime(past)
                };
            })()
        ];

        const requestFilters = { status: 'all', location: 'all', sort: 'event-date' };
        const viewingFilters = { venue: 'all', status: 'all', sort: 'primary-date' };
        let activeRequestDetailId = null;
        let activeRescheduleViewingId = null;
        let selectedRescheduleOption = null;

        const favoritesGrid = document.getElementById('favorites-grid');
        const overviewFavoritesCount = document.getElementById('overview-favorites-count');
        const overviewRequestsCount = document.getElementById('overview-requests-count');
        const overviewOffersCount = document.getElementById('overview-offers-count');
        const overviewViewingsCount = document.getElementById('overview-viewings-count');
        const overviewActivityList = document.getElementById('overview-recent-activity');
        const overviewTasksList = document.getElementById('overview-next-steps');
        const overviewViewingsList = document.getElementById('overview-viewings-list');

        const requestsStatusFilter = document.getElementById('requests-status-filter');
        const requestsLocationFilter = document.getElementById('requests-location-filter');
        const requestsSortSelect = document.getElementById('requests-sort');
        const requestsTableBody = document.getElementById('requests-table-body');
        const requestDetailElements = {
            page: document.getElementById('request-detail'),
            body: document.getElementById('request-detail-body'),
            empty: document.getElementById('request-detail-empty'),
            backButton: document.getElementById('request-detail-back'),
            title: document.getElementById('request-detail-title'),
            subtitle: document.getElementById('request-detail-subtitle'),
            venueLinkPrimary: document.getElementById('request-detail-venue-link'),
            footer: document.getElementById('request-detail-footer'),
            statusChip: document.getElementById('request-detail-status-chip'),
            nextStep: document.getElementById('request-detail-next-step'),
            statusDescription: document.getElementById('request-detail-status-description'),
            overviewGrid: document.getElementById('request-detail-overview'),
            slotsContainer: document.getElementById('request-detail-slots'),
            offerCard: document.getElementById('request-detail-offer-card'),
            offerGrid: document.getElementById('request-detail-offer-grid'),
            offerActions: document.getElementById('request-detail-offer-actions'),
            offerDownload: document.getElementById('request-detail-offer-download'),
            locationGrid: document.getElementById('request-detail-location-grid'),
            locationContact: document.getElementById('request-detail-contact'),
        };

        const viewingsVenueFilter = document.getElementById('viewings-venue-filter');
        const viewingsStatusFilter = document.getElementById('viewings-status-filter');
        const viewingsSortSelect = document.getElementById('viewings-sort');
        const viewingsTableBody = document.getElementById('viewings-table-body');
        const reschedulePanel = document.querySelector('[data-reschedule-panel]');
        const rescheduleLocationEl = document.querySelector('[data-reschedule-location]');
        const rescheduleUpdatedEl = document.querySelector('[data-reschedule-updated]');
        const rescheduleMessageEl = document.querySelector('[data-reschedule-message]');
        const rescheduleOptionsContainer = document.querySelector('[data-reschedule-options]');
        const rescheduleAcceptBtn = document.querySelector('[data-reschedule-accept]');
        const rescheduleDeclineBtn = document.querySelector('[data-reschedule-decline]');

        if (requestsSortSelect) {
            requestsSortSelect.value = requestFilters.sort;
        }
        if (viewingsSortSelect) {
            viewingsSortSelect.value = viewingFilters.sort;
        }

        function getLocationById(id) {
            return locations.find(loc => loc.id === id);
        }

        function populateSelect(selectEl, values, includeAll = true, allLabel = 'Toate opțiunile') {
            if (!selectEl) return;
            selectEl.innerHTML = '';
            if (includeAll) {
                const option = document.createElement('option');
                option.value = 'all';
                option.textContent = allLabel;
                selectEl.appendChild(option);
            }
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value.value ?? value;
                option.textContent = value.label ?? value;
                selectEl.appendChild(option);
            });
        }

        function createStatusChip(status, metaSource = requestStatusMeta) {
            const span = document.createElement('span');
            span.className = 'status-chip';
            span.dataset.status = status;
            const meta = metaSource[status] || { label: status, color: '#1f2937' };
            span.textContent = meta.label || status;
            return span;
        }

        function createInfoItem(label, value, options = {}) {
            const { meta, isMissing = false } = options;
            const item = document.createElement('div');
            item.className = 'booking-row-item';

            const labelEl = document.createElement('span');
            labelEl.className = 'booking-row-label';
            labelEl.textContent = label;

            const valueEl = document.createElement('span');
            valueEl.className = 'booking-row-value';
            valueEl.textContent = value ?? '—';
            if (isMissing) {
                valueEl.classList.add('is-missing-value');
            }

            item.append(labelEl, valueEl);

            if (meta) {
                const metaEl = document.createElement('span');
                metaEl.className = 'booking-row-meta';
                metaEl.textContent = meta;
                item.appendChild(metaEl);
            }

            return item;
        }

        const formatDateLabel = (date) => (date instanceof Date && !Number.isNaN(date.getTime())) ? formatDate(date) : '—';

        function createDetailItem(label, value) {
            const wrapper = document.createElement('div');
            wrapper.className = 'request-detail-item';
            const labelEl = document.createElement('small');
            labelEl.textContent = label;
            const valueEl = document.createElement('span');
            valueEl.textContent = value ?? '—';
            wrapper.append(labelEl, valueEl);
            return wrapper;
        }

        function renderDetailGrid(container, items) {
            if (!container) return;
            container.innerHTML = '';
            items
                .filter(item => item && item.label)
                .forEach(item => {
                    container.appendChild(createDetailItem(item.label, item.value));
                });
        }

        function renderDetailSlots(container, entries) {
            if (!container) return;
            container.innerHTML = '';
            if (!entries || !entries.length) {
                container.hidden = true;
                return;
            }
            container.hidden = false;
            entries.forEach(({ label, value }) => {
                const row = document.createElement('div');
                row.className = 'request-detail-slot';
                const labelEl = document.createElement('span');
                labelEl.textContent = label;
                const valueEl = document.createElement('span');
                valueEl.textContent = value || '—';
                row.append(labelEl, valueEl);
                container.appendChild(row);
            });
        }

        function showRequestDetail(request) {
            if (!request) return;

            const location = getLocationById(request.locationId);
            const statusMeta = requestStatusMeta[request.status] || {};
            const viewing = typeof request.viewingId === 'number'
                ? clientViewings.find(view => view.id === request.viewingId)
                : null;
            const viewingMeta = viewing ? viewingStatusMeta[viewing.status] || {} : null;

            activeRequestDetailId = request.id;

            const venueUrl = location?.id ? `venue-details.html?id=${location.id}` : 'venue-details.html';
            if (requestDetailElements.venueLinkPrimary) {
                requestDetailElements.venueLinkPrimary.href = venueUrl;
            }

            if (requestDetailElements.title) {
                requestDetailElements.title.textContent = `Cerere pentru ${location?.name || 'locație'}`;
            }
            if (requestDetailElements.subtitle) {
                requestDetailElements.subtitle.textContent = statusMeta.label || request.status;
            }

            if (requestDetailElements.statusChip) {
                requestDetailElements.statusChip.dataset.status = request.status;
                requestDetailElements.statusChip.textContent = statusMeta.label || request.status;
            }
            if (requestDetailElements.nextStep) {
                requestDetailElements.nextStep.textContent = statusMeta.nextStep || 'Ține legătura cu locația pentru a avansa discuția.';
            }
            if (requestDetailElements.statusDescription) {
                requestDetailElements.statusDescription.textContent = statusMeta.description || '';
            }

            const overviewItems = [
                { label: 'Tip eveniment', value: request.eventType || '—' },
                { label: 'Dată eveniment', value: formatDateLabel(request.eventDate) },
                { label: 'Număr invitați', value: Number.isFinite(request.guests) ? `${request.guests} invitați` : 'Necesită completare' },
                { label: 'Estimare cost', value: location ? formatPricePerPerson(location.price) : '—' },
                { label: 'Ultima actualizare', value: formatDateLabel(request.lastUpdate) }
            ];
            if (request.status === 'pre_booked' && request.holdExpiresAt instanceof Date) {
                overviewItems.push({ label: 'Pre-rezervare până la', value: formatDateLabel(request.holdExpiresAt) });
            }
            renderDetailGrid(requestDetailElements.overviewGrid, overviewItems);

            const requestSlots = mapSlots(request.requestedSlots).map(slot => slot.label);
            const ownerSlots = mapSlots(request.ownerSuggestions).map(slot => slot.label);
            const confirmedSlot = mapSlots([request.confirmedSlot])[0]?.label || null;
            const slotEntries = [];
            if (requestSlots.length) {
                slotEntries.push({ label: 'Client', value: requestSlots.join(' • ') });
            }
            if (ownerSlots.length) {
                slotEntries.push({ label: 'Locație', value: ownerSlots.join(' • ') });
            }
            if (confirmedSlot) {
                slotEntries.push({ label: 'Confirmat', value: confirmedSlot });
            }
            renderDetailSlots(requestDetailElements.slotsContainer, slotEntries);

            const offerStatuses = ['offer_requested', 'offer_sent', 'pre_booked', 'confirmed'];
            if (offerStatuses.includes(request.status)) {
                const offerItems = [
                    { label: 'Status ofertă', value: statusMeta.label || request.status }
                ];
                if (request.status === 'offer_requested') {
                    offerItems.push({ label: 'Pas următor', value: statusMeta.nextStep || 'Așteaptă răspunsul locației.' });
                }
                if (request.status === 'pre_booked') {
                    offerItems.push({ label: 'Rezervare expiră la', value: formatDateLabel(request.holdExpiresAt) });
                }
                if (confirmedSlot) {
                    offerItems.push({ label: 'Interval confirmat', value: confirmedSlot });
                }
                renderDetailGrid(requestDetailElements.offerGrid, offerItems);
                if (requestDetailElements.offerCard) {
                    requestDetailElements.offerCard.hidden = offerItems.length === 0;
                }
                if (requestDetailElements.offerActions && requestDetailElements.offerDownload) {
                    if (request.status === 'offer_sent') {
                        const downloadHref = `assets/offers/sample-offer.pdf`;
                        requestDetailElements.offerDownload.href = downloadHref;
                        requestDetailElements.offerDownload.setAttribute('download', `oferta-cerere-${request.id}.pdf`);
                        requestDetailElements.offerActions.hidden = false;
                    } else {
                        requestDetailElements.offerActions.hidden = true;
                        requestDetailElements.offerDownload.href = '#';
                        requestDetailElements.offerDownload.removeAttribute('download');
                    }
                }
            } else if (requestDetailElements.offerCard) {
                requestDetailElements.offerCard.hidden = true;
                requestDetailElements.offerGrid && (requestDetailElements.offerGrid.innerHTML = '');
                if (requestDetailElements.offerActions) {
                    requestDetailElements.offerActions.hidden = true;
                    if (requestDetailElements.offerDownload) {
                        requestDetailElements.offerDownload.href = '#';
                        requestDetailElements.offerDownload.removeAttribute('download');
                    }
                }
            }

            const locationItems = [];
            locationItems.push({ label: 'Locație', value: location?.name || 'Locație necunoscută' });
            locationItems.push({ label: 'Adresă', value: location?.address || location?.city || '—' });
            locationItems.push({ label: 'Oraș', value: location?.city || '—' });
            renderDetailGrid(requestDetailElements.locationGrid, locationItems);
            if (requestDetailElements.locationContact) {
                requestDetailElements.locationContact.innerHTML = '';
                const contactItems = [];
                if (location?.contactPhone) {
                    const phoneHref = location.contactPhone.replace(/[^+0-9]/g, '');
                    contactItems.push({
                        label: 'Telefon',
                        href: `tel:${phoneHref}`,
                        text: location.contactPhone
                    });
                }
                if (location?.contactEmail) {
                    contactItems.push({
                        label: 'Email',
                        href: `mailto:${location.contactEmail}`,
                        text: location.contactEmail
                    });
                }
                if (contactItems.length) {
                    contactItems.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'request-detail-contact-row';
                        const labelEl = document.createElement('small');
                        labelEl.textContent = item.label;
                        const link = document.createElement('a');
                        link.href = item.href;
                        link.textContent = item.text;
                        row.append(labelEl, link);
                        requestDetailElements.locationContact.appendChild(row);
                    });
                    requestDetailElements.locationContact.hidden = false;
                } else {
                    requestDetailElements.locationContact.hidden = true;
                }
            }

            if (requestDetailElements.body) {
                requestDetailElements.body.hidden = false;
            }
            if (requestDetailElements.footer) {
                requestDetailElements.footer.hidden = false;
            }
            if (requestDetailElements.empty) {
                requestDetailElements.empty.hidden = true;
            }

            activatePage('request-detail');
            requestDetailElements.backButton?.focus({ preventScroll: true });
        }

        function getRequestNextStep(request) {
            const defaultStep = {
                title: 'Următorul pas',
                detail: 'Ține legătura cu locația pentru a avansa discuția.'
            };
            if (!request) {
                return defaultStep;
            }
            const meta = requestStatusMeta[request.status];
            if (!meta) {
                return defaultStep;
            }
            let detail = meta.nextStep || meta.description || defaultStep.detail;
            if (request.status === 'offer_sent' && request.offerValidUntil instanceof Date) {
                detail += ` Oferta expiră pe ${formatDate(request.offerValidUntil)}.`;
            }
            if (request.status === 'pre_booked' && request.holdExpiresAt instanceof Date) {
                detail += ` Blocajul expiră pe ${formatDate(request.holdExpiresAt)}.`;
            }
            return {
                title: defaultStep.title,
                detail: detail
            };
        }

        function renderOverviewMetrics() {
            if (overviewFavoritesCount) overviewFavoritesCount.textContent = favoriteIds.length;
            if (overviewRequestsCount) overviewRequestsCount.textContent = clientRequests.filter(req => !['cancelled', 'rejected'].includes(req.status)).length;
            if (overviewOffersCount) overviewOffersCount.textContent = clientRequests.filter(req => req.status === 'offer_sent').length;
            if (overviewViewingsCount) {
                const activeStatuses = ['viewing_request', 'viewing_rescheduled', 'viewing_scheduled'];
                overviewViewingsCount.textContent = clientViewings.filter(view => activeStatuses.includes(view.status)).length;
            }
        }

        function renderOverviewRecentActivity() {
            if (!overviewActivityList) return;
            const activity = [];

            clientRequests.forEach(req => {
                activity.push({
                    type: 'request',
                    id: req.id,
                    timestamp: req.lastUpdate,
                    message: `${requestStatusMeta[req.status]?.label || 'Actualizare'} · ${getLocationById(req.locationId)?.name || 'Locație'}`
                });
            });

            requestHistory.forEach(entry => {
                activity.push({
                    type: 'history',
                    id: entry.id,
                    timestamp: entry.timestamp,
                    message: entry.message
                });
            });

            clientViewings.forEach(viewing => {
                activity.push({
                    type: 'viewing',
                    id: viewing.id,
                    timestamp: viewing.lastUpdate,
                    message: `Vizionare ${viewingStatusMeta[viewing.status]?.label || ''} · ${getLocationById(viewing.locationId)?.name || 'Locație'}`
                });
            });

            const validActivity = activity
                .filter(item => item.timestamp instanceof Date && !Number.isNaN(item.timestamp.getTime()))
                .sort((a, b) => b.timestamp - a.timestamp);

            overviewActivityList.innerHTML = '';
            const toDisplay = validActivity.slice(0, 5);
            if (!toDisplay.length) {
                overviewActivityList.innerHTML = '<div class="empty-state">Nu există activități recente.</div>';
                return;
            }

            toDisplay.forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'list-item';
                entry.innerHTML = `
                    <div>${item.message}</div>
                    <span class="panel-meta">${formatDate(item.timestamp)}</span>
                `;
                if (item.type === 'request' || item.type === 'viewing') {
                    entry.classList.add('is-interactive');
                    entry.addEventListener('click', () => {
                        if (item.type === 'request') {
                            navigateToItem('request', item.id);
                        } else if (item.type === 'viewing') {
                            navigateToItem('viewing', item.id);
                        }
                    });
                }
                overviewActivityList.appendChild(entry);
            });
        }

        function renderOverviewViewingsList() {
            if (!overviewViewingsList) return;
            const upcoming = clientViewings
                .map(view => {
                    const primarySlot = getViewingPrimarySlot(view);
                    return {
                        view,
                        primarySlot,
                        date: primarySlot?.date || (view.date instanceof Date ? view.date : null)
                    };
                })
                .filter(item => item.date && item.date >= today && item.date <= addDays(14))
                .sort((a, b) => a.date - b.date);

            overviewViewingsList.innerHTML = '';
            if (!upcoming.length) {
                overviewViewingsList.innerHTML = '<div class="empty-state">Nu ai vizionări în următoarele 14 zile.</div>';
                return;
            }

            upcoming.forEach(({ view, primarySlot }) => {
                const location = getLocationById(view.locationId);
                const item = document.createElement('div');
                // MODIFICAT: Adăugat clasă și event listener pentru interactivitate
                item.className = 'list-item is-interactive';
                item.addEventListener('click', () => navigateToItem('viewing', view.id));
                const chip = createStatusChip(view.status, viewingStatusMeta);
                item.innerHTML = `
                    <div>
                        ${location?.name || 'Locație necunoscută'}
                        <span class="panel-meta">${primarySlot ? primarySlot.label : 'Programare în curs de stabilire'}</span>
                    </div>
                `;
                item.appendChild(chip);
                overviewViewingsList.appendChild(item);
            });
        }

        function navigateToItem(type, id) {
            if (!type || !id) return;
            if (type === 'viewing') {
                const viewing = clientViewings.find(view => view.id === id);
                if (!viewing) {
                    activatePage('viewings');
                    if (requestDetailElements.footer) {
                        requestDetailElements.footer.hidden = true;
                    }
                    return;
                }
                const request = findRequestByViewingId(viewing.id);
                if (request) {
                    showRequestDetail(request);
                } else {
                    activatePage('viewings');
                    if (requestDetailElements.footer) {
                        requestDetailElements.footer.hidden = true;
                    }
                }
                return;
            }
            const pageId = 'requests';
            activatePage(pageId);
            if (type === 'request') {
                requestFilters.status = 'all';
                requestFilters.location = 'all';
                requestFilters.sort = 'event-date';
                if (requestsStatusFilter) requestsStatusFilter.value = 'all';
                if (requestsLocationFilter) requestsLocationFilter.value = 'all';
                if (requestsSortSelect) requestsSortSelect.value = 'event-date';
                renderRequests();
            }
            requestAnimationFrame(() => {
                let targetRow = null;
                if (type === 'viewing' && viewingsTableBody) {
                    targetRow = viewingsTableBody.querySelector(`tr[data-id="${id}"]`);
                } else if (type === 'request' && requestsTableBody) {
                    targetRow = requestsTableBody.querySelector(`tr[data-id="${id}"]`);
                }
                if (targetRow) {
                    targetRow.classList.add('is-highlighted');
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => targetRow.classList.remove('is-highlighted'), 2400);
                }
            });
        }

        function renderOverview() {
            renderOverviewMetrics();
            renderOverviewRecentActivity();
            renderOverviewViewingsList();
            renderReschedulePanel();
        }

        function renderFavorites() {
            if (!favoritesGrid) return;
            favoritesGrid.innerHTML = '';
            const favoriteLocations = locations.filter(loc => favoriteIds.includes(loc.id));

            if (!favoriteLocations.length) {
                favoritesGrid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Nu ai salvat încă nicio locație. Explorează și adaugă favorite pentru a le regăsi rapid.</div>';
                renderOverviewMetrics();
                return;
            }

            favoriteLocations.forEach(loc => {
                const card = document.createElement('div');
                card.className = 'location-card';
                card.innerHTML = `
                    <div class="location-image" style="background-image: url('${loc.imageUrl}')">
                        <button class="remove-favorite-btn" data-id="${loc.id}" title="Elimină de la favorite">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        </button>
                    </div>
                    <div class="location-details">
                        <h3>${loc.name}</h3>
                        <p>${loc.city}, România</p>
                        <div class="location-card-footer">
                            <span class="location-price">de la <strong>${loc.price}€</strong>/pers</span>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <a href="venue-details.html?id=${loc.id}" class="crm-button ghost" style="padding: 6px 14px; font-size: 0.85rem;">Vezi detalii</a>
                                <button type="button" class="crm-button primary request-availability-btn" data-location-id="${loc.id}" style="padding: 6px 14px; font-size: 0.85rem;">Cere disponibilitatea</button>
                            </div>
                        </div>
                    </div>
                `;
                favoritesGrid.appendChild(card);
            });

            favoritesGrid.querySelectorAll('.remove-favorite-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const idToRemove = parseInt(button.dataset.id, 10);
                    favoriteIds = favoriteIds.filter(id => id !== idToRemove);
                    localStorage.setItem('favoriteIds', JSON.stringify(favoriteIds));
                    renderFavorites();
                    renderOverviewMetrics();
                });
            });

            favoritesGrid.querySelectorAll('.request-availability-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const locationId = parseInt(button.dataset.locationId, 10);
                    const location = getLocationById(locationId);
                    openAvailabilityModal(location);
                });
            });

            renderOverviewMetrics();
        }

        const availabilityModal = document.getElementById('availability-modal');
        const availabilityModalCloseBtn = document.getElementById('availability-modal-close');
        const availabilityForm = document.getElementById('availability-form');
        const availabilityEventTypeSelect = document.getElementById('availability-event-type');
        const availabilityGuestsInput = document.getElementById('availability-guests');
        const availabilitySelectedDateLabel = document.getElementById('availability-selected-date');
        const availabilityModalSubtitle = document.getElementById('availability-modal-subtitle');
        const availabilityCancelBtn = document.getElementById('availability-cancel-btn');

        const eventTypeOptions = ['Nuntă', 'Botez', 'Cununie Civilă', 'Eveniment Corporate', 'Petrecere Privată', 'Aniversare'];
        const availabilityCalendarContainer = document.getElementById('availability-calendar');
        const availabilityDateInput = document.getElementById('availability-date-picker');
        let availabilityDatePicker = null;

        const availabilityState = {
            locationId: null,
            locationName: '',
            selectedDate: null
        };

        const viewingModal = document.getElementById('viewing-modal');
        const viewingModalCloseBtn = document.getElementById('viewing-modal-close');
        const viewingForm = document.getElementById('viewing-form');
        const viewingSelectedDateLabel = document.getElementById('viewing-selected-date');
        const viewingModalSubtitle = document.getElementById('viewing-modal-subtitle');
        const viewingModalTitle = document.getElementById('viewing-modal-title');
        const viewingCancelBtn = document.getElementById('viewing-cancel-btn');
        const viewingSlotHintEl = document.querySelector('[data-viewing-slot-hint]');
        const viewingSuggestionsContainer = document.querySelector('[data-viewing-suggestions]');
        const viewingSlotCounter = document.getElementById('viewing-slot-counter');
        const viewingEmptyStateEl = document.querySelector('[data-viewing-empty-state]');
        const viewingAddSlotBtn = document.querySelector('[data-viewing-add-slot]');
        const viewingSuggestionPickers = new Map();
        const MAX_VIEWING_SLOTS = 4;
        const MIN_VIEWING_SLOTS = 2;
        const viewingTimeOptions = (() => {
            const options = [];
            for (let hour = 8; hour <= 20; hour += 1) {
                for (const minute of [0, 30]) {
                    if (hour === 20 && minute > 0) {
                        continue;
                    }
                    const value = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    options.push({ value, label: value });
                }
            }
            return options;
        })();

        function combineDateAndTime(dateString, timeString) {
            if (typeof dateString !== 'string' || !dateString || typeof timeString !== 'string' || !timeString) {
                return null;
            }
            const [yearStr, monthStr, dayStr] = dateString.split('-');
            const [hourStr, minuteStr] = timeString.split(':');
            const year = Number.parseInt(yearStr, 10);
            const month = Number.parseInt(monthStr, 10);
            const day = Number.parseInt(dayStr, 10);
            const hour = Number.parseInt(hourStr, 10);
            const minute = Number.parseInt(minuteStr, 10) || 0;
            if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day) || !Number.isFinite(hour)) {
                return null;
            }
            const result = new Date(year, month - 1, day, hour, minute, 0, 0);
            return Number.isNaN(result.getTime()) ? null : result;
        }
        let viewingSlotSequence = 0;

        const viewingState = {
            requestId: null,
            locationId: null,
            locationName: '',
            slots: []
        };

        function openAvailabilityModal(location) {
            if (!availabilityModal || !location) {
                return;
            }
            availabilityState.locationId = location.id;
            availabilityState.locationName = location.name;
            availabilityState.selectedDate = null;

            if (availabilityModalSubtitle) {
                availabilityModalSubtitle.textContent = `Selectează data pentru ${location.name}`;
            }
            if (availabilityEventTypeSelect && !availabilityEventTypeSelect.options.length) {
                eventTypeOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    availabilityEventTypeSelect.appendChild(opt);
                });
            }
            if (availabilityEventTypeSelect) {
                availabilityEventTypeSelect.value = eventTypeOptions[0];
            }
            if (availabilityGuestsInput) {
                availabilityGuestsInput.value = '';
            }
            availabilityModal.classList.add('is-visible');
            ensureAvailabilityDatePicker();
            updateAvailabilitySelectedDate();
        }

        function closeAvailabilityModal() {
            availabilityModal?.classList.remove('is-visible');
            availabilityState.selectedDate = null;
            availabilityDatePicker?.clear(false);
            updateAvailabilitySelectedDate();
            availabilityDatePicker?.close();
        }

        function ensureAvailabilityDatePicker() {
            if (!availabilityCalendarContainer || !availabilityDateInput || typeof flatpickr !== 'function') {
                return null;
            }
            const today = new Date();
            if (!availabilityDatePicker) {
                if (typeof flatpickr.localize === 'function' && flatpickr.l10ns?.ro) {
                    flatpickr.localize(flatpickr.l10ns.ro);
                }
                availabilityDatePicker = flatpickr(availabilityDateInput, {
                    minDate: 'today',
                    locale: flatpickr.l10ns?.ro || 'default',
                    disableMobile: true,
                    monthSelectorType: 'dropdown',
                    yearSelectorType: 'dropdown',
                    showMonths: 1,
                    inline: true,
                    appendTo: availabilityCalendarContainer,
                    onChange(selectedDates, dateStr, instance) {
                        availabilityState.selectedDate = selectedDates[0] || null;
                        updateAvailabilitySelectedDate();
                    },
                    onDayCreate: decorateAvailabilityDay
                });
            }
            const referenceDate = availabilityState.selectedDate || today;
            availabilityDatePicker.clear(false);
            availabilityDatePicker.set('disable', [
                function(date) {
                    return getAvailabilityStatus(availabilityState.locationId, date) === 'booked';
                }
            ]);
            availabilityDatePicker.redraw();
            availabilityDatePicker.jumpToDate(referenceDate);
            availabilityState.selectedDate = null;
            updateAvailabilitySelectedDate();
            return availabilityDatePicker;
        }

        function decorateAvailabilityDay(selectedDates, dateStr, instance, dayElem) {
            const date = dayElem.dateObj;
            if (!date) {
                return;
            }
            const status = getAvailabilityStatus(availabilityState.locationId, date);
            dayElem.classList.remove('availability-day-hold', 'availability-day-booked', 'availability-day-available');
            if (status === 'hold') {
                dayElem.classList.add('availability-day-hold');
            } else if (status === 'booked') {
                dayElem.classList.add('availability-day-booked', 'flatpickr-disabled');
            } else {
                dayElem.classList.add('availability-day-available');
            }
        }

        function updateAvailabilitySelectedDate() {
            if (!availabilitySelectedDateLabel) {
                return;
            }
            if (!availabilityState.selectedDate) {
                availabilitySelectedDateLabel.textContent = 'Selectează o dată disponibilă din calendar.';
            } else {
                availabilitySelectedDateLabel.textContent = `Data selectată: ${formatDate(availabilityState.selectedDate)}`;
            }
        }

        function openViewingModal(request, { presetSlots = [] } = {}) {
            if (!viewingModal || !request) {
                return;
            }
            viewingState.requestId = request.id;
            viewingState.locationId = request.locationId;
            viewingState.locationName = getLocationById(request.locationId)?.name || '';
            viewingState.slots = mapSlots(presetSlots);

            if (!viewingState.slots.length && typeof request.viewingId === 'number') {
                const existingViewing = clientViewings.find(view => view.id === request.viewingId);
                if (existingViewing) {
                    viewingState.slots = mapSlots(existingViewing.requestedSlots);
                }
            }
            if (!viewingState.slots.length && Array.isArray(request.requestedSlots)) {
                viewingState.slots = mapSlots(request.requestedSlots);
            }

            if (viewingModalTitle) {
                viewingModalTitle.textContent = viewingState.locationName
                    ? `Programează o vizionare la ${viewingState.locationName}`
                    : 'Programează o vizionare';
            }
            if (viewingModalSubtitle) {
                viewingModalSubtitle.textContent = 'Selectează data și ora preferată pentru vizionare.';
            }
            initializeViewingSuggestionSlots(viewingState.slots);
            viewingModal.classList.add('is-visible');
        }

        function closeViewingModal() {
            viewingModal?.classList.remove('is-visible');
            viewingState.requestId = null;
            viewingState.locationId = null;
            viewingState.locationName = '';
            viewingState.slots = [];
            destroyViewingSuggestionSlots();
            updateViewingSlotsControls();
        }

        function destroyViewingSuggestionSlots() {
            viewingSuggestionPickers.forEach(config => {
                config?.datePicker?.destroy();
            });
            viewingSuggestionPickers.clear();
            if (viewingSuggestionsContainer) {
                viewingSuggestionsContainer.innerHTML = '';
            }
            if (viewingSlotCounter) {
                viewingSlotCounter.textContent = '';
                viewingSlotCounter.hidden = true;
            }
            viewingSlotSequence = 0;
        }

        function createViewingSuggestionSlot(slotIndex = null, initialSlot = null) {
            if (!viewingSuggestionsContainer || viewingSuggestionPickers.size >= MAX_VIEWING_SLOTS) {
                return null;
            }
            const index = Number.isFinite(slotIndex) ? slotIndex : viewingSlotSequence;
            viewingSlotSequence = Math.max(viewingSlotSequence, index + 1);

            const row = document.createElement('div');
            row.className = 'reschedule-slot';
            row.dataset.viewingSlotIndex = String(index);

            const fields = document.createElement('div');
            fields.className = 'reschedule-slot-fields';

            const dateInput = document.createElement('input');
            dateInput.type = 'text';
            dateInput.placeholder = 'Selectează data';
            dateInput.required = true;
            dateInput.autocomplete = 'off';

            const timeSelect = document.createElement('select');
            timeSelect.required = true;
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Selectează ora';
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            timeSelect.appendChild(placeholderOption);
            viewingTimeOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                timeSelect.appendChild(opt);
            });

            fields.append(dateInput, timeSelect);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'crm-button ghost sm';
            removeBtn.dataset.viewingRemoveSlot = 'true';
            removeBtn.textContent = 'Șterge';

            row.append(fields, removeBtn);
            viewingSuggestionsContainer.appendChild(row);

            let datePicker = null;
            if (typeof flatpickr === 'function') {
                const locale = flatpickr.l10ns?.ro || flatpickr.l10ns?.default || 'default';
                datePicker = flatpickr(dateInput, {
                    enableTime: false,
                    dateFormat: 'Y-m-d',
                    allowInput: true,
                    locale,
                    minDate: 'today',
                    clickOpens: true,
                    onChange(selectedDates, dateStr) {
                        if (typeof dateStr === 'string') {
                            dateInput.value = dateStr;
                        }
                        updateViewingSlotsControls();
                    }
                });
                datePicker?.clear(false);
                dateInput.value = '';
            }

            if (initialSlot) {
                const rawDate = initialSlot instanceof Date
                    ? initialSlot
                    : (initialSlot?.date instanceof Date
                        ? initialSlot.date
                        : (typeof initialSlot?.iso === 'string'
                            ? new Date(initialSlot.iso)
                            : null));
                const preset = normalizeSlotDate(rawDate);
                if (preset) {
                    const presetDateStr = `${preset.getFullYear()}-${String(preset.getMonth() + 1).padStart(2, '0')}-${String(preset.getDate()).padStart(2, '0')}`;
                    datePicker?.setDate(preset, true, 'Y-m-d');
                    dateInput.value = presetDateStr;
                    const timeValue = formatTime(preset);
                    timeSelect.value = timeValue;
                    if (timeSelect.value !== timeValue) {
                        const opt = document.createElement('option');
                        opt.value = timeValue;
                        opt.textContent = timeValue;
                        timeSelect.appendChild(opt);
                        timeSelect.value = timeValue;
                    }
                }
            }

            viewingSuggestionPickers.set(row, { row, datePicker, dateInput, timeSelect });

            const handleChange = () => {
                dateInput.classList.remove('is-invalid');
                timeSelect.classList.remove('is-invalid');
                updateViewingSlotsControls();
            };
            dateInput.addEventListener('input', handleChange);
            dateInput.addEventListener('blur', handleChange);
            timeSelect.addEventListener('change', handleChange);

            removeBtn.addEventListener('click', () => {
                const config = viewingSuggestionPickers.get(row);
                config?.datePicker?.destroy();
                viewingSuggestionPickers.delete(row);
                row.remove();
                updateViewingSlotsControls();
            });

            updateViewingSlotsControls();
            return row;
        }

        function initializeViewingSuggestionSlots(presetSlots = []) {
            destroyViewingSuggestionSlots();
            const initialSlots = Array.isArray(presetSlots) ? presetSlots.slice(0, MAX_VIEWING_SLOTS) : [];
            const desiredCount = Math.min(
                Math.max(initialSlots.length, MIN_VIEWING_SLOTS),
                MAX_VIEWING_SLOTS
            );
            for (let i = 0; i < desiredCount; i += 1) {
                const slot = initialSlots[i] || null;
                createViewingSuggestionSlot(i, slot);
            }
            updateViewingSlotsControls();
        }

        function collectViewingSuggestionSlots() {
            const collected = [];
            const seen = new Set();
            viewingSuggestionPickers.forEach(({ dateInput, timeSelect }) => {
                const combined = combineDateAndTime(dateInput.value, timeSelect.value);
                if (!combined) {
                    return;
                }
                const slot = createSlotObject(combined);
                if (!slot?.iso || seen.has(slot.iso)) {
                    return;
                }
                seen.add(slot.iso);
                collected.push(slot);
            });
            collected.sort((a, b) => {
                const dateA = normalizeSlotDate(a?.date || (a?.iso ? new Date(a.iso) : null));
                const dateB = normalizeSlotDate(b?.date || (b?.iso ? new Date(b.iso) : null));
                return (dateA?.getTime() || 0) - (dateB?.getTime() || 0);
            });
            return collected;
        }

        function updateViewingSlotsControls() {
            const entries = Array.from(viewingSuggestionPickers.values());
            const total = entries.length;
            const completed = entries.filter(({ dateInput, timeSelect }) => {
                return Boolean(combineDateAndTime(dateInput.value, timeSelect.value));
            }).length;

            if (viewingSlotCounter) {
                if (total > 0) {
                    viewingSlotCounter.textContent = `${total}/${MAX_VIEWING_SLOTS} intervale`;
                    viewingSlotCounter.hidden = false;
                } else {
                    viewingSlotCounter.textContent = '';
                    viewingSlotCounter.hidden = true;
                }
            }

            if (viewingSlotHintEl) {
                if (total < MAX_VIEWING_SLOTS) {
                    const remaining = MAX_VIEWING_SLOTS - total;
                    viewingSlotHintEl.textContent = `Poți adăuga încă ${remaining} ${remaining === 1 ? 'interval' : 'intervale'} (din 30 în 30 de minute).`;
                } else {
                    viewingSlotHintEl.textContent = 'Ai configurat 4 intervale. Șterge unul dacă vrei să adaugi altul.';
                }
            }

            if (viewingSelectedDateLabel) {
                if (completed === 0) {
                    viewingSelectedDateLabel.textContent = 'Lista de intervale va fi trimisă către locație. Alege cel puțin o variantă înainte de a continua.';
                } else if (completed === 1) {
                    viewingSelectedDateLabel.textContent = 'Trimiți 1 interval preferat către locație.';
                } else {
                    viewingSelectedDateLabel.textContent = `Trimiți ${completed} intervale preferate către locație.`;
                }
            }

            if (viewingAddSlotBtn) {
                viewingAddSlotBtn.disabled = total >= MAX_VIEWING_SLOTS;
            }

            if (viewingEmptyStateEl) {
                viewingEmptyStateEl.hidden = total > 0;
            }

            if (viewingSuggestionsContainer) {
                const removeButtons = viewingSuggestionsContainer.querySelectorAll('[data-viewing-remove-slot]');
                const hideRemove = total <= MIN_VIEWING_SLOTS;
                removeButtons.forEach(button => {
                    button.hidden = hideRemove;
                    button.disabled = hideRemove;
                });
            }

            viewingState.slots = collectViewingSuggestionSlots();
        }

        function getAvailabilityStatus(locationId, date) {
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0) {
                return 'booked';
            }
            const hash = (date.getDate() + (locationId || 1) * 3 + dayOfWeek) % 6;
            if (hash === 0) {
                return 'booked';
            }
            if (hash === 1) {
                return 'hold';
            }
            return 'available';
        }

        availabilityModal?.addEventListener('click', (event) => {
            if (event.target === availabilityModal) {
                closeAvailabilityModal();
            }
        });
        availabilityModalCloseBtn?.addEventListener('click', closeAvailabilityModal);
        availabilityCancelBtn?.addEventListener('click', (event) => {
            event.preventDefault();
            closeAvailabilityModal();
        });

        availabilityForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!availabilityState.locationId) {
                return;
            }
            if (!availabilityState.selectedDate) {
                window.alert('Selectează o dată disponibilă înainte de a continua.');
                return;
            }
            const guestsValue = availabilityGuestsInput?.value?.trim() || '';
            const guests = parseInt(guestsValue, 10);
            if (!guestsValue || Number.isNaN(guests) || guests < 10) {
                window.alert('Introdu un număr de invitați (minim 10).');
                return;
            }
            const eventType = availabilityEventTypeSelect?.value || eventTypeOptions[0];
            createRequestFromModal({
                locationId: availabilityState.locationId,
                eventDate: new Date(availabilityState.selectedDate),
                guests,
                eventType
            });
            closeAvailabilityModal();
        });

        viewingModal?.addEventListener('click', (event) => {
            if (event.target === viewingModal) {
                closeViewingModal();
            }
        });
        viewingModalCloseBtn?.addEventListener('click', closeViewingModal);
        viewingCancelBtn?.addEventListener('click', (event) => {
            event.preventDefault();
            closeViewingModal();
        });
        viewingAddSlotBtn?.addEventListener('click', () => createViewingSuggestionSlot());
        viewingForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!viewingState.requestId || !viewingState.locationId) {
                return;
            }
            const dedupedIso = new Set();
            const requestedSlots = [];
            let hasInvalid = false;

            viewingSuggestionPickers.forEach(({ dateInput, timeSelect }) => {
                dateInput.classList.remove('is-invalid');
                timeSelect.classList.remove('is-invalid');
                const dateValue = dateInput.value?.trim() || '';
                const timeValue = timeSelect.value?.trim() || '';
                const combined = combineDateAndTime(dateValue, timeValue);
                if (!combined) {
                    hasInvalid = true;
                    if (!dateValue) {
                        dateInput.classList.add('is-invalid');
                        setTimeout(() => dateInput.classList.remove('is-invalid'), 1500);
                    }
                    if (!timeValue) {
                        timeSelect.classList.add('is-invalid');
                        setTimeout(() => timeSelect.classList.remove('is-invalid'), 1500);
                    }
                    return;
                }
                const slot = createSlotObject(combined);
                if (!slot?.iso) {
                    hasInvalid = true;
                    dateInput.classList.add('is-invalid');
                    timeSelect.classList.add('is-invalid');
                    setTimeout(() => {
                        dateInput.classList.remove('is-invalid');
                        timeSelect.classList.remove('is-invalid');
                    }, 1500);
                    return;
                }
                if (dedupedIso.has(slot.iso)) {
                    hasInvalid = true;
                    dateInput.classList.add('is-invalid');
                    timeSelect.classList.add('is-invalid');
                    setTimeout(() => {
                        dateInput.classList.remove('is-invalid');
                        timeSelect.classList.remove('is-invalid');
                    }, 1500);
                    return;
                }
                dedupedIso.add(slot.iso);
                requestedSlots.push(slot);
            });

            if (hasInvalid || requestedSlots.length < MIN_VIEWING_SLOTS) {
                window.alert(`Completează și validează cel puțin ${MIN_VIEWING_SLOTS} ${MIN_VIEWING_SLOTS === 1 ? 'interval' : 'intervale'} (maxim ${MAX_VIEWING_SLOTS}) înainte de a trimite cererea.`);
                return;
            }

            const request = clientRequests.find(req => req.id === viewingState.requestId);
            if (!request) {
                closeViewingModal();
                return;
            }

            request.status = 'viewing_request';
            request.lastUpdate = new Date();
            request.requestedSlots = requestedSlots.slice();
            delete request.holdExpiresAt;
            viewingState.slots = requestedSlots.slice();

            let viewing = null;
            if (typeof request.viewingId === 'number') {
                viewing = clientViewings.find(view => view.id === request.viewingId) || null;
            }

            const firstSlot = requestedSlots[0] || null;
            const now = new Date();

            if (!viewing) {
                const nextViewingId = clientViewings.reduce((max, view) => Math.max(max, view.id), 0) + 1;
                viewing = {
                    id: nextViewingId,
                    locationId: viewingState.locationId,
                    status: 'viewing_request',
                    requestedSlots: requestedSlots.slice(),
                    ownerSuggestions: [],
                    confirmedSlot: null,
                    host: 'Echipa locației',
                    note: 'Locația verifică disponibilitatea pentru intervalele propuse.',
                    lastUpdate: now,
                    date: firstSlot?.date ? new Date(firstSlot.date.getTime()) : null,
                    hour: firstSlot?.date ? formatTime(firstSlot.date) : '—'
                };
                clientViewings.push(viewing);
                request.viewingId = viewing.id;
            } else {
                viewing.status = 'viewing_request';
                viewing.requestedSlots = requestedSlots.slice();
                viewing.ownerSuggestions = [];
                viewing.confirmedSlot = null;
                viewing.note = 'Locația verifică disponibilitatea pentru intervalele propuse.';
                viewing.lastUpdate = now;
                viewing.date = firstSlot?.date ? new Date(firstSlot.date.getTime()) : viewing.date;
                viewing.hour = firstSlot?.date ? formatTime(firstSlot.date) : viewing.hour;
            }

            const location = getLocationById(viewingState.locationId);
            const slotSummary = requestedSlots.map(slot => slot.label).join('; ');
            const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
            requestHistory.unshift({
                id: nextHistoryId,
                message: `Ai solicitat o vizionare la ${location?.name || 'locație'} pentru ${slotSummary || 'intervalele propuse'}.`,
                timestamp: now
            });

            closeViewingModal();
            renderRequests();
            renderViewingsTable();
            renderOverview();
            if (viewing) {
                navigateToItem('viewing', viewing.id);
            }
        });

        function createRequestFromModal({ locationId, eventDate, guests, eventType }) {
            const location = getLocationById(locationId);
            if (!location) {
                return;
            }
            const nextRequestId = clientRequests.reduce((max, req) => Math.max(max, req.id), 0) + 1;
            const newRequest = {
                id: nextRequestId,
                locationId,
                eventDate,
                guests,
                eventType,
                status: 'availability_request',
                lastUpdate: new Date()
            };
            clientRequests.unshift(newRequest);

            const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
            requestHistory.unshift({
                id: nextHistoryId,
                message: `Ai trimis o cerere pentru ${location.name}`,
                timestamp: new Date()
            });

            renderRequests();
            renderOverviewMetrics();
            renderOverviewRecentActivity();
            navigateToItem('request', newRequest.id);
        }

        function populateRequestFilters() {
            if (requestsStatusFilter) {
                const statusOptions = Object.entries(requestStatusMeta).map(([value, meta]) => ({ value, label: meta.label }));
                populateSelect(requestsStatusFilter, statusOptions, true, 'Toate statusurile');
            }
            if (requestsLocationFilter) {
                const locationNames = Array.from(new Set(clientRequests.map(req => getLocationById(req.locationId)?.name).filter(Boolean))).sort();
                populateSelect(requestsLocationFilter, locationNames, true, 'Toate locațiile');
            }
        }

        function renderRequestsLegend() {
            if (!requestsLegendEl) return;
            requestsLegendEl.innerHTML = '';
            Object.entries(requestStatusMeta).forEach(([status, meta]) => {
                const item = document.createElement('div');
                item.className = 'requests-legend-item';
                const dot = document.createElement('span');
                dot.className = 'legend-dot';
                dot.style.backgroundColor = meta.color || '#94a3b8';

                const content = document.createElement('div');
                content.className = 'requests-legend-item-content';
                const description = meta.description ? `<span>${meta.description}</span>` : '';
                const nextStep = meta.nextStep ? `<span>${meta.nextStep}</span>` : '';
                content.innerHTML = `<strong>${meta.label}</strong>${description}${nextStep}`;

                item.appendChild(dot);
                item.appendChild(content);
                requestsLegendEl.appendChild(item);
            });
        }

        function getRequestStatusLabel(status) {
            return requestStatusMeta[status]?.label || status || '';
        }

        function getViewingStatusLabel(status) {
            return viewingStatusMeta[status]?.label || status || '';
        }

        function renderRequests() {
            if (!requestsTableBody) return;
            requestsTableBody.innerHTML = '';

            const filtered = clientRequests
                .filter(req => {
                    const locationName = getLocationById(req.locationId)?.name || '';
                    const statusMatch = requestFilters.status === 'all' || req.status === requestFilters.status;
                    const locationMatch = requestFilters.location === 'all' || requestFilters.location === locationName;
                    return statusMatch && locationMatch;
                });

            const sorted = filtered.slice().sort((a, b) => {
                const sortMode = requestFilters.sort || 'event-date';
                if (sortMode === 'status-asc' || sortMode === 'status-desc') {
                    const labelA = getRequestStatusLabel(a.status);
                    const labelB = getRequestStatusLabel(b.status);
                    const compare = labelA.localeCompare(labelB, 'ro', { sensitivity: 'base' });
                    if (compare !== 0) {
                        return sortMode === 'status-asc' ? compare : -compare;
                    }
                    return a.eventDate - b.eventDate;
                }
                return a.eventDate - b.eventDate;
            });

            if (!sorted.length) {
                const emptyRow = requestsTableBody.insertRow();
                const emptyCell = emptyRow.insertCell();
                emptyCell.colSpan = 1;
                emptyCell.innerHTML = '<div class="empty-state">Nu există cereri care să corespundă filtrului selectat.</div>';
                renderOverviewMetrics();
                return;
            }

            sorted.forEach(req => {
                const location = getLocationById(req.locationId);
                const row = requestsTableBody.insertRow();
                row.dataset.id = req.id;

                const cell = row.insertCell();
                const wrapper = document.createElement('div');
                wrapper.className = 'booking-row';
                wrapper.dataset.requestId = String(req.id);

                const topRow = document.createElement('div');
                topRow.className = 'booking-row-top';
                topRow.appendChild(createInfoItem('Locație', location?.name || 'Locație necunoscută'));
                topRow.appendChild(createInfoItem('Tip eveniment', req.eventType || '—'));
                topRow.appendChild(createInfoItem('Dată eveniment', formatDate(req.eventDate)));
                const hasGuests = Number.isFinite(req.guests) && req.guests > 0;
                topRow.appendChild(createInfoItem('Invitați', hasGuests ? `${req.guests} invitați` : 'Necesită completare', { isMissing: !hasGuests }));
                topRow.appendChild(createInfoItem('Ultima actualizare', formatDate(req.lastUpdate)));
                const bottomRow = document.createElement('div');
                bottomRow.className = 'booking-row-bottom';

                const statusContainer = document.createElement('div');
                statusContainer.className = 'booking-row-status';
                statusContainer.appendChild(createStatusChip(req.status, requestStatusMeta));

                const isViewingStatus = ['viewing_request', 'viewing_rescheduled', 'viewing_scheduled'].includes(req.status);
                if (!isViewingStatus) {
                    const next = getRequestNextStep(req);
                    const nextStep = document.createElement('span');
                    nextStep.className = 'booking-row-next-step';
                    nextStep.textContent = next.detail || next.title || '—';
                    statusContainer.appendChild(nextStep);
                }
                bottomRow.appendChild(statusContainer);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'table-actions booking-row-actions';
                actionsDiv.innerHTML = '';
                actionsDiv.hidden = false;

                switch (req.status) {
                    case 'availability_request':
                        actionsDiv.innerHTML = `
                            <button data-request-action="cancel_request" data-request-id="${req.id}">Anulează cererea</button>
                        `;
                        break;
                    case 'availability_confirmed':
                        actionsDiv.innerHTML = `
                            <button data-request-action="request_offer" data-request-id="${req.id}">Cere ofertă</button>
                            <button data-request-action="request_viewing" data-request-id="${req.id}">Cere vizionare</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">Anulează cererea</button>
                        `;
                        break;
                    case 'offer_requested':
                        actionsDiv.innerHTML = `
                            <button data-request-action="cancel_request" data-request-id="${req.id}">Anulează cererea</button>
                        `;
                        break;
                    case 'offer_sent':
                        actionsDiv.innerHTML = `
                            <button data-request-action="view_offer" data-request-id="${req.id}">Vezi oferta</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">Anulează cererea</button>
                        `;
                        break;
                    case 'viewing_request':
                    case 'viewing_rescheduled':
                    case 'viewing_scheduled':
                        actionsDiv.innerHTML = `
                            <button data-request-action="view_viewing_details" data-request-id="${req.id}">Vezi detalii vizionare</button>
                        `;
                        break;
                    case 'pre_booked':
                        actionsDiv.innerHTML = `
                            <button data-request-action="release_hold" data-request-id="${req.id}">Renunță la rezervare</button>
                        `;
                        break;
                    case 'confirmed':
                        break;
                    case 'rejected':
                        actionsDiv.innerHTML = `
                            <button data-request-action="reopen_request" data-request-id="${req.id}">Trimite o nouă cerere</button>
                        `;
                        break;
                    case 'cancelled':
                        actionsDiv.innerHTML = `<button data-request-action="reopen_request" data-request-id="${req.id}">Retrimite cererea</button>`;
                        break;
                    default:
                        actionsDiv.innerHTML = `<button data-request-action="view_details" data-request-id="${req.id}">Vezi detalii</button>`;
                        break;
                }

                const detailButton = document.createElement('button');
                detailButton.type = 'button';
                detailButton.className = 'crm-button ghost crm-button--sm';
                detailButton.textContent = 'Deschide detalii cerere';
                detailButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    showRequestDetail(req);
                });
                actionsDiv.appendChild(detailButton);

                bottomRow.appendChild(actionsDiv);

                wrapper.append(topRow, bottomRow);
                cell.appendChild(wrapper);

                wrapper.addEventListener('click', (event) => {
                    if (event.target.closest('button')) {
                        return;
                    }
                    showRequestDetail(req);
                });
            });

            renderOverviewMetrics();
        }

        function handleRequestAction(event) {
            const button = event.target.closest('button[data-request-action]');
            if (!button) return;
            const action = button.dataset.requestAction;
            const requestId = parseInt(button.dataset.requestId, 10);
            const request = clientRequests.find(req => req.id === requestId);
            if (!request) return;

            switch (action) {
                case 'view_offer':
                    request.lastUpdate = new Date();
                    showRequestDetail(request);
                    break;
                case 'view_viewing_details':
                    {
                        const targetViewing = (() => {
                            if (typeof request.viewingId === 'number') {
                                const linked = clientViewings.find(view => view.id === request.viewingId);
                                if (linked) return linked;
                            }
                            return clientViewings.find(view =>
                                view.locationId === request.locationId &&
                                view.status === request.status);
                        })();
                        if (targetViewing) {
                            navigateToItem('viewing', targetViewing.id);
                        } else {
                            window.alert('Detaliile vizionării nu sunt disponibile încă.');
                        }
                        return;
                    }
                case 'send_message':
                case 'ask_question':
                    request.lastUpdate = new Date();
                    break;
                case 'request_offer':
                    request.status = 'offer_requested';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'request_viewing':
                    if (request.status !== 'availability_confirmed') {
                        window.alert('Poți solicita o vizionare doar după confirmarea disponibilității.');
                        return;
                    }
                    openViewingModal(request, { presetSlots: request.requestedSlots || [] });
                    return;
                case 'cancel_request':
                    request.status = 'cancelled';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    delete request.offerValidUntil;
                    break;
                case 'reopen_request':
                    request.status = 'availability_request';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    delete request.offerValidUntil;
                    break;
                case 'accept_offer':
                    request.status = 'pre_booked';
                    request.lastUpdate = new Date();
                    request.holdExpiresAt = addDays(2);
                    delete request.offerValidUntil;
                    break;
                case 'release_hold':
                    request.status = 'availability_confirmed';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'cancel_viewing_request':
                    {
                        const now = new Date();
                        request.status = 'availability_confirmed';
                        request.lastUpdate = now;
                        request.requestedSlots = [];
                        delete request.holdExpiresAt;
                        const relatedViewing = request.viewingId
                            ? clientViewings.find(view => view.id === request.viewingId)
                            : null;
                        if (relatedViewing) {
                            relatedViewing.status = 'viewing_cancelled';
                            relatedViewing.lastUpdate = now;
                            relatedViewing.note = 'Ai anulat cererea de vizionare.';
                            relatedViewing.requestedSlots = [];
                            relatedViewing.ownerSuggestions = [];
                            relatedViewing.confirmedSlot = null;
                        }
                        const location = getLocationById(request.locationId);
                        const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
                        requestHistory.unshift({
                            id: nextHistoryId,
                            message: `Ai anulat cererea de vizionare pentru ${location?.name || 'locație'}.`,
                            timestamp: now
                        });
                        delete request.viewingId;
                        delete request.confirmedSlot;
                    }
                    break;
                case 'add_to_calendar':
                    window.alert('Exportul în calendar va fi disponibil în curând.');
                    request.lastUpdate = new Date();
                    break;
                case 'cancel_viewing':
                    {
                        const now = new Date();
                        request.status = 'availability_confirmed';
                        request.lastUpdate = now;
                        delete request.holdExpiresAt;
                        const relatedViewing = request.viewingId
                            ? clientViewings.find(view => view.id === request.viewingId)
                            : null;
                        if (relatedViewing) {
                            relatedViewing.status = 'viewing_cancelled';
                            relatedViewing.lastUpdate = now;
                            relatedViewing.note = 'Ai anulat vizionarea confirmată.';
                            relatedViewing.confirmedSlot = null;
                        }
                        const location = getLocationById(request.locationId);
                        const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
                        requestHistory.unshift({
                            id: nextHistoryId,
                            message: `Ai anulat vizionarea confirmată la ${location?.name || 'locație'}.`,
                            timestamp: now
                        });
                        delete request.viewingId;
                        delete request.confirmedSlot;
                    }
                    break;
                case 'accept_reschedule':
                    if (typeof request.viewingId === 'number') {
                        navigateToItem('viewing', request.viewingId);
                        renderReschedulePanel(request.viewingId);
                        reschedulePanel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return;
                    }
                    break;
                case 'decline_reschedule':
                    {
                        const now = new Date();
                        request.status = 'viewing_request';
                        request.lastUpdate = now;
                        request.ownerSuggestions = [];
                        const relatedViewing = request.viewingId
                            ? clientViewings.find(view => view.id === request.viewingId)
                            : null;
                        if (relatedViewing) {
                            relatedViewing.ownerSuggestions = [];
                            relatedViewing.lastUpdate = now;
                            relatedViewing.note = 'Propune noi intervale pentru a continua.';
                            openViewingModal(request, { presetSlots: relatedViewing.requestedSlots });
                        } else {
                            openViewingModal(request, { presetSlots: request.requestedSlots || [] });
                        }
                        break;
                    }
                case 'view_details':
                    request.lastUpdate = new Date();
                    showRequestDetail(request);
                    break;
                default:
                    break;
            }

            renderRequests();
            renderOverviewRecentActivity();
            renderOverviewMetrics();
        }

        function populateViewingFilters() {
            if (viewingsVenueFilter) {
                const venues = Array.from(new Set(clientViewings.map(view => getLocationById(view.locationId)?.name).filter(Boolean))).sort();
                populateSelect(viewingsVenueFilter, venues, true, 'Toate locațiile');
            }
            if (viewingsStatusFilter) {
                const statusOptions = Object.entries(viewingStatusMeta).map(([value, meta]) => ({ value, label: meta.label }));
                populateSelect(viewingsStatusFilter, statusOptions, true, 'Toate statusurile');
            }
        }

        function getPendingRescheduleViewing() {
            return clientViewings.find(view =>
                view.status === 'viewing_rescheduled' &&
                Array.isArray(view.ownerSuggestions) &&
                view.ownerSuggestions.length);
        }

        function renderReschedulePanel(targetId = null) {
            if (!reschedulePanel) {
                return;
            }
            const pendingViewing = targetId
                ? clientViewings.find(view => view.id === targetId)
                : getPendingRescheduleViewing();
            const hasSuggestions = pendingViewing && Array.isArray(pendingViewing.ownerSuggestions) && pendingViewing.ownerSuggestions.length;
            if (!pendingViewing || !hasSuggestions) {
                reschedulePanel.hidden = true;
                activeRescheduleViewingId = null;
                selectedRescheduleOption = null;
                if (rescheduleOptionsContainer) {
                    rescheduleOptionsContainer.innerHTML = '';
                }
                if (rescheduleAcceptBtn) {
                    rescheduleAcceptBtn.disabled = true;
                }
                return;
            }

            reschedulePanel.hidden = false;
            const location = getLocationById(pendingViewing.locationId);
            activeRescheduleViewingId = pendingViewing.id;
            selectedRescheduleOption = null;

            if (rescheduleLocationEl) {
                rescheduleLocationEl.textContent = location?.name || 'Locație necunoscută';
            }
            if (rescheduleUpdatedEl) {
                rescheduleUpdatedEl.textContent = `Actualizat ${formatRelativeTime(pendingViewing.lastUpdate) || 'recent'}`;
            }
            if (rescheduleMessageEl) {
                rescheduleMessageEl.textContent = pendingViewing.note
                    ? `${pendingViewing.note} Selectează intervalul potrivit pentru tine.`
                    : 'Selectează intervalul potrivit pentru tine sau cere o altă propunere.';
            }

            if (rescheduleOptionsContainer) {
                rescheduleOptionsContainer.innerHTML = '';
                pendingViewing.ownerSuggestions.forEach((suggestion, index) => {
                    const candidateDate = suggestion?.date instanceof Date && !Number.isNaN(suggestion.date.getTime())
                        ? suggestion.date
                        : (suggestion?.iso ? new Date(suggestion.iso) : null);
                    const labelText = suggestion?.label || (candidateDate ? formatDateTime(candidateDate) : `Variantă ${index + 1}`);
                    const optionWrapper = document.createElement('label');
                    optionWrapper.className = 'reschedule-option';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'reschedule-option';
                    input.value = suggestion?.iso || `option-${index}`;
                    input.dataset.index = String(index);

                    const content = document.createElement('div');
                    content.className = 'reschedule-option-content';
                    const main = document.createElement('span');
                    main.className = 'reschedule-option-main';
                    main.textContent = labelText;
                    const meta = document.createElement('span');
                    meta.className = 'reschedule-option-meta';
                    meta.textContent = location?.name || 'Locație';
                    content.append(main, meta);

                    input.addEventListener('change', () => {
                        selectedRescheduleOption = {
                            ...suggestion,
                            date: candidateDate || new Date()
                        };
                        Array.from(rescheduleOptionsContainer.querySelectorAll('.reschedule-option')).forEach(option => option.classList.remove('is-selected'));
                        optionWrapper.classList.add('is-selected');
                        if (rescheduleAcceptBtn) {
                            rescheduleAcceptBtn.disabled = false;
                        }
                    });

                    optionWrapper.append(input, content);
                    rescheduleOptionsContainer.appendChild(optionWrapper);
                });
            }

            if (rescheduleAcceptBtn) {
                rescheduleAcceptBtn.disabled = true;
            }
        }

        function acceptRescheduleSelection() {
            if (!activeRescheduleViewingId || !selectedRescheduleOption) {
                return;
            }
            const viewing = clientViewings.find(view => view.id === activeRescheduleViewingId);
            if (!viewing) {
                return;
            }
            const chosenDate = selectedRescheduleOption.date instanceof Date && !Number.isNaN(selectedRescheduleOption.date.getTime())
                ? new Date(selectedRescheduleOption.date.getTime())
                : (selectedRescheduleOption.iso ? new Date(selectedRescheduleOption.iso) : null);
            if (chosenDate && !Number.isNaN(chosenDate.getTime())) {
                viewing.date = chosenDate;
                viewing.hour = formatTime(chosenDate);
            }
            const confirmedSlot = createSlotObject(chosenDate || new Date());
            viewing.status = 'viewing_scheduled';
            viewing.lastUpdate = new Date();
            viewing.note = 'Ai confirmat intervalul propus de locație.';
            viewing.ownerSuggestions = [];
            viewing.confirmedSlot = confirmedSlot;
            const relatedRequest = findRequestByViewingId(viewing.id);
            if (relatedRequest) {
                relatedRequest.status = 'viewing_scheduled';
                relatedRequest.lastUpdate = new Date();
                relatedRequest.confirmedSlot = confirmedSlot;
                relatedRequest.ownerSuggestions = [];
            }
            const location = getLocationById(viewing.locationId);
            const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
            requestHistory.unshift({
                id: nextHistoryId,
                message: `Ai confirmat vizionarea la ${location?.name || 'locație'} pentru ${confirmedSlot?.label || 'intervalul ales'}.`,
                timestamp: new Date()
            });
            selectedRescheduleOption = null;
            renderReschedulePanel();
            renderViewingsTable();
            renderOverview();
            reschedulePanel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function declineRescheduleSelection() {
            if (!activeRescheduleViewingId) {
                return;
            }
            const viewing = clientViewings.find(view => view.id === activeRescheduleViewingId);
            if (!viewing) {
                return;
            }
            selectedRescheduleOption = null;
            viewing.ownerSuggestions = [];
            viewing.lastUpdate = new Date();
            viewing.note = 'Trimite alte intervale pentru a continua programarea.';
            const relatedRequest = findRequestByViewingId(viewing.id);
            if (relatedRequest) {
                relatedRequest.ownerSuggestions = [];
                relatedRequest.lastUpdate = new Date();
            }
            renderReschedulePanel();
            renderViewingsTable();
            renderOverview();
            if (relatedRequest) {
                openViewingModal(relatedRequest, { presetSlots: viewing.requestedSlots });
            } else {
                openViewingModal({
                    id: viewing.id,
                    locationId: viewing.locationId,
                    viewingId: viewing.id,
                    requestedSlots: viewing.requestedSlots
                }, { presetSlots: viewing.requestedSlots });
            }
        }

        function renderViewingsTable() {
            if (!viewingsTableBody) return;
            viewingsTableBody.innerHTML = '';

            const enhanced = clientViewings
                .map(view => {
                    const requestedSlots = mapSlots(view.requestedSlots);
                    const ownerSuggestions = mapSlots(view.ownerSuggestions);
                    const confirmedSlot = mapSlots([view.confirmedSlot])[0] || null;
                    const primarySlot = getViewingPrimarySlot(view);
                    const sortTime = primarySlot?.date
                        ? primarySlot.date.getTime()
                        : (view.date instanceof Date ? view.date.getTime() : Number.MAX_SAFE_INTEGER);
                    return { view, requestedSlots, ownerSuggestions, confirmedSlot, primarySlot, sortTime };
                })
                .filter(({ view }) => {
                    const venueName = getLocationById(view.locationId)?.name || '';
                    const statusMatch = viewingFilters.status === 'all' || view.status === viewingFilters.status;
                    const venueMatch = viewingFilters.venue === 'all' || viewingFilters.venue === venueName;
                    return statusMatch && venueMatch;
                });

            const sorted = enhanced.slice().sort((a, b) => {
                const sortMode = viewingFilters.sort || 'primary-date';
                if (sortMode === 'status-asc' || sortMode === 'status-desc') {
                    const labelA = getViewingStatusLabel(a.view.status);
                    const labelB = getViewingStatusLabel(b.view.status);
                    const compare = labelA.localeCompare(labelB, 'ro', { sensitivity: 'base' });
                    if (compare !== 0) {
                        return sortMode === 'status-asc' ? compare : -compare;
                    }
                    return (a.sortTime || 0) - (b.sortTime || 0);
                }
                return (a.sortTime || 0) - (b.sortTime || 0);
            });

            if (!sorted.length) {
                const emptyRow = viewingsTableBody.insertRow();
                const emptyCell = emptyRow.insertCell();
                emptyCell.colSpan = 1;
                emptyCell.innerHTML = '<div class="empty-state">Nu ai vizionări care să corespundă filtrului selectat.</div>';
                renderOverviewViewingsList();
                renderReschedulePanel();
                return;
            }

            sorted.forEach(({ view, requestedSlots, ownerSuggestions, confirmedSlot, primarySlot }) => {
                const location = getLocationById(view.locationId);
                const row = viewingsTableBody.insertRow();
                row.dataset.id = view.id;

                const cell = row.insertCell();
                const wrapper = document.createElement('div');
                wrapper.className = 'booking-row viewing-row';

                const topRow = document.createElement('div');
                topRow.className = 'booking-row-top';
                topRow.appendChild(createInfoItem('Locație', location?.name || 'Locație necunoscută'));
                topRow.appendChild(createInfoItem('Interval principal', primarySlot ? primarySlot.label : '—'));
                topRow.appendChild(createInfoItem('Ultima actualizare', formatDate(view.lastUpdate), {
                    meta: formatRelativeTime(view.lastUpdate) ? `Actualizat ${formatRelativeTime(view.lastUpdate)}` : null
                }));
                wrapper.appendChild(topRow);

                const bottomRow = document.createElement('div');
                bottomRow.className = 'booking-row-bottom';

                const statusContainer = document.createElement('div');
                statusContainer.className = 'booking-row-status';
                statusContainer.appendChild(createStatusChip(view.status, viewingStatusMeta));
                if (view.note) {
                    const noteEl = document.createElement('span');
                    noteEl.className = 'booking-row-meta';
                    noteEl.textContent = view.note;
                    statusContainer.appendChild(noteEl);
                }
                if (view.status === 'viewing_request' && requestedSlots.length) {
                    const metaEl = document.createElement('span');
                    metaEl.className = 'booking-row-meta';
                    metaEl.textContent = `Preferințe trimise: ${requestedSlots.map(slot => slot.label).join(' • ')}`;
                    statusContainer.appendChild(metaEl);
                }
                if (view.status === 'viewing_scheduled' && confirmedSlot) {
                    const confirmedEl = document.createElement('span');
                    confirmedEl.className = 'booking-row-meta';
                    confirmedEl.textContent = `Interval confirmat: ${confirmedSlot.label}`;
                    statusContainer.appendChild(confirmedEl);
                }
                bottomRow.appendChild(statusContainer);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'table-actions booking-row-actions';
                switch (view.status) {
                    case 'viewing_request':
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="edit_slots" data-viewing-id="${view.id}">Editează propunerile</button>
                            <button data-viewing-action="cancel_request" data-viewing-id="${view.id}">Anulează cererea</button>
                        `;
                        break;
                    case 'viewing_rescheduled':
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="open_reschedule" data-viewing-id="${view.id}">Vezi propunerile</button>
                            <button data-viewing-action="request_reschedule" data-viewing-id="${view.id}">Propune altă dată</button>
                        `;
                        break;
                    case 'viewing_scheduled':
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="add_to_calendar" data-viewing-id="${view.id}">Adaugă în calendar</button>
                            <button data-viewing-action="request_reschedule" data-viewing-id="${view.id}">Solicită reprogramare</button>
                        `;
                        break;
                    case 'viewing_completed':
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="download_materials" data-viewing-id="${view.id}">Vezi rezumatul</button>
                            <button data-viewing-action="add_review" data-viewing-id="${view.id}">Scrie feedback</button>
                        `;
                        break;
                    case 'viewing_rejected':
                    case 'viewing_cancelled':
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="open_reschedule" data-viewing-id="${view.id}">Vezi detalii</button>
                        `;
                        break;
                    default:
                        actionsDiv.innerHTML = `
                            <button data-viewing-action="open_reschedule" data-viewing-id="${view.id}">Vezi detalii</button>
                        `;
                        break;
                }
                if (actionsDiv.children.length) {
                    bottomRow.appendChild(actionsDiv);
                }

                wrapper.appendChild(bottomRow);
                cell.appendChild(wrapper);
            });

            renderOverviewViewingsList();
            renderReschedulePanel();
        }
        
        function handleViewingAction(event) {
            const button = event.target.closest('button[data-viewing-action]');
            let viewingId = NaN;
            if (button) {
                viewingId = parseInt(button.dataset.viewingId, 10);
            } else {
                const row = event.target.closest('tr[data-id]');
                viewingId = row ? parseInt(row.dataset.id, 10) : NaN;
            }
            const viewing = clientViewings.find(v => v.id === viewingId);
            if (!viewing) {
                return;
            }
            const request = findRequestByViewingId(viewing.id);

            if (!button) {
                if (request) {
                    showRequestDetail(request);
                } else {
                    activatePage('viewings');
                }
                return;
            }

            const action = button.dataset.viewingAction;
            const location = getLocationById(viewing.locationId);
            const now = new Date();

            switch (action) {
                case 'edit_slots':
                case 'request_reschedule':
                    if (request) {
                        openViewingModal(request, { presetSlots: viewing.requestedSlots });
                    } else {
                        openViewingModal({
                            id: viewingId,
                            locationId: viewing.locationId,
                            viewingId: viewing.id,
                            requestedSlots: viewing.requestedSlots
                        }, { presetSlots: viewing.requestedSlots });
                    }
                    return;
                case 'open_reschedule':
                    renderReschedulePanel(viewingId);
                    reschedulePanel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                case 'cancel_request': {
                    viewing.status = 'viewing_cancelled';
                    viewing.lastUpdate = now;
                    viewing.note = 'Ai anulat cererea de vizionare.';
                    viewing.requestedSlots = [];
                    viewing.ownerSuggestions = [];
                    viewing.confirmedSlot = null;
                    if (request) {
                        request.status = 'availability_confirmed';
                        request.lastUpdate = now;
                        request.requestedSlots = [];
                        request.ownerSuggestions = [];
                        delete request.viewingId;
                        delete request.confirmedSlot;
                    }
                    const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
                    requestHistory.unshift({
                        id: nextHistoryId,
                        message: `Ai anulat cererea de vizionare pentru ${location?.name || 'locație'}.`,
                        timestamp: now
                    });
                    break;
                }
                case 'add_to_calendar':
                    window.alert('Exportul în calendar va fi disponibil în curând.');
                    viewing.lastUpdate = now;
                    break;
                case 'download_materials':
                    viewing.lastUpdate = now;
                    break;
                case 'add_review':
                    viewing.lastUpdate = now;
                    break;
                default:
                    break;
            }

            renderViewingsTable();
            renderOverview();
        }

        function renderMessages() {
            if (!messagesList) return;
            messagesList.innerHTML = '';
            if (!clientMessages.length) {
                messagesList.innerHTML = '<div class="empty-state">Nu ai niciun mesaj.</div>';
                return;
            }

            clientMessages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <strong>${msg.locationName}</strong>
                        <span style="display: block; color: var(--dark-color);">${msg.subject}</span>
                        <span style="color: var(--muted-color);">${msg.lastMessage}</span>
                    </div>
                    <div style="text-align: right;">
                        <span class="panel-meta">${msg.time}</span>
                        ${msg.unread ? '<span class="message-badge">Nou</span>' : ''}
                    </div>
                `;
                messagesList.appendChild(item);
            });
        }

        function attachEventListeners() {
            requestDetailElements.backButton?.addEventListener('click', () => {
                const lastId = activeRequestDetailId;
                activatePage('requests');
                if (requestDetailElements.body) {
                    requestDetailElements.body.hidden = true;
                }
                if (requestDetailElements.footer) {
                    requestDetailElements.footer.hidden = true;
                }
                if (requestDetailElements.empty) {
                    requestDetailElements.empty.hidden = false;
                }
                activeRequestDetailId = null;
                if (Number.isFinite(lastId)) {
                    requestAnimationFrame(() => navigateToItem('request', lastId));
                }
            });
            requestsStatusFilter?.addEventListener('change', (event) => {
                requestFilters.status = event.target.value;
                renderRequests();
            });
            requestsLocationFilter?.addEventListener('change', (event) => {
                requestFilters.location = event.target.value;
                renderRequests();
            });
            requestsSortSelect?.addEventListener('change', (event) => {
                requestFilters.sort = event.target.value;
                renderRequests();
            });
            requestsTableBody?.addEventListener('click', handleRequestAction);

            viewingsVenueFilter?.addEventListener('change', (event) => {
                viewingFilters.venue = event.target.value;
                renderViewingsTable();
            });
            viewingsStatusFilter?.addEventListener('change', (event) => {
                viewingFilters.status = event.target.value;
                renderViewingsTable();
            });
            viewingsSortSelect?.addEventListener('change', (event) => {
                viewingFilters.sort = event.target.value;
                renderViewingsTable();
            });
            viewingsTableBody?.addEventListener('click', handleViewingAction);
            rescheduleAcceptBtn?.addEventListener('click', acceptRescheduleSelection);
            rescheduleDeclineBtn?.addEventListener('click', declineRescheduleSelection);
        }

        populateRequestFilters();
        populateViewingFilters();

        renderOverview();
        renderFavorites();
        renderRequests();
        renderViewingsTable();

        attachEventListeners();
    });
    </script>
</body>
</html>
