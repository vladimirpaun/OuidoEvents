<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ouidoEvents · Dashboard Client</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #0052D4;
            --secondary-color: #4364F7;
            --accent-color: #00B4D8;
            --dark-color: #1a202c;
            --gray-color: #555555;
            --muted-color: #7a7f87;
            --light-gray-color: #f0f2f5;
            --bg-color: #f8f9fa;
            --white-color: #ffffff;
            --border-color: #e5eaf1;
            --shadow-color: rgba(67, 100, 247, 0.15);
            --border-radius: 16px;
            --sidebar-width: 296px;
            --header-height: 74px;
        }


                .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; min-height: 100vh; font-family: 'Inter', sans-serif; color: var(--dark-color); background-color: var(--bg-color); line-height: 1.5; }
        a { color: inherit; text-decoration: none; }
        button { font: inherit; }

        /* --- Layout Shell --- */
        main.crm-shell { display: grid; grid-template-columns: var(--sidebar-width) 1fr; min-height: calc(100vh - var(--header-height)); background: linear-gradient(135deg, rgba(67, 100, 247, 0.06), rgba(0, 82, 212, 0.02)); }
        .crm-sidebar { position: sticky; top: var(--header-height); height: calc(100vh - var(--header-height)); background: var(--white-color); border-right: 1px solid var(--border-color); padding: 32px 26px; display: flex; flex-direction: column; gap: 28px; }
        .crm-sidebar h2 { font-size: 1.25rem; margin: 0 0 6px; }
        .crm-sidebar p { color: var(--muted-color); font-size: 0.92rem; margin: 0; }
        .crm-nav { display: flex; flex-direction: column; gap: 24px; }
        .crm-nav-section label { font-size: 0.78rem; font-weight: 600; color: var(--muted-color); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 10px; display: block; }
        .crm-nav-links { display: flex; flex-direction: column; gap: 8px; }
        .crm-nav-link { width: 100%; border: 1px solid transparent; border-radius: 14px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: var(--gray-color); font-weight: 500; background: transparent; cursor: pointer; transition: all 0.2s ease; }
        .crm-nav-link svg { width: 18px; height: 18px; opacity: 0.7; }
        .crm-nav-link:hover, .crm-nav-link.is-active { background: rgba(67, 100, 247, 0.1); border-color: rgba(0, 82, 212, 0.24); color: var(--primary-color); box-shadow: inset 0 0 0 1px rgba(0, 82, 212, 0.18); }
        .crm-sidebar-footer { margin-top: auto; background: rgba(0, 82, 212, 0.08); border-radius: 16px; padding: 18px; }
        .crm-sidebar-footer h3 { font-size: 0.96rem; margin: 0 0 4px; }
        .crm-sidebar-footer p { font-size: 0.85rem; margin-bottom: 10px; }
        .crm-sidebar-footer a { display: inline-flex; gap: 8px; align-items: center; font-weight: 600; color: var(--primary-color); font-size: 0.9rem; }

        /* --- Pages & Content --- */
        .crm-pages { padding: calc(var(--header-height) - 40px) 40px 40px; display: flex; flex-direction: column; gap: 36px; }
        .crm-page { display: none; flex-direction: column; gap: 28px; animation: fadeIn 0.24s ease; }
        .crm-page.is-active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Componente comune --- */
        .page-header { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 28px 32px; box-shadow: 0 28px 50px -48px rgba(67, 100, 247, 0.8); display: flex; flex-direction: column; gap: 18px; }
        .page-header h1 { font-size: 1.8rem; margin: 0 0 4px; }
        .page-header p { margin: 0; color: var(--muted-color); max-width: 520px; font-size: 0.95rem; }
        .panel { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 26px 28px; display: flex; flex-direction: column; gap: 18px; box-shadow: 0 30px 48px -52px rgba(67, 100, 247, 0.85); }
        .panel header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap; }
        .panel header h2 { margin: 0; font-size: 1.1rem; }
        .panel-meta { color: var(--muted-color); font-size: 0.82rem; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .panel-grid .panel { height: 100%; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 18px; }
        .metric-card { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 22px; display: flex; flex-direction: column; gap: 10px; }
        .metric-card span { color: var(--muted-color); font-size: 0.85rem; }
        .metric-card strong { font-size: 1.6rem; }
        .list { display: flex; flex-direction: column; gap: 12px; }
        .list-item { display: flex; justify-content: space-between; gap: 16px; border-bottom: 1px solid rgba(0, 82, 212, 0.08); padding-bottom: 12px; }
        .list-item:last-child { border-bottom: none; padding-bottom: 0; }
        /* NOU: Ajustare dimensiune font pentru textul din liste */
        .list-item > div {
            font-size: 0.9rem;
        }
        .status-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .status-chip[data-status="pending"] { background: rgba(245, 158, 11, 0.15); color: #b45309; }
        .status-chip[data-status="confirmed"] { background: rgba(22, 163, 74, 0.15); color: #15803d; }
        .status-chip[data-status="pending"] { background: rgba(245, 158, 11, 0.15); color: #b45309; }
        .status-chip[data-status="offer_sent"] { background: rgba(139, 92, 246, 0.15); color: #7c3aed; }
        .status-chip[data-status="cancelled"] { background: rgba(239, 68, 68, 0.15); color: #dc2626; }
        .status-chip[data-status="awaiting_confirmation"] { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .status-chip[data-status="reschedule_pending"] { background: rgba(249, 115, 22, 0.15); color: #c2410c; }
        .status-chip[data-status="due"] { background: rgba(248, 113, 113, 0.18); color: #b91c1c; }
        .status-chip[data-status="upcoming"] { background: rgba(45, 212, 191, 0.18); color: #0f766e; }
        .status-chip[data-status="completed"] { background: rgba(129, 199, 132, 0.2); color: #166534; }
        .crm-button { border-radius: 999px; padding: 10px 22px; border: 1px solid transparent; font-weight: 600; font-size: 0.95rem; cursor: pointer; }
        .crm-button.primary { background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); color: var(--white-color); }
        .crm-button.ghost { background: transparent; border-color: rgba(0, 82, 212, 0.2); color: var(--primary-color); }
        .crm-button.danger { background: linear-gradient(135deg, #f56565, #c53030); color: var(--white-color); }
        .crm-button--sm { padding: 8px 18px; font-size: 0.85rem; }

        .settings-overview { display: flex; flex-direction: column; gap: 0; padding: 20px 24px; }
        .settings-overview-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .settings-overview-copy { flex: 1 1 260px; display: flex; flex-direction: column; gap: 8px; }
        .settings-overview h1 { margin: 0; font-size: 1.55rem; }
        .settings-overview p { margin: 0; color: var(--muted-color); max-width: 620px; }
        .settings-overview-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-left: auto; }
        .settings-overview-actions .crm-button { flex: 0 0 auto; }

        .settings-section-label { font-size: 0.78rem; font-weight: 600; color: var(--muted-color); text-transform: uppercase; letter-spacing: 0.12em; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; align-items: stretch; }
        .settings-card { background: var(--white-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 24px 26px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 30px 48px -52px rgba(67, 100, 247, 0.75); height: 100%; }
        .settings-card header { display: flex; flex-direction: column; gap: 6px; }
        .settings-card header h2 { margin: 0; font-size: 1.15rem; }
        .settings-card header .panel-meta { font-size: 0.85rem; }
        .settings-fields { display: grid; gap: 16px; }
        .settings-field { display: flex; flex-direction: column; gap: 6px; }
        .settings-field label { font-weight: 600; font-size: 0.88rem; color: var(--dark-color); }
        .settings-field input, .settings-field select { border-radius: 10px; border: 1px solid rgba(0, 82, 212, 0.16); padding: 10px 12px; font: inherit; font-size: 0.92rem; background: var(--white-color); }
        .settings-field input::placeholder { color: var(--muted-color); }
        .settings-field--static { gap: 8px; }
        .settings-static-value { border-radius: 10px; border: 1px dashed rgba(0, 82, 212, 0.25); background: rgba(67, 100, 247, 0.05); padding: 10px 12px; font-weight: 600; font-size: 0.93rem; color: var(--dark-color); }
        .settings-toggles { display: flex; flex-direction: column; gap: 14px; }
        .settings-toggle { display: flex; align-items: center; justify-content: space-between; gap: 16px; border: 1px solid rgba(0, 82, 212, 0.08); border-radius: 14px; padding: 14px 16px; background: rgba(67, 100, 247, 0.04); }
        .settings-toggle span { font-size: 0.92rem; font-weight: 500; color: var(--dark-color); }
        .settings-toggle small { display: block; font-size: 0.78rem; color: var(--muted-color); font-weight: 400; }
        .settings-toggle input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary-color); }
        .settings-card--full { grid-column: 1 / -1; }
        .settings-card-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; }
        .settings-card-actions .crm-button { flex: 0 0 auto; justify-content: center; display: inline-flex; }
        .settings-card-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .settings-card-footer .crm-button { flex: 0 0 auto; }
        .account-confirmation-modal { gap: 18px; }
        .account-confirmation-content { font-size: 0.92rem; color: var(--dark-color); line-height: 1.5; }
        .account-confirmation-footer { display: flex; justify-content: flex-end; gap: 12px; }

        @media (max-width: 768px) {
            .settings-overview { padding: 18px 20px; }
            .settings-overview-header { align-items: flex-start; }
            .settings-overview-actions { width: 100%; justify-content: flex-start; }
            .settings-grid { grid-template-columns: 1fr; }
        }

        /* --- Stiluri specifice paginii de client --- */
        .favorites-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
        .location-card { display: flex; flex-direction: column; background: var(--white-color); border-radius: var(--border-radius); overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .location-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px var(--shadow-color); }
        .location-image { height: 200px; background-size: cover; background-position: center; position: relative; }
        .remove-favorite-btn { position: absolute; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .remove-favorite-btn svg { width: 20px; height: 20px; fill: #ff4d4d; stroke: #ff4d4d; }
        .location-details { padding: 18px 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .location-details h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .location-details p { font-size: 0.88rem; color: var(--muted-color); margin-bottom: 15px; }
        .location-card-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .location-price { font-weight: 600; }

        .table-wrapper { width: 100%; overflow-x: auto; }
        table.crm-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        table.crm-table th, table.crm-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.82rem; }
        table.crm-table th { font-size: 0.74rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted-color); }
        table.crm-table tr.is-highlighted { background: rgba(0, 180, 216, 0.08); outline: 2px solid rgba(0, 180, 216, 0.35); }
        .table-actions { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-start; }
        .table-actions button { border-radius: 999px; border: 1px solid rgba(0, 82, 212, 0.2); background: transparent; color: var(--primary-color); padding: 4px 10px; font-size: 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
        .favorites-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(26, 32, 44, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .favorites-modal-overlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .favorites-modal {
            width: min(520px, 94vw);
            background: #fff;
            border-radius: 18px;
            padding: 28px 32px;
            box-shadow: 0 32px 60px -40px rgba(15, 23, 42, 0.45);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .favorites-modal header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .favorites-modal header h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        .favorites-modal-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--muted-color);
        }
        .favorites-modal form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .favorites-modal .form-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #availability-date-picker {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            border: 0;
            clip: rect(0 0 0 0);
            clip-path: inset(50%);
            overflow: hidden;
            white-space: nowrap;
        }
        .availability-calendar {
            display: flex;
            justify-content: center;
        }
        .availability-calendar .flatpickr-calendar {
            box-shadow: 0 18px 44px -32px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: 16px;
            padding: 16px 20px;
            overflow: visible;
            min-width: 360px;
        }
        .availability-calendar .flatpickr-day {
            width: 48px;
            height: 44px;
            font-size: 0.95rem;
        }
        .favorites-modal .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        .favorites-modal label {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .availability-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: var(--muted-color);
            justify-content: center;
        }
        .availability-legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 4px;
            margin-right: 6px;
        }
        .availability-legend-dot--available { background: rgba(59, 130, 246, 0.18); }
        .availability-legend-dot--hold { background: rgba(245, 158, 11, 0.25); }
        .availability-legend-dot--booked { background: rgba(239, 68, 68, 0.3); }
        .favorites-modal input,
        .favorites-modal select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font-size: 0.9rem;
        }
        .flatpickr-calendar {
            box-shadow: 0 24px 60px -34px rgba(15, 23, 42, 0.35);
            border-radius: 16px;
        }
        .flatpickr-calendar {
            box-shadow: 0 24px 60px -34px rgba(15, 23, 42, 0.35);
            border-radius: 16px;
            background: #fff;
        }
        .flatpickr-calendar .flatpickr-months,
        .flatpickr-calendar .flatpickr-weekdays {
            background: #fff;
        }
        .flatpickr-calendar .flatpickr-monthDropdown-months,
        .flatpickr-calendar .numInputWrapper {
            font-size: 0.85rem;
        }
        .flatpickr-day {
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flatpickr-day.availability-day-available:hover {
            background: rgba(59, 130, 246, 0.12);
        }
        .flatpickr-day.availability-day-hold {
            background: rgba(245, 158, 11, 0.25);
            color: #b45309;
        }
        .flatpickr-day.availability-day-booked {
            background: rgba(239, 68, 68, 0.3);
            color: #b91c1c;
        }
        .flatpickr-day.flatpickr-disabled {
            cursor: not-allowed;
        }
        .favorites-modal footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .filter-bar { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .filter-bar label { font-weight: 600; font-size: 0.9rem; }
        .filter-bar select { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border-color); font: inherit; font-size: 0.9rem; background: var(--white-color); }
        .requests-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px 18px; margin: 12px 0 4px; }
        .requests-legend-item { display: flex; align-items: flex-start; gap: 12px; font-size: 0.85rem; color: var(--gray-color); }
        .requests-legend-item .legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
        .requests-legend-item-content { display: flex; flex-direction: column; gap: 2px; }
        .requests-legend-item-content strong { color: var(--dark-color); font-size: 0.88rem; }
        .requests-legend-item-content span { font-size: 0.78rem; color: var(--muted-color); }
        .empty-state { text-align: center; color: var(--muted-color); padding: 24px; border-radius: var(--border-radius); background: rgba(0, 82, 212, 0.04); }
        .note-card { display: flex; flex-direction: column; gap: 6px; border-bottom: 1px solid rgba(0, 82, 212, 0.08); padding-bottom: 14px; }
        .note-card:last-child { border-bottom: none; padding-bottom: 0; }
        .next-step-cell { display: flex; flex-direction: column; gap: 4px; }
        .next-step-cell strong { font-size: 0.9rem; color: var(--dark-color); }
        .next-step-cell span { font-size: 0.78rem; color: var(--muted-color); }

        /* NOU: Stil pentru elementele interactive din liste */
        .list-item.is-interactive {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item.is-interactive:hover { background-color: rgba(0, 82, 212, 0.04); }

        /* Responsive */
        @media (max-width: 1180px) {
            main.crm-shell { grid-template-columns: 1fr; }
            .crm-sidebar { position: relative; top: 0; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); }
            .crm-pages { padding: 36px 24px 48px; }
        }
        @media (max-width: 720px) {
            .crm-pages { padding: 28px 16px 40px; }
            .page-header { padding: 22px; }
        }
    </style>
</head>
<body>
    <div data-include="header.html"></div>
    <div data-include="mobile-menu.html"></div>

    <main class="crm-shell">
        <aside class="crm-sidebar">
            <div>
                <h2>Contul meu</h2>
                <p>Bun venit, Alex! Gestionează-ți cererile și locațiile favorite.</p>
            </div>

            <nav class="crm-nav" aria-label="Navigare cont client">
                <div class="crm-nav-section">
                    <div class="crm-nav-links">
                        <button class="crm-nav-link is-active" type="button" data-page-target="overview">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2 7-7 7 7 2 2"/><path d="M5 10v10a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1V10"/></svg>
                            Dashboard
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="favorites">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            Locații Favorite
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="requests">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H9a2 2 0 0 1-2-2V7"/><path d="M9 17h10"/><path d="M13 11h6"/><path d="M5 3h14a2 2 0 0 1 2 2v12"/><polyline points="5 7 5 21 19 21"/></svg>
                            Cererile mele
                        </button>
                        <button class="crm-nav-link" type="button" data-page-target="viewings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 3H6a2 2 0 0 0-2 2v14l4-4h10a2 2 0 0 0 2-2z"/></svg>
                            Vizionările mele
                        </button>
                    </div>
                </div>
                <div class="crm-nav-section">
                    <label>Comunicare & control</label>
                    <div class="crm-nav-links">
                        <button class="crm-nav-link" type="button" data-page-target="settings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                            Setări
                        </button>
                    </div>
                </div>
            </nav>

            <div class="crm-sidebar-footer">
                <h3>Ai nevoie de ajutor?</h3>
                <p>Echipa noastră de suport este aici pentru a te ghida.</p>
                <a href="contact.html">Contactează-ne</a>
            </div>
        </aside>

        <section class="crm-pages">
            <!-- Pagina Overview -->
            <section class="crm-page is-active" data-page="overview">
                <div class="page-header">
                    <h1>Dashboard Client</h1>
                    <p>Vezi rapid statusul cererilor tale, locațiile favorite și ofertele primite de la proprietari.</p>
                </div>
                <div class="metrics-grid">
                    <article class="metric-card">
                        <span>Locații favorite</span>
                        <strong id="overview-favorites-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Cereri active</span>
                        <strong id="overview-requests-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Oferte primite</span>
                        <strong id="overview-offers-count">0</strong>
                    </article>
                    <article class="metric-card">
                        <span>Vizionări programate</span>
                        <strong id="overview-viewings-count">0</strong>
                    </article>
                </div>
                <div class="panel-grid">
                    <article class="panel">
                        <header><h2>Activitate recentă</h2></header>
                        <div class="list" id="overview-recent-activity"></div>
                    </article>
                </div>
                <article class="panel">
                    <header>
                        <h2>Vizionări confirmate</h2>
                        <span class="panel-meta">Programările pentru următoarele 14 zile</span>
                    </header>
                    <div class="list" id="overview-viewings-list"></div>
                </article>
            </section>

            <!-- Pagina Favorite -->
            <section class="crm-page" data-page="favorites">
                <div class="page-header">
                    <h1>Locațiile Tale Favorite</h1>
                    <p>Aici găsești toate locațiile pe care le-ai salvat. Compară-le și trimite cereri de disponibilitate.</p>
                </div>
                <div class="favorites-grid" id="favorites-grid">
                    <!-- Cardurile cu locații favorite vor fi generate aici -->
                </div>
            </section>

            <!-- Pagina Setări -->
            <section class="crm-page" data-page="settings">
                <article class="panel settings-overview">
                    <header class="settings-overview-header">
                        <div class="settings-overview-copy">
                            <h1>Setări și preferințe</h1>
                            <p>Actualizează informațiile de contact și personalizează notificările pentru a rămâne conectat cu echipa OuidoEvents.</p>
                        </div>
                        <div class="settings-overview-actions">
                            <button class="crm-button ghost" type="button">Resetează</button>
                            <button class="crm-button primary" type="button">Salvează modificări</button>
                        </div>
                    </header>
                </article>

                <span class="settings-section-label">Comunicare & control</span>
                <div class="settings-grid">
                    <section class="settings-card">
                        <header>
                            <h2>Detalii cont</h2>
                            <span class="panel-meta">Actualizează informațiile personale</span>
                        </header>
                        <div class="settings-fields">
                            <div class="settings-field settings-field--static">
                                <label for="settings-email">Adresă email</label>
                                <p id="settings-email" class="settings-static-value">alex.popescu@email.com</p>
                            </div>
                            <div class="settings-field">
                                <label for="settings-first-name">Prenume</label>
                                <input type="text" id="settings-first-name" name="first_name" placeholder="Alex">
                            </div>
                            <div class="settings-field">
                                <label for="settings-last-name">Nume</label>
                                <input type="text" id="settings-last-name" name="last_name" placeholder="Popescu">
                            </div>
                            <div class="settings-field">
                                <label for="settings-phone">Număr de telefon</label>
                                <input type="tel" id="settings-phone" name="phone" placeholder="07xx xxx xxx">
                            </div>
                            <div class="settings-field">
                                <label for="settings-gender">Gen <span class="panel-meta">(opțional)</span></label>
                                <select id="settings-gender" name="gender">
                                    <option value="">Selectează</option>
                                    <option value="feminin">Feminin</option>
                                    <option value="masculin">Masculin</option>
                                    <option value="altul">Altul</option>
                                    <option value="nu_spun">Prefer să nu spun</option>
                                </select>
                            </div>
                            <div class="settings-field">
                                <label for="settings-age">Vârstă <span class="panel-meta">(opțional)</span></label>
                                <input type="number" id="settings-age" name="age" min="18" max="120" placeholder="34">
                            </div>
                            <div class="settings-field">
                                <label for="settings-city">Oraș <span class="panel-meta">(opțional)</span></label>
                                <input type="text" id="settings-city" name="city" placeholder="București">
                            </div>
                        </div>
                        <div class="settings-card-footer">
                            <button class="crm-button primary" type="button">Salvează</button>
                        </div>
                    </section>

                    <section class="settings-card">
                        <header>
                            <h2>Notificări</h2>
                            <span class="panel-meta">Primește update-urile relevante</span>
                        </header>
                        <div class="settings-toggles">
                            <label class="settings-toggle" for="notif-viewings">
                                <span>
                                    Confirmări vizionări prin email
                                    <small>Te anunțăm imediat ce o locație confirmă sau repropune vizionarea.</small>
                                </span>
                                <input type="checkbox" id="notif-viewings" checked>
                            </label>
                            <label class="settings-toggle" for="notif-bookings">
                                <span>
                                    Confirmări booking prin email
                                    <small>Primești detalii despre rezervările aprobate și pașii următori.</small>
                                </span>
                                <input type="checkbox" id="notif-bookings" checked>
                            </label>
                            <label class="settings-toggle" for="notif-weekly">
                                <span>
                                    Rezumat săptămânal
                                    <small>Un digest cu cererile active, vizionările și ofertele primite.</small>
                                </span>
                                <input type="checkbox" id="notif-weekly">
                            </label>
                            <label class="settings-toggle" for="notif-insights">
                                <span>
                                    Recomandări personalizate
                                    <small>Primești sugestii de locații pe baza preferințelor salvate.</small>
                                </span>
                                <input type="checkbox" id="notif-insights" checked>
                            </label>
                        </div>
                        <div class="settings-card-footer">
                            <button class="crm-button primary" type="button">Salvează</button>
                        </div>
                    </section>

                    <section class="settings-card settings-card--full">
                        <header>
                            <h2>Administrare cont</h2>
                            <span class="panel-meta">Controlează vizibilitatea și statusul contului tău</span>
                        </header>
                        <p class="panel-meta">Poți pune pauză contului pentru a opri temporar notificările sau îl poți șterge definitiv împreună cu toate datele asociate.</p>
                        <div class="settings-card-actions">
                            <button class="crm-button ghost crm-button--sm" type="button" data-confirm-target="pause-account">Pauză cont</button>
                            <button class="crm-button danger crm-button--sm" type="button" data-confirm-target="delete-account">Șterge contul</button>
                        </div>
                    </section>
                </div>
            </section>

            <!-- Pagina Cererile Mele -->
            <section class="crm-page" data-page="requests">
                <div class="page-header">
                    <h1>Cererile Mele de Disponibilitate</h1>
                    <p>Urmărește statusul tuturor cererilor trimise către locații.</p>
                </div>
                <article class="panel">
                    <header>
                        <h2>Filtrează cererile</h2>
                        <span class="panel-meta">Alege statusul sau locația pentru a găsi rapid o cerere</span>
                    </header>
                    <div class="filter-bar">
                        <label for="requests-status-filter">Status:</label>
                        <select id="requests-status-filter"></select>
                        <label for="requests-location-filter">Locație:</label>
                        <select id="requests-location-filter"></select>
                        <label for="requests-date-filter">Luna evenimentului:</label>
                        <select id="requests-date-filter"></select>
                    </div>
                    <div class="requests-legend" id="requests-status-legend"></div>
                    <div class="table-wrapper">
                        <table class="crm-table">
                            <thead>
                                <tr>
                                    <th>Locație</th>
                                    <th>Dată eveniment</th>
                                    <th>Invitați</th>
                                    <th>Status</th>
                                    <th>Următorul pas</th>
                                    <th>Acțiuni</th>
                                </tr>
                            </thead>
                            <tbody id="requests-table-body"></tbody>
                        </table>
                    </div>
                </article>
            </section>

            <section class="crm-page" data-page="viewings">
                <div class="page-header">
                    <h1>Vizionările Mele</h1>
                    <p>Confirmă prezența, cere reprogramări și urmărește notițele trimise de proprietari.</p>
                </div>
                <article class="panel">
                    <header>
                        <h2>Programări viitoare</h2>
                        <span class="panel-meta">Calendar pentru următoarele 30 de zile</span>
                    </header>
                    <div class="filter-bar">
                        <label for="viewings-venue-filter">Locație:</label>
                        <select id="viewings-venue-filter"></select>
                        <label for="viewings-status-filter">Status:</label>
                        <select id="viewings-status-filter"></select>
                    </div>
                    <div class="table-wrapper">
                        <table class="crm-table">
                            <thead>
                                <tr>
                                    <th>Locație</th>
                                    <th>Dată</th>
                                    <th>Ora</th>
                                    <th>Status</th>
                                    <th>Acțiuni</th>
                                </tr>
                            </thead>
                            <tbody id="viewings-table-body"></tbody>
                        </table>
                    </div>
                </article>
            </section>

        </section>
    </main>

    <div class="favorites-modal-overlay" id="availability-modal">
        <div class="favorites-modal" role="dialog" aria-modal="true" aria-labelledby="availability-modal-title">
            <header>
                <div>
                    <h3 id="availability-modal-title">Cere disponibilitatea</h3>
                    <p id="availability-modal-subtitle" class="panel-meta">Selectează data dorită și detaliile evenimentului.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="availability-modal-close" aria-label="Închide">×</button>
            </header>
            <form id="availability-form">
                <div class="form-section">
                    <input type="hidden" id="availability-date-picker">
                    <div id="availability-calendar" class="availability-calendar"></div>
                    <div class="availability-legend">
                        <span><span class="availability-legend-dot availability-legend-dot--available"></span>Disponibil</span>
                        <span><span class="availability-legend-dot availability-legend-dot--hold"></span>Pre-rezervat</span>
                        <span><span class="availability-legend-dot availability-legend-dot--booked"></span>Ocupat</span>
                    </div>
                </div>
                <p class="panel-meta" id="availability-selected-date">Selectează o dată disponibilă din calendar.</p>
                <div class="form-row">
                    <div>
                        <label for="availability-event-type">Tip eveniment</label>
                        <select id="availability-event-type" required></select>
                    </div>
                    <div>
                        <label for="availability-guests">Număr invitați</label>
                        <input type="number" id="availability-guests" min="10" max="600" required>
                    </div>
                </div>
                <footer>
                    <button type="button" class="crm-button ghost" id="availability-cancel-btn">Renunță</button>
                    <button type="submit" class="crm-button primary">Trimite cererea</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="favorites-modal-overlay" id="viewing-modal">
        <div class="favorites-modal" role="dialog" aria-modal="true" aria-labelledby="viewing-modal-title">
            <header>
                <div>
                    <h3 id="viewing-modal-title">Programează o vizionare</h3>
                    <p id="viewing-modal-subtitle" class="panel-meta">Selectează data și ora preferată pentru vizionarea locației.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="viewing-modal-close" aria-label="Închide">×</button>
            </header>
            <form id="viewing-form">
                <div class="form-section">
                    <input type="hidden" id="viewing-date-picker">
                    <div id="viewing-calendar" class="availability-calendar"></div>
                    <div class="availability-legend">
                        <span><span class="availability-legend-dot availability-legend-dot--available"></span>Disponibil</span>
                        <span><span class="availability-legend-dot availability-legend-dot--hold"></span>Pre-rezervat</span>
                        <span><span class="availability-legend-dot availability-legend-dot--booked"></span>Ocupat</span>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="viewing-time">Ora preferată</label>
                        <input type="time" id="viewing-time" required>
                    </div>
                </div>
                <p class="panel-meta" id="viewing-selected-date">Selectează data și ora pentru vizionare.</p>
                <footer>
                    <button type="button" class="crm-button ghost" id="viewing-cancel-btn">Renunță</button>
                    <button type="submit" class="crm-button primary">Trimite solicitarea</button>
                </footer>
            </form>
        </div>
    </div>
    <div class="favorites-modal-overlay" id="account-confirmation-overlay">
        <div class="favorites-modal account-confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="account-confirmation-title">
            <header>
                <div>
                    <h3 id="account-confirmation-title">Confirmă acțiunea</h3>
                    <p id="account-confirmation-description" class="panel-meta">Asigură-te că dorești să continui.</p>
                </div>
                <button type="button" class="favorites-modal-close" id="account-confirmation-close" aria-label="Închide">×</button>
            </header>
            <div class="account-confirmation-content">
                <p id="account-confirmation-message">Ești pe cale să aplici o schimbare importantă asupra contului tău.</p>
            </div>
            <footer class="account-confirmation-footer">
                <button type="button" class="crm-button ghost crm-button--sm" id="account-confirmation-cancel">Renunță</button>
                <button type="button" class="crm-button crm-button--sm" id="account-confirmation-confirm">Confirmă acțiunea</button>
            </footer>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ro.js"></script>
    <script src="main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.crm-nav-link');
        const pages = document.querySelectorAll('.crm-page');
        const storageKey = 'client-dashboard-active-page';

        function activatePage(pageId) {
            if (!pageId) {
                return;
            }
            pages.forEach(page => page.classList.toggle('is-active', page.dataset.page === pageId));
            navLinks.forEach(link => link.classList.toggle('is-active', link.dataset.pageTarget === pageId));
            localStorage.setItem(storageKey, pageId);
            history.replaceState(null, '', `#${pageId}`);
        }

        const initialHash = window.location.hash.replace('#', '');
        const storedPage = localStorage.getItem(storageKey);
        activatePage(initialHash || storedPage || 'overview');

        navLinks.forEach(link => {
            link.addEventListener('click', () => activatePage(link.dataset.pageTarget));
        });

        window.addEventListener('hashchange', () => activatePage(window.location.hash.replace('#', '')));

        const accountConfirmationOverlay = document.getElementById('account-confirmation-overlay');
        const accountConfirmationModal = accountConfirmationOverlay?.querySelector('.account-confirmation-modal');
        const accountConfirmationTitle = document.getElementById('account-confirmation-title');
        const accountConfirmationDescription = document.getElementById('account-confirmation-description');
        const accountConfirmationMessage = document.getElementById('account-confirmation-message');
        const accountConfirmationCloseBtn = document.getElementById('account-confirmation-close');
        const accountConfirmationCancelBtn = document.getElementById('account-confirmation-cancel');
        const accountConfirmationConfirmBtn = document.getElementById('account-confirmation-confirm');
        const accountActionButtons = document.querySelectorAll('[data-confirm-target]');
        const accountConfirmationConfigs = {
            'pause-account': {
                title: 'Pui contul pe pauză?',
                description: 'Notificările și invitațiile vor fi suspendate temporar.',
                message: 'Poți reveni oricând prin reactivarea contului din această secțiune. Continuăm?',
                confirmLabel: 'Confirmă pauza',
                confirmVariant: 'ghost'
            },
            'delete-account': {
                title: 'Ștergi definitiv contul?',
                description: 'Această acțiune este ireversibilă.',
                message: 'Toate locațiile favorite, solicitările și datele asociate vor fi eliminate. Confirmă dacă dorești să continui.',
                confirmLabel: 'Șterge contul',
                confirmVariant: 'danger'
            }
        };
        const accountConfirmationState = {
            action: null
        };

        function applyConfirmVariant(variant) {
            if (!accountConfirmationConfirmBtn) {
                return;
            }
            const baseClasses = ['crm-button', 'crm-button--sm'];
            accountConfirmationConfirmBtn.className = baseClasses.join(' ');
            if (variant === 'primary' || variant === 'danger' || variant === 'ghost') {
                accountConfirmationConfirmBtn.classList.add(variant);
            } else if (variant) {
                accountConfirmationConfirmBtn.classList.add(variant);
            }
        }

        function openAccountConfirmation(action) {
            if (!accountConfirmationOverlay || !accountConfirmationModal) {
                return;
            }
            const config = accountConfirmationConfigs[action] || accountConfirmationConfigs['pause-account'];
            accountConfirmationState.action = action;

            if (accountConfirmationTitle) {
                accountConfirmationTitle.textContent = config.title;
            }
            if (accountConfirmationDescription) {
                accountConfirmationDescription.textContent = config.description;
            }
            if (accountConfirmationMessage) {
                accountConfirmationMessage.textContent = config.message;
            }
            if (accountConfirmationConfirmBtn) {
                accountConfirmationConfirmBtn.textContent = config.confirmLabel;
            }
            applyConfirmVariant(config.confirmVariant || 'primary');

            accountConfirmationOverlay.classList.add('is-visible');
            const focusableButtons = accountConfirmationModal.querySelectorAll('button:not([disabled])');
            if (focusableButtons.length) {
                focusableButtons[focusableButtons.length - 1].focus();
            }
        }

        function closeAccountConfirmation() {
            if (!accountConfirmationOverlay) {
                return;
            }
            accountConfirmationOverlay.classList.remove('is-visible');
            accountConfirmationState.action = null;
        }

        accountActionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const action = button.dataset.confirmTarget;
                openAccountConfirmation(action);
            });
        });

        accountConfirmationCloseBtn?.addEventListener('click', closeAccountConfirmation);
        accountConfirmationCancelBtn?.addEventListener('click', closeAccountConfirmation);
        accountConfirmationOverlay?.addEventListener('click', (event) => {
            if (event.target === accountConfirmationOverlay) {
                closeAccountConfirmation();
            }
        });

        accountConfirmationConfirmBtn?.addEventListener('click', () => {
            const action = accountConfirmationState.action;
            closeAccountConfirmation();
            if (action === 'pause-account') {
                console.info('Contul a fost setat pe pauză (simulare).');
            } else if (action === 'delete-account') {
                console.warn('Contul a fost marcat pentru ștergere (simulare).');
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && accountConfirmationOverlay?.classList.contains('is-visible')) {
                closeAccountConfirmation();
            }
        });

        const today = new Date();
        const addDays = (days) => {
            const d = new Date(today);
            d.setDate(d.getDate() + days);
            return d;
        };
        const monthNames = ['ian', 'feb', 'mar', 'apr', 'mai', 'iun', 'iul', 'aug', 'sep', 'oct', 'noi', 'dec'];
        const formatDate = (date) => `${String(date.getDate()).padStart(2, '0')} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        const formatDateTime = (date) => `${formatDate(date)} · ${formatTime(date)}`;
        const formatMonthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const formatMonthLabel = (date) => `${monthNames[date.getMonth()].charAt(0).toUpperCase() + monthNames[date.getMonth()].slice(1)} ${date.getFullYear()}`;

        const locations = [
            { id: 1, name: 'The Grand Ballroom', city: 'București', price: 120, imageUrl: 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?w=400' },
            { id: 2, name: 'Forest Retreat & Spa', city: 'Brașov', price: 95, imageUrl: 'https://images.unsplash.com/photo-1582719508461-905c673771fd?w=400' },
            { id: 3, name: 'Cluj SkyView', city: 'Cluj-Napoca', price: 110, imageUrl: 'https://images.unsplash.com/photo-1590073242678-70ee3fc2f8b2?w=400' },
            { id: 4, name: 'Casa Miraval', city: 'Cluj-Napoca', price: 130, imageUrl: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=400' },
            { id: 5, name: 'Heritage Gardens', city: 'Oradea', price: 105, imageUrl: 'https://images.unsplash.com/photo-1529429617124-aee711a52795?w=400' },
            { id: 6, name: 'Urban Art Loft', city: 'Timișoara', price: 115, imageUrl: 'https://images.unsplash.com/photo-1484154218962-a197022b5858?w=400' },
            { id: 7, name: 'Ambiance Lake', city: 'Snagov', price: 150, imageUrl: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400' }
        ];

        const defaultFavoriteIds = [2, 3, 5, 7];
        let storedFavorites = [];
        try {
            const rawFavorites = localStorage.getItem('favoriteIds');
            storedFavorites = rawFavorites ? JSON.parse(rawFavorites) : [];
        } catch (error) {
            storedFavorites = [];
        }
        let favoriteIds = Array.isArray(storedFavorites) && storedFavorites.length ? storedFavorites : defaultFavoriteIds.slice();
        if (!Array.isArray(storedFavorites) || storedFavorites.length === 0) {
            localStorage.setItem('favoriteIds', JSON.stringify(favoriteIds));
        }

        const requestStatusMeta = {
            availability_request: {
                label: 'Cerere disponibilitate trimisă',
                description: 'Locația a primit cererea ta și verifică disponibilitatea pentru data selectată.',
                nextStep: 'Trimite mesaj locației sau așteaptă confirmarea lor.',
                color: '#b45309'
            },
            availability_confirmed: {
                label: 'Dată disponibilă – poți cere ofertă',
                description: 'Locația a confirmat că data este liberă.',
                nextStep: 'Cere ofertă sau programează o vizionare pentru a merge mai departe.',
                color: '#2563eb'
            },
            offer_requested: {
                label: 'Ofertă cerută',
                description: 'Ai solicitat o ofertă personalizată și aștepți răspunsul locației.',
                nextStep: 'Poți trimite întrebări suplimentare sau anula cererea dacă planurile se schimbă.',
                color: '#a855f7'
            },
            offer_sent: {
                label: 'Ofertă primită',
                description: 'Locația ți-a trimis o ofertă personalizată.',
                nextStep: 'Analizează oferta, pune întrebări și confirmă dacă vrei să blochezi data.',
                color: '#7c3aed'
            },
            viewing_request: {
                label: 'Cerere vizionare trimisă',
                description: 'Ai cerut o vizionare a locației.',
                nextStep: 'Așteaptă confirmarea sau ajustează cererea dacă ai nevoie de altă dată.',
                color: '#0ea5e9'
            },
            viewing_rescheduled: {
                label: 'Vizionare reprogramată',
                description: 'Locația a propus o altă dată pentru vizionare.',
                nextStep: 'Acceptă noua propunere sau cere o altă variantă.',
                color: '#0284c7'
            },
            viewing_scheduled: {
                label: 'Vizionare confirmată',
                description: 'Vizionarea este programată la o dată și oră stabilite.',
                nextStep: 'Adaugă vizita în calendar și pregătește întrebările pentru echipă.',
                color: '#2563eb'
            },
            pre_booked: {
                label: 'Dată blocată temporar (Pre-rezervat)',
                description: 'Locația a blocat data provizoriu pentru tine.',
                nextStep: 'Confirmă rezervarea sau renunță pentru a elibera data.',
                color: '#0d9488'
            },
            confirmed: {
                label: 'Rezervat',
                description: 'Rezervarea a fost confirmată de locație după plata avansului.',
                nextStep: 'Ține legătura cu locația pentru detalii și pregătește feedback-ul de după eveniment.',
                color: '#15803d'
            },
            rejected: {
                label: 'Indisponibil / Refuzat',
                description: 'Locația nu este disponibilă sau a refuzat cererea.',
                nextStep: 'Vezi mesajul locației și trimite o nouă cerere dacă dorești.',
                color: '#b91c1c'
            },
            cancelled: {
                label: 'Anulat de client',
                description: 'Ai anulat cererea înainte de confirmare.',
                nextStep: 'Poți retrimite cererea oricând dorești.',
                color: '#dc2626'
            }
        };

        const viewingStatusMeta = {
            awaiting_confirmation: { label: 'Așteaptă confirmarea ta', color: '#2563eb' },
            confirmed: { label: 'Confirmată', color: '#15803d' },
            reschedule_pending: { label: 'Reprogramare propusă', color: '#c2410c' },
            completed: { label: 'Vizionare încheiată', color: '#0f172a' }
        };

        let clientRequests = [
            { id: 1, locationId: 2, eventDate: addDays(45), guests: 120, status: 'availability_request', lastUpdate: addDays(-1) },
            { id: 2, locationId: 7, eventDate: addDays(80), guests: 150, status: 'availability_confirmed', lastUpdate: addDays(-2) },
            { id: 3, locationId: 1, eventDate: addDays(120), guests: 200, status: 'offer_sent', lastUpdate: addDays(-3), offerValidUntil: addDays(6) },
            { id: 4, locationId: 3, eventDate: addDays(90), guests: 90, status: 'offer_requested', lastUpdate: addDays(-5) },
            { id: 5, locationId: 4, eventDate: addDays(62), guests: 80, status: 'viewing_request', lastUpdate: addDays(-4) },
            { id: 6, locationId: 6, eventDate: addDays(70), guests: 95, status: 'viewing_rescheduled', lastUpdate: addDays(-2) },
            { id: 7, locationId: 5, eventDate: addDays(35), guests: 100, status: 'pre_booked', lastUpdate: addDays(-4), holdExpiresAt: addDays(2) },
            { id: 8, locationId: 7, eventDate: addDays(160), guests: 60, status: 'confirmed', lastUpdate: addDays(-6) },
            { id: 9, locationId: 2, eventDate: addDays(52), guests: 110, status: 'rejected', lastUpdate: addDays(-8) },
            { id: 10, locationId: 3, eventDate: addDays(35), guests: 70, status: 'cancelled', lastUpdate: addDays(-10) },
            { id: 11, locationId: 1, eventDate: addDays(28), guests: 85, status: 'viewing_scheduled', lastUpdate: addDays(-1) }
        ];

        let requestHistory = [
            { id: 1, message: 'Ai salvat Forest Retreat & Spa la favorite', timestamp: addDays(-14) },
            { id: 2, message: 'Ai trimis o cerere pentru Ambiance Lake', timestamp: addDays(-9) },
            { id: 3, message: 'Ambiance Lake ți-a trimis o ofertă', timestamp: addDays(-2) },
            { id: 4, message: 'Ai blocat Casa Miraval pentru 48h', timestamp: addDays(-4) }
        ];

        const clientViewings = [
            { id: 1, locationId: 2, date: addDays(5), hour: '17:00', host: 'Ioana Pop', status: 'awaiting_confirmation', lastUpdate: addDays(-1), note: 'Confirmă prezența cu 24h înainte' },
            { id: 2, locationId: 7, date: addDays(12), hour: '11:00', host: 'Mihai Dima', status: 'confirmed', lastUpdate: addDays(-2), note: 'Vom discuta logistica exterioară' },
            { id: 3, locationId: 3, date: addDays(20), hour: '15:30', host: 'Irina M.', status: 'reschedule_pending', lastUpdate: addDays(-1), note: 'Proprietarul a propus o nouă dată' },
            { id: 4, locationId: 1, date: addDays(-3), hour: '10:00', host: 'Laura C.', status: 'completed', lastUpdate: addDays(-3), note: 'Ți-am trimis planul detaliat' }
        ];

        const requestFilters = { status: 'all', location: 'all', month: 'all' };
        const viewingFilters = { venue: 'all', status: 'all' };

        const favoritesGrid = document.getElementById('favorites-grid');
        const overviewFavoritesCount = document.getElementById('overview-favorites-count');
        const overviewRequestsCount = document.getElementById('overview-requests-count');
        const overviewOffersCount = document.getElementById('overview-offers-count');
        const overviewViewingsCount = document.getElementById('overview-viewings-count');
        const overviewActivityList = document.getElementById('overview-recent-activity');
        const overviewTasksList = document.getElementById('overview-next-steps');
        const overviewViewingsList = document.getElementById('overview-viewings-list');

        const requestsStatusFilter = document.getElementById('requests-status-filter');
        const requestsLocationFilter = document.getElementById('requests-location-filter');
        const requestsDateFilter = document.getElementById('requests-date-filter');
        const requestsTableBody = document.getElementById('requests-table-body');

        const viewingsVenueFilter = document.getElementById('viewings-venue-filter');
        const viewingsStatusFilter = document.getElementById('viewings-status-filter');
        const viewingsTableBody = document.getElementById('viewings-table-body');

        function getLocationById(id) {
            return locations.find(loc => loc.id === id);
        }

        function populateSelect(selectEl, values, includeAll = true, allLabel = 'Toate opțiunile') {
            if (!selectEl) return;
            selectEl.innerHTML = '';
            if (includeAll) {
                const option = document.createElement('option');
                option.value = 'all';
                option.textContent = allLabel;
                selectEl.appendChild(option);
            }
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value.value ?? value;
                option.textContent = value.label ?? value;
                selectEl.appendChild(option);
            });
        }

        function createStatusChip(status, metaSource = requestStatusMeta) {
            const span = document.createElement('span');
            span.className = 'status-chip';
            span.dataset.status = status;
            const meta = metaSource[status] || { label: status, color: '#1f2937' };
            span.textContent = meta.label || status;
            if (meta.color) {
                span.style.color = meta.color;
                span.style.backgroundColor = `${meta.color}26`;
            }
            return span;
        }

        function getRequestNextStep(request) {
            const defaultStep = {
                title: 'Următorul pas',
                detail: 'Ține legătura cu locația pentru a avansa discuția.'
            };
            if (!request) {
                return defaultStep;
            }
            const meta = requestStatusMeta[request.status];
            if (!meta) {
                return defaultStep;
            }
            let detail = meta.nextStep || meta.description || defaultStep.detail;
            if (request.status === 'offer_sent' && request.offerValidUntil instanceof Date) {
                detail += ` Oferta expiră pe ${formatDate(request.offerValidUntil)}.`;
            }
            if (request.status === 'pre_booked' && request.holdExpiresAt instanceof Date) {
                detail += ` Blocajul expiră pe ${formatDate(request.holdExpiresAt)}.`;
            }
            return {
                title: defaultStep.title,
                detail: detail
            };
        }

        function renderOverviewMetrics() {
            if (overviewFavoritesCount) overviewFavoritesCount.textContent = favoriteIds.length;
            if (overviewRequestsCount) overviewRequestsCount.textContent = clientRequests.filter(req => !['cancelled', 'rejected'].includes(req.status)).length;
            if (overviewOffersCount) overviewOffersCount.textContent = clientRequests.filter(req => req.status === 'offer_sent').length;
            if (overviewViewingsCount) overviewViewingsCount.textContent = clientViewings.filter(view => ['confirmed', 'awaiting_confirmation'].includes(view.status)).length;
        }

        function renderOverviewRecentActivity() {
            if (!overviewActivityList) return;
            const activity = [];

            clientRequests.forEach(req => {
                activity.push({
                    type: 'request',
                    id: req.id,
                    timestamp: req.lastUpdate,
                    message: `${requestStatusMeta[req.status]?.label || 'Actualizare'} · ${getLocationById(req.locationId)?.name || 'Locație'}`
                });
            });

            requestHistory.forEach(entry => {
                activity.push({
                    type: 'history',
                    id: entry.id,
                    timestamp: entry.timestamp,
                    message: entry.message
                });
            });

            clientViewings.forEach(viewing => {
                activity.push({
                    type: 'viewing',
                    id: viewing.id,
                    timestamp: viewing.lastUpdate,
                    message: `Vizionare ${viewingStatusMeta[viewing.status]?.label || ''} · ${getLocationById(viewing.locationId)?.name || 'Locație'}`
                });
            });

            const validActivity = activity
                .filter(item => item.timestamp instanceof Date && !Number.isNaN(item.timestamp.getTime()))
                .sort((a, b) => b.timestamp - a.timestamp);

            overviewActivityList.innerHTML = '';
            const toDisplay = validActivity.slice(0, 5);
            if (!toDisplay.length) {
                overviewActivityList.innerHTML = '<div class="empty-state">Nu există activități recente.</div>';
                return;
            }

            toDisplay.forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'list-item';
                entry.innerHTML = `
                    <div>${item.message}</div>
                    <span class="panel-meta">${formatDate(item.timestamp)}</span>
                `;
                if (item.type === 'request' || item.type === 'viewing') {
                    entry.classList.add('is-interactive');
                    entry.addEventListener('click', () => {
                        if (item.type === 'request') {
                            navigateToItem('request', item.id);
                        } else if (item.type === 'viewing') {
                            navigateToItem('viewing', item.id);
                        }
                    });
                }
                overviewActivityList.appendChild(entry);
            });
        }

        function renderOverviewViewingsList() {
            if (!overviewViewingsList) return;
            const upcoming = clientViewings
                .filter(view => view.date >= today && view.date <= addDays(14))
                .sort((a, b) => a.date - b.date);

            overviewViewingsList.innerHTML = '';
            if (!upcoming.length) {
                overviewViewingsList.innerHTML = '<div class="empty-state">Nu ai vizionări în următoarele 14 zile.</div>';
                return;
            }

            upcoming.forEach(view => {
                const location = getLocationById(view.locationId);
                const item = document.createElement('div');
                // MODIFICAT: Adăugat clasă și event listener pentru interactivitate
                item.className = 'list-item is-interactive';
                item.addEventListener('click', () => navigateToItem('viewing', view.id));
                const chip = createStatusChip(view.status, viewingStatusMeta);
                item.innerHTML = `
                    <div>
                        ${location?.name || 'Locație necunoscută'}
                        <span class="panel-meta">${formatDate(view.date)} · ${view.hour}</span>
                    </div>
                `;
                item.appendChild(chip);
                overviewViewingsList.appendChild(item);
            });
        }

        function navigateToItem(type, id) {
            if (!type || !id) return;
            const pageId = type === 'viewing' ? 'viewings' : 'requests';
            activatePage(pageId);
            if (type === 'request') {
                requestFilters.status = 'all';
                requestFilters.location = 'all';
                requestFilters.month = 'all';
                if (requestsStatusFilter) requestsStatusFilter.value = 'all';
                if (requestsLocationFilter) requestsLocationFilter.value = 'all';
                if (requestsDateFilter) requestsDateFilter.value = 'all';
                renderRequests();
            } else if (type === 'viewing') {
                viewingFilters.status = 'all';
                viewingFilters.venue = 'all';
                if (viewingsStatusFilter) viewingsStatusFilter.value = 'all';
                if (viewingsVenueFilter) viewingsVenueFilter.value = 'all';
                renderViewingsTable();
            }
            requestAnimationFrame(() => {
                let targetRow = null;
                if (type === 'viewing' && viewingsTableBody) {
                    targetRow = viewingsTableBody.querySelector(`tr[data-id="${id}"]`);
                } else if (type === 'request' && requestsTableBody) {
                    targetRow = requestsTableBody.querySelector(`tr[data-id="${id}"]`);
                }
                if (targetRow) {
                    targetRow.classList.add('is-highlighted');
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => targetRow.classList.remove('is-highlighted'), 2400);
                }
            });
        }

        function renderOverview() {
            renderOverviewMetrics();
            renderOverviewRecentActivity();
            renderOverviewViewingsList();
        }

        function renderFavorites() {
            if (!favoritesGrid) return;
            favoritesGrid.innerHTML = '';
            const favoriteLocations = locations.filter(loc => favoriteIds.includes(loc.id));

            if (!favoriteLocations.length) {
                favoritesGrid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Nu ai salvat încă nicio locație. Explorează și adaugă favorite pentru a le regăsi rapid.</div>';
                renderOverviewMetrics();
                return;
            }

            favoriteLocations.forEach(loc => {
                const card = document.createElement('div');
                card.className = 'location-card';
                card.innerHTML = `
                    <div class="location-image" style="background-image: url('${loc.imageUrl}')">
                        <button class="remove-favorite-btn" data-id="${loc.id}" title="Elimină de la favorite">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        </button>
                    </div>
                    <div class="location-details">
                        <h3>${loc.name}</h3>
                        <p>${loc.city}, România</p>
                        <div class="location-card-footer">
                            <span class="location-price">de la <strong>${loc.price}€</strong>/pers</span>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <a href="venue-details.html?id=${loc.id}" class="crm-button ghost" style="padding: 6px 14px; font-size: 0.85rem;">Vezi detalii</a>
                                <button type="button" class="crm-button primary request-availability-btn" data-location-id="${loc.id}" style="padding: 6px 14px; font-size: 0.85rem;">Cere disponibilitatea</button>
                            </div>
                        </div>
                    </div>
                `;
                favoritesGrid.appendChild(card);
            });

            favoritesGrid.querySelectorAll('.remove-favorite-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const idToRemove = parseInt(button.dataset.id, 10);
                    favoriteIds = favoriteIds.filter(id => id !== idToRemove);
                    localStorage.setItem('favoriteIds', JSON.stringify(favoriteIds));
                    renderFavorites();
                    renderOverviewMetrics();
                });
            });

            favoritesGrid.querySelectorAll('.request-availability-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const locationId = parseInt(button.dataset.locationId, 10);
                    const location = getLocationById(locationId);
                    openAvailabilityModal(location);
                });
            });

            renderOverviewMetrics();
        }

        const availabilityModal = document.getElementById('availability-modal');
        const availabilityModalCloseBtn = document.getElementById('availability-modal-close');
        const availabilityForm = document.getElementById('availability-form');
        const availabilityEventTypeSelect = document.getElementById('availability-event-type');
        const availabilityGuestsInput = document.getElementById('availability-guests');
        const availabilitySelectedDateLabel = document.getElementById('availability-selected-date');
        const availabilityModalSubtitle = document.getElementById('availability-modal-subtitle');
        const availabilityCancelBtn = document.getElementById('availability-cancel-btn');

        const eventTypeOptions = ['Nuntă', 'Botez', 'Cununie Civilă', 'Eveniment Corporate', 'Petrecere Privată', 'Aniversare'];
        const availabilityCalendarContainer = document.getElementById('availability-calendar');
        const availabilityDateInput = document.getElementById('availability-date-picker');
        let availabilityDatePicker = null;

        const availabilityState = {
            locationId: null,
            locationName: '',
            selectedDate: null
        };

        const viewingModal = document.getElementById('viewing-modal');
        const viewingModalCloseBtn = document.getElementById('viewing-modal-close');
        const viewingForm = document.getElementById('viewing-form');
        const viewingCalendarContainer = document.getElementById('viewing-calendar');
        const viewingDateInput = document.getElementById('viewing-date-picker');
        const viewingTimeInput = document.getElementById('viewing-time');
        const viewingSelectedDateLabel = document.getElementById('viewing-selected-date');
        const viewingModalSubtitle = document.getElementById('viewing-modal-subtitle');
        const viewingModalTitle = document.getElementById('viewing-modal-title');
        const viewingCancelBtn = document.getElementById('viewing-cancel-btn');
        let viewingDatePicker = null;

        const viewingState = {
            requestId: null,
            locationId: null,
            locationName: '',
            selectedDate: null,
            selectedTime: ''
        };

        function openAvailabilityModal(location) {
            if (!availabilityModal || !location) {
                return;
            }
            availabilityState.locationId = location.id;
            availabilityState.locationName = location.name;
            availabilityState.selectedDate = null;

            if (availabilityModalSubtitle) {
                availabilityModalSubtitle.textContent = `Selectează data pentru ${location.name}`;
            }
            if (availabilityEventTypeSelect && !availabilityEventTypeSelect.options.length) {
                eventTypeOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    availabilityEventTypeSelect.appendChild(opt);
                });
            }
            if (availabilityEventTypeSelect) {
                availabilityEventTypeSelect.value = eventTypeOptions[0];
            }
            if (availabilityGuestsInput) {
                availabilityGuestsInput.value = '';
            }
            availabilityModal.classList.add('is-visible');
            ensureAvailabilityDatePicker();
            updateAvailabilitySelectedDate();
        }

        function closeAvailabilityModal() {
            availabilityModal?.classList.remove('is-visible');
            availabilityState.selectedDate = null;
            availabilityDatePicker?.clear(false);
            updateAvailabilitySelectedDate();
            availabilityDatePicker?.close();
        }

        function ensureAvailabilityDatePicker() {
            if (!availabilityCalendarContainer || !availabilityDateInput || typeof flatpickr !== 'function') {
                return null;
            }
            const today = new Date();
            if (!availabilityDatePicker) {
                if (typeof flatpickr.localize === 'function' && flatpickr.l10ns?.ro) {
                    flatpickr.localize(flatpickr.l10ns.ro);
                }
                availabilityDatePicker = flatpickr(availabilityDateInput, {
                    minDate: 'today',
                    locale: flatpickr.l10ns?.ro || 'default',
                    disableMobile: true,
                    monthSelectorType: 'dropdown',
                    yearSelectorType: 'dropdown',
                    showMonths: 1,
                    inline: true,
                    appendTo: availabilityCalendarContainer,
                    onChange(selectedDates, dateStr, instance) {
                        availabilityState.selectedDate = selectedDates[0] || null;
                        updateAvailabilitySelectedDate();
                    },
                    onDayCreate: decorateAvailabilityDay
                });
            }
            const referenceDate = availabilityState.selectedDate || today;
            availabilityDatePicker.clear(false);
            availabilityDatePicker.set('disable', [
                function(date) {
                    return getAvailabilityStatus(availabilityState.locationId, date) === 'booked';
                }
            ]);
            availabilityDatePicker.redraw();
            availabilityDatePicker.jumpToDate(referenceDate);
            availabilityState.selectedDate = null;
            updateAvailabilitySelectedDate();
            return availabilityDatePicker;
        }

        function decorateAvailabilityDay(selectedDates, dateStr, instance, dayElem) {
            const date = dayElem.dateObj;
            if (!date) {
                return;
            }
            const status = getAvailabilityStatus(availabilityState.locationId, date);
            dayElem.classList.remove('availability-day-hold', 'availability-day-booked', 'availability-day-available');
            if (status === 'hold') {
                dayElem.classList.add('availability-day-hold');
            } else if (status === 'booked') {
                dayElem.classList.add('availability-day-booked', 'flatpickr-disabled');
            } else {
                dayElem.classList.add('availability-day-available');
            }
        }

        function updateAvailabilitySelectedDate() {
            if (!availabilitySelectedDateLabel) {
                return;
            }
            if (!availabilityState.selectedDate) {
                availabilitySelectedDateLabel.textContent = 'Selectează o dată disponibilă din calendar.';
            } else {
                availabilitySelectedDateLabel.textContent = `Data selectată: ${formatDate(availabilityState.selectedDate)}`;
            }
        }

        function openViewingModal(request) {
            if (!viewingModal || !request) {
                return;
            }
            viewingState.requestId = request.id;
            viewingState.locationId = request.locationId;
            viewingState.locationName = getLocationById(request.locationId)?.name || '';
            viewingState.selectedDate = null;
            viewingState.selectedTime = '';

            if (viewingModalTitle) {
                viewingModalTitle.textContent = viewingState.locationName
                    ? `Programează o vizionare la ${viewingState.locationName}`
                    : 'Programează o vizionare';
            }
            if (viewingModalSubtitle) {
                viewingModalSubtitle.textContent = viewingState.locationName
                    ? `Alege data și ora potrivită pentru ${viewingState.locationName}.`
                    : 'Selectează data și ora preferată pentru vizionare.';
            }
            if (viewingTimeInput) {
                viewingTimeInput.value = '';
            }
            viewingModal.classList.add('is-visible');
            ensureViewingDatePicker();
            updateViewingSelectedDate();
        }

        function closeViewingModal() {
            viewingModal?.classList.remove('is-visible');
            viewingState.requestId = null;
            viewingState.locationId = null;
            viewingState.locationName = '';
            viewingState.selectedDate = null;
            viewingState.selectedTime = '';
            if (viewingTimeInput) {
                viewingTimeInput.value = '';
            }
            viewingDatePicker?.clear(false);
            updateViewingSelectedDate();
        }

        function ensureViewingDatePicker() {
            if (!viewingCalendarContainer || !viewingDateInput || typeof flatpickr !== 'function') {
                return null;
            }
            const today = new Date();
            if (!viewingDatePicker) {
                if (typeof flatpickr.localize === 'function' && flatpickr.l10ns?.ro) {
                    flatpickr.localize(flatpickr.l10ns.ro);
                }
                viewingDatePicker = flatpickr(viewingDateInput, {
                    minDate: 'today',
                    locale: flatpickr.l10ns?.ro || 'default',
                    disableMobile: true,
                    monthSelectorType: 'dropdown',
                    yearSelectorType: 'dropdown',
                    showMonths: 1,
                    inline: true,
                    appendTo: viewingCalendarContainer,
                    onChange(selectedDates) {
                        viewingState.selectedDate = selectedDates[0] || null;
                        updateViewingSelectedDate();
                    },
                    onDayCreate: decorateViewingDay
                });
            }
            const referenceDate = viewingState.selectedDate || today;
            viewingDatePicker.clear(false);
            viewingDatePicker.set('disable', [
                function(date) {
                    return getAvailabilityStatus(viewingState.locationId, date) === 'booked';
                }
            ]);
            viewingDatePicker.redraw();
            viewingDatePicker.jumpToDate(referenceDate);
            viewingState.selectedDate = null;
            updateViewingSelectedDate();
            return viewingDatePicker;
        }

        function decorateViewingDay(selectedDates, dateStr, instance, dayElem) {
            const date = dayElem.dateObj;
            if (!date) {
                return;
            }
            const status = getAvailabilityStatus(viewingState.locationId, date);
            dayElem.classList.remove('availability-day-hold', 'availability-day-booked', 'availability-day-available');
            if (status === 'hold') {
                dayElem.classList.add('availability-day-hold');
            } else if (status === 'booked') {
                dayElem.classList.add('availability-day-booked', 'flatpickr-disabled');
            } else {
                dayElem.classList.add('availability-day-available');
            }
        }

        function updateViewingSelectedDate() {
            if (!viewingSelectedDateLabel) {
                return;
            }
            if (!viewingState.selectedDate) {
                viewingSelectedDateLabel.textContent = 'Selectează data și ora pentru vizionare.';
                return;
            }
            const formattedDate = formatDate(viewingState.selectedDate);
            if (viewingState.selectedTime) {
                viewingSelectedDateLabel.textContent = `Vizionare: ${formattedDate} · ${viewingState.selectedTime}`;
            } else {
                viewingSelectedDateLabel.textContent = `Data selectată: ${formattedDate}. Adaugă și ora preferată.`;
            }
        }

        function getAvailabilityStatus(locationId, date) {
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0) {
                return 'booked';
            }
            const hash = (date.getDate() + (locationId || 1) * 3 + dayOfWeek) % 6;
            if (hash === 0) {
                return 'booked';
            }
            if (hash === 1) {
                return 'hold';
            }
            return 'available';
        }

        availabilityModal?.addEventListener('click', (event) => {
            if (event.target === availabilityModal) {
                closeAvailabilityModal();
            }
        });
        availabilityModalCloseBtn?.addEventListener('click', closeAvailabilityModal);
        availabilityCancelBtn?.addEventListener('click', (event) => {
            event.preventDefault();
            closeAvailabilityModal();
        });

        availabilityForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!availabilityState.locationId) {
                return;
            }
            if (!availabilityState.selectedDate) {
                window.alert('Selectează o dată disponibilă înainte de a continua.');
                return;
            }
            const guestsValue = availabilityGuestsInput?.value?.trim() || '';
            const guests = parseInt(guestsValue, 10);
            if (!guestsValue || Number.isNaN(guests) || guests < 10) {
                window.alert('Introdu un număr de invitați (minim 10).');
                return;
            }
            const eventType = availabilityEventTypeSelect?.value || eventTypeOptions[0];
            createRequestFromModal({
                locationId: availabilityState.locationId,
                eventDate: new Date(availabilityState.selectedDate),
                guests,
                eventType
            });
            closeAvailabilityModal();
        });

        viewingModal?.addEventListener('click', (event) => {
            if (event.target === viewingModal) {
                closeViewingModal();
            }
        });
        viewingModalCloseBtn?.addEventListener('click', closeViewingModal);
        viewingCancelBtn?.addEventListener('click', (event) => {
            event.preventDefault();
            closeViewingModal();
        });
        viewingTimeInput?.addEventListener('input', () => {
            viewingState.selectedTime = viewingTimeInput.value || '';
            updateViewingSelectedDate();
        });
        viewingForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!viewingState.requestId || !viewingState.locationId) {
                return;
            }
            if (!viewingState.selectedDate) {
                window.alert('Selectează data vizionării.');
                return;
            }
            const timeValue = viewingTimeInput?.value?.trim() || '';
            if (!timeValue) {
                window.alert('Introdu ora preferată pentru vizionare.');
                return;
            }
            viewingState.selectedTime = timeValue;
            const [hoursPart, minutesPart] = timeValue.split(':').map(Number);
            const scheduledDate = new Date(viewingState.selectedDate);
            if (!Number.isNaN(hoursPart)) {
                scheduledDate.setHours(hoursPart, Number.isNaN(minutesPart) ? 0 : minutesPart, 0, 0);
            }

            const request = clientRequests.find(req => req.id === viewingState.requestId);
            if (!request) {
                closeViewingModal();
                return;
            }

            request.status = 'viewing_request';
            request.lastUpdate = new Date();
            delete request.holdExpiresAt;

            const nextViewingId = clientViewings.reduce((max, view) => Math.max(max, view.id), 0) + 1;
            const newViewing = {
                id: nextViewingId,
                locationId: viewingState.locationId,
                date: scheduledDate,
                hour: timeValue,
                status: 'awaiting_confirmation',
                lastUpdate: new Date(),
                host: 'Echipa locației',
                note: 'Așteptăm confirmarea locației pentru această vizionare.'
            };
            clientViewings.push(newViewing);

            const location = getLocationById(viewingState.locationId);
            const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
            requestHistory.unshift({
                id: nextHistoryId,
                message: `Ai solicitat o vizionare la ${location?.name || 'locație'} pe ${formatDate(scheduledDate)}.`,
                timestamp: new Date()
            });

            closeViewingModal();
            renderRequests();
            renderViewingsTable();
            renderOverview();
            navigateToItem('viewing', newViewing.id);
        });

        function createRequestFromModal({ locationId, eventDate, guests, eventType }) {
            const location = getLocationById(locationId);
            if (!location) {
                return;
            }
            const nextRequestId = clientRequests.reduce((max, req) => Math.max(max, req.id), 0) + 1;
            const newRequest = {
                id: nextRequestId,
                locationId,
                eventDate,
                guests,
                eventType,
                status: 'availability_request',
                lastUpdate: new Date()
            };
            clientRequests.unshift(newRequest);

            const nextHistoryId = requestHistory.reduce((max, entry) => Math.max(max, entry.id), 0) + 1;
            requestHistory.unshift({
                id: nextHistoryId,
                message: `Ai trimis o cerere pentru ${location.name}`,
                timestamp: new Date()
            });

            renderRequests();
            renderOverviewMetrics();
            renderOverviewRecentActivity();
            navigateToItem('request', newRequest.id);
        }

        function populateRequestFilters() {
            if (requestsStatusFilter) {
                const statusOptions = Object.entries(requestStatusMeta).map(([value, meta]) => ({ value, label: meta.label }));
                populateSelect(requestsStatusFilter, statusOptions, true, 'Toate statusurile');
            }
            if (requestsLocationFilter) {
                const locationNames = Array.from(new Set(clientRequests.map(req => getLocationById(req.locationId)?.name).filter(Boolean))).sort();
                populateSelect(requestsLocationFilter, locationNames, true, 'Toate locațiile');
            }
            if (requestsDateFilter) {
                const months = Array.from(new Set(clientRequests.map(req => formatMonthKey(req.eventDate)))).sort();
                const options = months.map(key => {
                    const [year, month] = key.split('-').map(Number);
                    const date = new Date(year, month - 1, 1);
                    return { value: key, label: formatMonthLabel(date) };
                });
                populateSelect(requestsDateFilter, options, true, 'Toate lunile');
            }
        }

        function renderRequestsLegend() {
            if (!requestsLegendEl) return;
            requestsLegendEl.innerHTML = '';
            Object.entries(requestStatusMeta).forEach(([status, meta]) => {
                const item = document.createElement('div');
                item.className = 'requests-legend-item';
                const dot = document.createElement('span');
                dot.className = 'legend-dot';
                dot.style.backgroundColor = meta.color || '#94a3b8';

                const content = document.createElement('div');
                content.className = 'requests-legend-item-content';
                const description = meta.description ? `<span>${meta.description}</span>` : '';
                const nextStep = meta.nextStep ? `<span>${meta.nextStep}</span>` : '';
                content.innerHTML = `<strong>${meta.label}</strong>${description}${nextStep}`;

                item.appendChild(dot);
                item.appendChild(content);
                requestsLegendEl.appendChild(item);
            });
        }

        function renderRequests() {
            if (!requestsTableBody) return;
            requestsTableBody.innerHTML = '';

            const filtered = clientRequests
                .filter(req => {
                    const locationName = getLocationById(req.locationId)?.name || '';
                    const monthKey = formatMonthKey(req.eventDate);
                    const statusMatch = requestFilters.status === 'all' || req.status === requestFilters.status;
                    const locationMatch = requestFilters.location === 'all' || requestFilters.location === locationName;
                    const monthMatch = requestFilters.month === 'all' || requestFilters.month === monthKey;
                    return statusMatch && locationMatch && monthMatch;
                })
                .sort((a, b) => a.eventDate - b.eventDate);

            if (!filtered.length) {
                const emptyRow = requestsTableBody.insertRow();
                const emptyCell = emptyRow.insertCell();
                emptyCell.colSpan = 6;
                emptyCell.innerHTML = '<div class="empty-state">Nu există cereri care să corespundă filtrului selectat.</div>';
                renderOverviewMetrics();
                return;
            }

            filtered.forEach(req => {
                const location = getLocationById(req.locationId);
                const row = requestsTableBody.insertRow();
                row.dataset.id = req.id; // NOU: Adaugă ID pentru identificare
                row.insertCell().textContent = location?.name || 'Locație necunoscută';
                row.insertCell().textContent = formatDate(req.eventDate);
                row.insertCell().textContent = req.guests;
                const statusCell = row.insertCell();
                statusCell.appendChild(createStatusChip(req.status, requestStatusMeta));

                const nextCell = row.insertCell();
                const next = getRequestNextStep(req);
                const nextContainer = document.createElement('div');
                nextContainer.className = 'next-step-cell';
                nextContainer.innerHTML = `<strong>${next.title}</strong><span>${next.detail}</span>`;
                nextCell.appendChild(nextContainer);

                const actionsCell = row.insertCell();
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'table-actions';

                switch (req.status) {
                    case 'availability_request':
                        actionsDiv.innerHTML = `
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Trimite mesaj</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">🚫 Anulează cererea</button>
                        `;
                        break;
                    case 'availability_confirmed':
                        actionsDiv.innerHTML = `
                            <button data-request-action="request_offer" data-request-id="${req.id}">📄 Cere ofertă</button>
                            <button data-request-action="request_viewing" data-request-id="${req.id}">👀 Cere vizionare</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">🚫 Anulează cererea</button>
                        `;
                        break;
                    case 'offer_requested':
                        actionsDiv.innerHTML = `
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Trimite mesaj</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">🚫 Anulează cererea</button>
                        `;
                        break;
                    case 'offer_sent':
                        actionsDiv.innerHTML = `
                            <button data-request-action="view_offer" data-request-id="${req.id}">👁️ Vezi ofertă</button>
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Pune întrebări</button>
                            <button data-request-action="accept_offer" data-request-id="${req.id}">✅ Confirmă prin pre-rezervare</button>
                            <button data-request-action="cancel_request" data-request-id="${req.id}">🚫 Anulează cererea</button>
                        `;
                        break;
                    case 'viewing_request':
                        actionsDiv.innerHTML = `
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Trimite mesaj</button>
                            <button data-request-action="cancel_viewing_request" data-request-id="${req.id}">🚫 Anulează vizionarea</button>
                        `;
                        break;
                    case 'viewing_rescheduled':
                        actionsDiv.innerHTML = `
                            <button data-request-action="accept_reschedule" data-request-id="${req.id}">✅ Acceptă noua dată</button>
                            <button data-request-action="decline_reschedule" data-request-id="${req.id}">🚫 Refuză vizionarea</button>
                        `;
                        break;
                    case 'viewing_scheduled':
                        actionsDiv.innerHTML = `
                            <button data-request-action="add_to_calendar" data-request-id="${req.id}">📅 Adaugă în calendar</button>
                            <button data-request-action="cancel_viewing" data-request-id="${req.id}">🚫 Anulează vizionarea</button>
                        `;
                        break;
                    case 'pre_booked':
                        actionsDiv.innerHTML = `
                            <button data-request-action="release_hold" data-request-id="${req.id}">🚫 Renunță la rezervare</button>
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Trimite mesaj</button>
                        `;
                        break;
                    case 'confirmed':
                        actionsDiv.innerHTML = `
                            <button data-request-action="send_message" data-request-id="${req.id}">💬 Trimite mesaj locației</button>
                            <button data-request-action="leave_feedback" data-request-id="${req.id}">⭐ Lasă feedback</button>
                        `;
                        break;
                    case 'rejected':
                        actionsDiv.innerHTML = `
                            <button data-request-action="view_details" data-request-id="${req.id}">ℹ️ Vezi mesajul locației</button>
                            <button data-request-action="reopen_request" data-request-id="${req.id}">🔄 Trimite o nouă cerere</button>
                        `;
                        break;
                    case 'cancelled':
                        actionsDiv.innerHTML = `<button data-request-action="reopen_request" data-request-id="${req.id}">🔄 Retrimite cererea</button>`;
                        break;
                    default:
                        actionsDiv.innerHTML = `<button data-request-action="view_details" data-request-id="${req.id}">Vezi detalii</button>`;
                        break;
                }

                actionsCell.appendChild(actionsDiv);
            });

            renderOverviewMetrics();
        }

        function handleRequestAction(event) {
            const button = event.target.closest('button[data-request-action]');
            if (!button) return;
            const action = button.dataset.requestAction;
            const requestId = parseInt(button.dataset.requestId, 10);
            const request = clientRequests.find(req => req.id === requestId);
            if (!request) return;

            switch (action) {
                case 'view_offer':
                    request.lastUpdate = new Date();
                    break;
                case 'send_message':
                case 'ask_question':
                    request.lastUpdate = new Date();
                    break;
                case 'request_offer':
                    request.status = 'offer_requested';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'request_viewing':
                    if (request.status !== 'availability_confirmed') {
                        window.alert('Poți solicita o vizionare doar după confirmarea disponibilității.');
                        return;
                    }
                    openViewingModal(request);
                    return;
                case 'cancel_request':
                    request.status = 'cancelled';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    delete request.offerValidUntil;
                    break;
                case 'reopen_request':
                    request.status = 'availability_request';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    delete request.offerValidUntil;
                    break;
                case 'accept_offer':
                    request.status = 'pre_booked';
                    request.lastUpdate = new Date();
                    request.holdExpiresAt = addDays(2);
                    delete request.offerValidUntil;
                    break;
                case 'release_hold':
                    request.status = 'availability_confirmed';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'cancel_viewing_request':
                    request.status = 'availability_confirmed';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'add_to_calendar':
                    window.alert('Exportul în calendar va fi disponibil în curând.');
                    request.lastUpdate = new Date();
                    break;
                case 'cancel_viewing':
                    request.status = 'availability_confirmed';
                    request.lastUpdate = new Date();
                    delete request.holdExpiresAt;
                    break;
                case 'accept_reschedule':
                    request.status = 'viewing_scheduled';
                    request.lastUpdate = new Date();
                    break;
                case 'decline_reschedule':
                    request.status = 'viewing_request';
                    request.lastUpdate = new Date();
                    break;
                case 'leave_feedback':
                    window.alert('Mulțumim! Secțiunea de feedback va fi disponibilă după eveniment.');
                    request.lastUpdate = new Date();
                    break;
                case 'view_details':
                    request.lastUpdate = new Date();
                    break;
                default:
                    break;
            }

            renderRequests();
            renderOverviewRecentActivity();
            renderOverviewMetrics();
        }

        function populateViewingFilters() {
            if (viewingsVenueFilter) {
                const venues = Array.from(new Set(clientViewings.map(view => getLocationById(view.locationId)?.name).filter(Boolean))).sort();
                populateSelect(viewingsVenueFilter, venues, true, 'Toate locațiile');
            }
            if (viewingsStatusFilter) {
                const statusOptions = Object.entries(viewingStatusMeta).map(([value, meta]) => ({ value, label: meta.label }));
                populateSelect(viewingsStatusFilter, statusOptions, true, 'Toate statusurile');
            }
        }

        function renderViewingsTable() {
            if (!viewingsTableBody) return;
            viewingsTableBody.innerHTML = '';
            const filtered = clientViewings.filter(view => {
                const venueName = getLocationById(view.locationId)?.name || '';
                const statusMatch = viewingFilters.status === 'all' || view.status === viewingFilters.status;
                const venueMatch = viewingFilters.venue === 'all' || viewingFilters.venue === venueName;
                return statusMatch && venueMatch;
            }).sort((a, b) => a.date - b.date);

            if (!filtered.length) {
                const emptyRow = viewingsTableBody.insertRow();
                const emptyCell = emptyRow.insertCell();
                emptyCell.colSpan = 5;
                emptyCell.innerHTML = '<div class="empty-state">Nu ai vizionări care să corespundă filtrului selectat.</div>';
                renderOverviewViewingsList();
                return;
            }

            filtered.forEach(view => {
                const location = getLocationById(view.locationId);
                const row = viewingsTableBody.insertRow();
                row.dataset.id = view.id; // NOU: Adaugă ID pentru identificare
                row.insertCell().textContent = location?.name || 'Locație necunoscută';
                row.insertCell().textContent = formatDate(view.date);
                row.insertCell().textContent = view.hour;
                const statusCell = row.insertCell();
                statusCell.appendChild(createStatusChip(view.status, viewingStatusMeta));

                const actionsCell = row.insertCell();
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'table-actions';

                if (view.status === 'awaiting_confirmation') {
                    actionsDiv.innerHTML = `
                        <button data-viewing-action="confirm_viewing" data-viewing-id="${view.id}">Confirmă prezența</button>
                        <button data-viewing-action="request_reschedule" data-viewing-id="${view.id}">Solicită reprogramare</button>
                    `;
                } else if (view.status === 'confirmed') {
                    actionsDiv.innerHTML = `
                        <button data-viewing-action="download_materials" data-viewing-id="${view.id}">Descarcă materiale</button>
                        <button data-viewing-action="add_note" data-viewing-id="${view.id}">Adaugă notiță</button>
                    `;
                } else if (view.status === 'completed') {
                    actionsDiv.innerHTML = `
                        <button data-viewing-action="download_materials" data-viewing-id="${view.id}">Vezi rezumatul</button>
                        <button data-viewing-action="add_review" data-viewing-id="${view.id}">Scrie feedback</button>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <button data-viewing-action="accept_reschedule" data-viewing-id="${view.id}">Acceptă noua dată</button>
                        <button data-viewing-action="request_reschedule" data-viewing-id="${view.id}">Propune altă dată</button>
                    `;
                }

                actionsCell.appendChild(actionsDiv);
            });

            renderOverviewViewingsList();
        }

        function handleViewingAction(event) {
            const button = event.target.closest('button[data-viewing-action]');
            if (!button) return;
            const action = button.dataset.viewingAction;
            const viewingId = parseInt(button.dataset.viewingId, 10);
            const viewing = clientViewings.find(v => v.id === viewingId);
            if (!viewing) return;

            switch (action) {
                case 'confirm_viewing':
                    viewing.status = 'confirmed';
                    viewing.lastUpdate = new Date();
                    break;
                case 'request_reschedule':
                    viewing.status = 'reschedule_pending';
                    viewing.lastUpdate = new Date();
                    break;
                case 'accept_reschedule':
                    viewing.status = 'confirmed';
                    viewing.lastUpdate = new Date();
                    break;
                case 'download_materials':
                    viewing.lastUpdate = new Date();
                    break;
                case 'add_note':
                    viewing.lastUpdate = new Date();
                    break;
                case 'add_review':
                    viewing.lastUpdate = new Date();
                    break;
                default:
                    break;
            }

            renderViewingsTable();
            renderOverview();
        }

        function renderMessages() {
            if (!messagesList) return;
            messagesList.innerHTML = '';
            if (!clientMessages.length) {
                messagesList.innerHTML = '<div class="empty-state">Nu ai niciun mesaj.</div>';
                return;
            }

            clientMessages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <strong>${msg.locationName}</strong>
                        <span style="display: block; color: var(--dark-color);">${msg.subject}</span>
                        <span style="color: var(--muted-color);">${msg.lastMessage}</span>
                    </div>
                    <div style="text-align: right;">
                        <span class="panel-meta">${msg.time}</span>
                        ${msg.unread ? '<span class="status-chip" data-status="pending" style="margin-top: 8px;">Nou</span>' : ''}
                    </div>
                `;
                messagesList.appendChild(item);
            });
        }

        function attachEventListeners() {
            requestsStatusFilter?.addEventListener('change', (event) => {
                requestFilters.status = event.target.value;
                renderRequests();
            });
            requestsLocationFilter?.addEventListener('change', (event) => {
                requestFilters.location = event.target.value;
                renderRequests();
            });
            requestsDateFilter?.addEventListener('change', (event) => {
                requestFilters.month = event.target.value;
                renderRequests();
            });
            requestsTableBody?.addEventListener('click', handleRequestAction);

            viewingsVenueFilter?.addEventListener('change', (event) => {
                viewingFilters.venue = event.target.value;
                renderViewingsTable();
            });
            viewingsStatusFilter?.addEventListener('change', (event) => {
                viewingFilters.status = event.target.value;
                renderViewingsTable();
            });
            viewingsTableBody?.addEventListener('click', handleViewingAction);
        }

        populateRequestFilters();
        populateViewingFilters();

        renderOverview();
        renderFavorites();
        renderRequests();
        renderViewingsTable();

        attachEventListeners();
    });
    </script>
</body>
</html>
